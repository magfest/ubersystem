# docker-compose for development of ubersystem
x-uber: &uber
  build: .
  environment:
    - DB_CONNECTION_STRING=postgresql+psycopg://uber_db:uber_db@db:5432/uber_db
    - uber_cherrypy_server_socket_port=80
    - uber_cherrypy_server_socket_host=0.0.0.0
    - uber_cherrypy_server_socket_timeout=1
    - uber_cherrypy_tools_sessions_host=redis
    - uber_cherrypy_tools_sessions_prefix=uber
    - uber_cherrypy_tools_sessions_storage_type=redis
    - uber_loggers_cherrypy_access=DEBUG
    - uber_redis_host=redis
    - uber_secret_broker_url=redis://redis:6379/0
    - uber_secret_broker_prefix=
    - uber_url_root=http://localhost
    - uber_hostname=localhost
    - uber_plugins=["magprime"]
    - uber_dev_box=True
    - SQLALCHEMY_WARN_20=1
  volumes:
    - $PWD:/app/
    - $PWD/../magprime:/app/plugins/magprime


services: 
  web:
    <<: *uber
    ports:
      - 80:80
  celery-beat:
    <<: *uber
    command: ['celery-beat']
  celery-worker:
    <<: *uber
    command: ['celery-worker']
  db:
    image: postgres
    environment:
      - POSTGRES_PASSWORD=uber_db
      - POSTGRES_USER=uber_db
      - POSTGRES_DB=uber_db
  redis:
    image: redis