{% extends "preregistration/preregbase.html" %}
{% block title %}Attractions{% endblock %}
{% import 'attractions_macros.html' as attractions_macros with context %}

{% block content %}

{% include 'attractions/attractions_common.html' %}
{% include 'attractions_badge_num.html' %}

<script>
  $(function() {
    var $modals = $('.modal'),
        $signupModal = $('#signup_modal'),
        $altSignupModal = $('#alt_signup_modal'),
        $doneModal = $('#done_modal'),
        $btnShowSoldout = $('#btn_show_soldout');

    $signupBModal = bootstrap.Modal.getOrCreateInstance($signupModal);
    $altSignupBModal = bootstrap.Modal.getOrCreateInstance($altSignupModal);
    $doneBModal = bootstrap.Modal.getOrCreateInstance($doneModal);

    $('#badge-signup-alert').hide();
    $('#nonbadge-signup-alert').hide();

    $btnShowSoldout.on('click', function(event) {
      var isShowing = $btnShowSoldout.hasClass('btn-secondary');
      $btnShowSoldout.toggleClass('btn-outline-secondary', isShowing);
      $btnShowSoldout.toggleClass('btn-secondary', !isShowing);
      $('body').toggleClass('show-soldout', !isShowing);
    });

    $('#events').on('click', '.event', function(event) {
      event.preventDefault();
      var $event = $(this),
          eventId = $event.data('eventId'),
          isSoldout = $event.hasClass('soldout');

      if ((isSoldout && $event.hasClass('waitlist-soldout')) || $event.hasClass('unavailable')) {
        return;
      }

      $modals.data('eventId', eventId);
      $modals.toggleClass('soldout', isSoldout);
      $('.signup-event-label').html($('#' + eventId + ' .event-label').html());
      $('.signup-event-location').html($('#' + eventId + ' .event-location').html());

      {% if c.AT_THE_CON %}
      $signupBModal.show();
      {% else %}
      if($event.hasClass('badge-num-required')) {
        $signupBModal.show();
      } else {
        $altSignupBModal.show();
      }
      {% endif %}
    });

    var signupForEvent = function(eventId, extraParams, callback) {
      $.ajax({
        method: 'POST',
        url: 'signup_for_event',
        data: $.extend({
          id: eventId,
          csrf_token: csrf_token
        }, extraParams),
        success: function(response, status) {
          if (response && response['event_id']) {
            $modals.toggleClass('soldout', response['is_sold_out']);
            $('#' + eventId).toggleClass('soldout', response['is_sold_out']);
            $('#' + eventId + ' .remaining-slots').text(response['remaining_slots']);
            $('#' + eventId).find('.waitlist-remaining-slots').first().text(response['remaining_waitlist_slots']);
            $('.waitlist-show').toggle(response['on_waitlist']);
            $('.waitlist-hide').toggle(response['on_waitlist'] == false);
            callback(response);
          } else {
            showErrorMessage(response['error'] || 'Unknown error signing up for event.', 'nonbadge-signup-alert');
            callback(false);
          }
        },
        error: function(response, status, statusText) {
          showErrorMessage('Error signing up for event: could not contact server. Please try again.', 'nonbadge-signup-alert');
          callback(false);
        }
      });
    };

    $signupModal.find('.modal-footer .btn.modal-form-switch').on('click', function (event) {
      $signupBModal.hide();
      $altSignupBModal.show();
    });
    $altSignupModal.find('.modal-footer .btn.modal-switch-back').on('click', function (event) {
      $altSignupBModal.hide();
      $signupBModal.show();
    });

    $doneModal.find('.confirm-row .btn-success').on('click', function (event) {
      event.preventDefault();
      var eventId = $doneModal.data('eventId'),
          $badgeNum = $doneModal.find('input[name=badge_num]');

      signupForEvent(eventId, {badge_num: $badgeNum.val()}, function(response) {
        if (response) {
          var $attendee = $doneModal.find('.confirm-row .attendee'),
              $eventLabel = $('#' + eventId + ' .event-label'),
              message = ' successfully signed up for ';
          if (response['remaining_slots'] === response['old_remaining_slots']) {
            message = ' was already signed up for ';
          }
          $("#badge-signup-alert").addClass("alert-info").show().children('span').html($attendee.html() + message + $eventLabel.html());
          hideBadgeNumConfirm($doneModal, true);
        } else {
          hideBadgeNumConfirm($doneModal, false);
        }
      });
    });

    $signupModal.find('.confirm-row .btn-success').on('click', function (event) {
      event.preventDefault();
      var eventId = $signupModal.data('eventId'),
          $badgeNum = $signupModal.find('input[name=badge_num]'),
          badgeNum = $badgeNum.val();

      signupForEvent(eventId, {badge_num: badgeNum}, function(response) {
        if (response) {
          updateGreeting(response['first_name'], response['badge_num'], $doneModal.find('.modal-title'));
          $doneModal.data('attendee', response);
          $signupBModal.hide();
          $doneBModal.show();
        }
      });
    });

    $('#alt_signup_form').on('submit', function(event) {
      event.preventDefault();
      var eventId = $signupModal.data('eventId');
      var params = {
        first_name: $.val('first_name'),
        last_name: $.val('last_name'),
        email: $.val('email'),
        zip_code: $('[name="zip_code"]').val() // keep leading 0, if present
      };
      signupForEvent(eventId, params, function (response) {
        if (response) {
          updateGreeting(response['first_name'], response['badge_num'], $doneModal.find('.modal-title'));
          $doneModal.data('attendee', response);
          $altSignupBModal.hide();
          $doneBModal.show();
        }
      });
    });

    $modals.on('hide.bs.modal', function (event) {
      hideMessageBox();
    });

    $modals.on('hidden.bs.modal', function (event) {
      resetInputs($(this));
    });

    $modals.on('show.bs.modal', function (event) {
      resetBadgeNum($(this));
    });

    $modals.on('shown.bs.modal', function (event) {
      focusBadgeNum($(this));
    });

    $doneModal.on('show.bs.modal', function () {
      var $notificationPref = $doneModal.find('.notification_pref'),
          attendeeData = $doneModal.data('attendee');
      if (attendeeData && attendeeData.hasOwnProperty('notification_pref')) {
        if (attendeeData.hasOwnProperty('custom_notifications') && attendeeData['custom_notifications']) {
          $notificationPref.html(
            'This event does not have automated notifications. You may be sent email notifications with further information'
          )
        } else {
          if (attendeeData['notification_pref'] === {{ Attendee._NOTIFICATION_NONE }}) {
            $notificationPref.html(
              'You will <b>not</b> be notified because you have <b>disabled</b> event notifications');
          } else {
            var icon = '';
            if (attendeeData['notification_pref'] === {{ Attendee._NOTIFICATION_EMAIL }}) {
              icon = '<i class="fa fa-envelope"></i> ';
            } else if (attendeeData['notification_pref'] === {{ Attendee._NOTIFICATION_TEXT }}) {
              icon = '<i class="fa fa-phone"></i> ';
            }
            $notificationPref.html(
              'You will be notified at ' +
              '<span class="text-hilite">' +
              icon + attendeeData['masked_notification_pref'] +
              '</span>');
          }
        }
        $notificationPref.css('display', '');
      } else {
        $notificationPref.html('');
        $notificationPref.css('display', 'none');
      }
    });

    $altSignupModal.on('shown.bs.modal', function () {
      $altSignupModal.find('input[name=first_name]').focus();
    });
  });
</script>

<div id="signup_modal" class="modal fade" tabindex="-1" role="dialog" style="display: none"
    aria-labelledby="signup_modal_title">
  <div class="modal-dialog modal-md" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title">
          <span class="signup-event-label"></span>
        </h4>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-dismissible" role="alert" id="badge-signup-alert"><span></span>{% if bootstrap5 %}<button type="button" class="btn-close" onClick="hideMessageBox()" aria-label="Close"></button>{% else %}<button type="button" class="close" onClick="hideMessageBox()" aria-label="Close"><span aria-hidden="true">&times;</span></button>{% endif %}</div>
        <p>
          <strong>Event Name & Time</strong>: <span class="signup-event-label"></span>
          <br/><strong>Location</strong>: <span class="text-hilite signup-event-location"></span>
          <br/><strong>Check-In</strong>: You {% if feature.attraction.advance_checkin < 0 %}may{% else %}must{% endif %}
          check in {{ feature.attraction.advance_checkin_label }}.
        </p>
        {% if feature.badge_num_required and not c.AT_THE_CON %}
        <div class="h5 text-center">This event requires a badge number to sign up<span class="visible-soldout-inline"> for the waitlist</span>. You'll be able to sign up after you pick up your badge at registration!</div>
        {% else %}
        {{ attractions_macros.badge_num_form('Type your badge # here after picking up your badge!', default_val=attendee.badge_num if attendee and attendee.checked_in else '') }}
        {% endif %}
      </div>
      <div class="modal-footer">
        {% if not feature.badge_num_required %}
          <button class="btn btn-secondary modal-form-switch">Sign up without badge #</button>
        {% endif %}
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Nevermind</button>
      </div>
    </div>
  </div>
</div>

<div id="alt_signup_modal" class="modal fade" tabindex="-1" role="dialog" style="display: none"
    aria-labelledby="alt_signup_modal_title">
  <div class="modal-dialog modal-md" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title">
          <span class="signup-event-label"></span>
        </h4>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="alt_signup_form" method="post" action="sign" role="form">
        <div class="modal-body">
          <div class="alert alert-dismissible" role="alert" id="nonbadge-signup-alert"><span></span>{% if bootstrap5 %}<button type="button" class="btn-close" onClick="hideMessageBox()" aria-label="Close"></button>{% else %}<button type="button" class="close" onClick="hideMessageBox()" aria-label="Close"><span aria-hidden="true">&times;</span></button>{% endif %}</div>
          <p class="hidden-soldout">Enter your personal information below to sign up. You must already be registered to sign up for this event.</p>
          <p class="visible-soldout-block">
            Enter your personal information below to add yourself to the waitlist for this event.
            <br/><br/>Attendees on the waitlist are automatically signed up if someone cancels on a first-come first-serve basis.
          </p>
          <p>
            <strong>Event Name & Time</strong>: <span class="signup-event-label"></span>
            <br/><strong>Location</strong>: <span class="text-hilite signup-event-location"></span>
            <br/><strong>Check-In</strong>: You {% if feature.attraction.advance_checkin < 0 %}may{% else %}must{% endif %}
            check in {{ feature.attraction.advance_checkin_label }}.
          </p>
          <div class="row g-3">
            <div class="col-12 col-sm-6">
              <label class="form-text">First Name</label>
              <input class="form-control info-field"
                  type="text"
                  name="first_name"
                  placeholder="Pat"
                  {% if attendee %}value="{{ attendee.first_name }}"{% endif %}
                  required="required" />
            </div>
            <div class="col-12 col-sm-6">
              <label class="form-text">Last Name</label>
              <input class="form-control info-field"
                  type="text"
                  name="last_name"
                  placeholder="Smith"
                  {% if attendee %}value="{{ attendee.last_name }}"{% endif %}
                  required="required" />
            </div>
          </div>
            <div class="row g-3">
              <div class="col-12 col-sm-6">
                <label class="form-text">Email Address</label>
                <input class="form-control info-field"
                    type="email"
                    name="email"
                    placeholder="email@example.com"
                    {% if attendee %}value="{{ attendee.email }}"{% endif %}
                    required="required" />
              </div>
              <div class="col-12 col-sm-6">
                <label class="form-text">Zip Code</label>
                <input class="form-control info-field"
                    name="zip_code"
                    placeholder="12345"
                    {% if attendee %}value="{{ attendee.zip_code }}"{% endif %}
                    />
              </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-success">
              <i class="fa fa-check"></i>
              <span class="hidden-soldout">Sign Up</span>
              <span class="visible-soldout-inline">Sign up for waitlist</span>
          </button>
          <button type="button" class="btn btn-secondary modal-switch-back">Use badge #</button>
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Nevermind</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div id="done_modal" class="modal fade" tabindex="-1" role="dialog" style="display: none"
    aria-labelledby="done_modal_title">
  <div class="modal-dialog modal-md" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title">
          {{ attractions_macros.attendee_name() }}
        </h4>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>
          <span class="waitlist-hide">Congratulations, you're signed up for</span>
          <span class="waitlist-show">You have been added to the waitlist for</span>
          <span class="text-hilite">{{ feature.attraction.name }} –</span>
          <span class="signup-event-label"></span>!
        </p>
        <p>
          The event will be held in
          <span class="text-hilite signup-event-location"></span>.
          Please check in {{ feature.attraction.advance_checkin_label }}.
        </p>
        <p><span class="notification_pref"></span><span class="waitlist-show"> if you are moved from the waitlist</span>.</p>
        <div class="hidden-soldout">
          <p>Want to go as a group? You can sign up some friends below...</p>
          {{ attractions_macros.badge_num_form('Sign up a friend') }}
        </div>
        <div class="form-group text-center visible-soldout-block">
          <em class="text-danger">This event is <b>SOLD OUT</b>!</em>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">
          Close
        </button>
      </div>
    </div>
  </div>
</div>

<div class="card">
  <div class="card-body">
    {% if attendee %}
      {% include 'confirm_tabs.html' with context %}
    {% endif %}
    {% block body %}
      <a class="btn btn-success btn-back mb-2" href="{{ feature.attraction.slug }}?attendee_id={{ attendee_id }}">
        <i class="fa fa-chevron-left"></i>
        <span class="d-none d-sm-inline">{{ feature.attraction.name }}</span>
        <span class="d-inline d-sm-none">Back</span>
      </a>
      {% if attendee_id %}
        <a class="btn btn-primary pull-right" href="manage?id={{ attendee_id }}">
          <i class="fa fa-chevron-up"></i>
          My Signups
        </a>
      {% endif %}
      <h1 class="text-center">Schedule for {{ feature.name }}</h1>
      <p class="text-center">
        {{ feature.description|sanitize_html|linebreaksbr }}
      </p>
      <hr>
      {%- set available_events_by_day = feature.available_events_by_day -%}
      {%- set is_multi_day = available_events_by_day|length > 1 -%}
      {% if available_events_by_day %}
        <div class="filter-bar text-end">
          <button id="btn_show_soldout" class="btn btn-outline-secondary btn-sm">
            <i class="fa fa-filter"></i>
            Include sold out
          </button>
        </div>
      {% endif %}
      <div id="events">
        {% for day, events in available_events_by_day.items() %}
          {% if not loop.first %}<hr>{% endif %}
          {% if is_multi_day %}
            <div class="pull-right">
              {% for jump_day in available_events_by_day.keys() %}
                {% if jump_day == day %}
                  {{ jump_day[:3] }}
                {% else %}
                  <a href="#{{ jump_day }}">{{ jump_day[:3] }}</a>
                {% endif %}
              {% endfor %}
            </div>
          {% endif %}
          <h2 id="{{ day }}">{{ day }}</h2>
          {% for event in events %}
            <div class="event card border hover-btn{% if event.is_sold_out %} soldout{% endif %}{% if not event.signups_open %} unavailable{% endif %}{% if not event.waitlist_open %} waitlist-soldout{% endif %}{% if feature.badge_num_required %} badge-num-required{% endif %}"
                id="{{ event.id }}"
                data-event-id="{{ event.id }}"
                data-event-name="{{ event.name }}"
                data-event-slots="{{ event.slots }}"
                data-event-location="{{ event.event_location_id }}"
                data-event-start-time="{{ event.start_time_label }}">
              <div class="hover-btn-title">
                <button class="btn btn-success btn-next btn-next-sm pull-right hidden-soldout">
                  <i class="fa fa-check"></i>
                </button>
                <div class="d-flex gap-2 align-items-end">
                  <h3 class="h5 mb-0 text-muted">
                    {{ event.time_span_label }}
                    <small><em>{{ event.duration_label }}</em></small>
                  </h3>
                </div>
              </div>
              <div class="hover-btn-body">
                <p class="event-label" style="display: none">
                  <span class="text-hilite">{{ event.name }}</span> at
                  <span class="text-hilite">{{ event.start_time_label }}</span>{#- strip -#}
                </p>
                <p class="event-location">
                  {{ format_location(event.event_location_id, separator=' ', spacer='', text_class='') }}{#- strip -#}
                </p>
                <div class="d-flex gap-2 justify-content-between mb-0">
                  <span class="visible-soldout-inline text-danger">
                    <b class="slots">SOLD OUT</b> all
                    <em class="slots">{{ event.slots }}</em>
                    slot{{ event.slots|pluralize }} taken
                    {% if event.waitlist_available and event.waitlist_slots %}
                      <br/>
                      <span class="text-body">
                      <em class="slots waitlist-remaining-slots">{{ event.remaining_waitlist_slots }}</em> out of
                      <em class="slots waitlist-total-slots">{{ event.waitlist_slots }}</em> waitlist slot{{ event.waitlist_slots|pluralize }} available
                      </span>
                    {% endif %}
                  </span>
                  {% if event.waitlist_open %}
                  <div class="visible-soldout-inline">
                      <button class="btn btn-secondary">
                        Sign up for waitlist
                      </button>
                  </div>
                  {% endif %}
                  {% if event.signups_open %}
                  <span class="hidden-soldout">
                    <em class="slots remaining-slots">{{ event.remaining_slots }}</em> out of
                    <em class="slots total-slots">{{ event.slots }}</em> slot{{ event.slots|pluralize }} available
                  </span>
                  {% else %}
                  <span class="hidden-soldout">
                    {% if event.signup_time_str %}
                    <em>Signups will open {{ event.signup_time_str }}.</em>
                    {% else %}
                    <em>This event is not open for signups right now.</em>
                    {% endif %}
                  </span>
                  {% endif %}
                </div>
                <p class="visible-signedup-inline"><em class="text-success">You are signed up for this event!</em></p>
              </div>
            </div>
          {% endfor %}
        {% else %}
          <em class="help-block text-center">No events are available for {{ feature.name }}.</em>
        {% endfor %}
      </div>
    {% endblock %}
  </div>
</div>
{% endblock %}
