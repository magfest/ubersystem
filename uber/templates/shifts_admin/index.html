{% extends "base.html" %}{% set admin_area=True %}
{% block title %}Shifts{% endblock %}
{% block page_styles %}
<!--inside page_style -->
{{ "event-calendar-3.10.0/event-calendar.min.css"|serve_static_content }}

<style>
  .ec-button.ec-active, .ec-button:not(:disabled):hover {
      background-color: #1a252f;
      color: #FFFFFF;

  }
  .ec-button , .ec-button:not(:disabled){
      background-color: #3d4752;
      color: #FFFFFF;
  }

  .ec-button:is(:disabled){
      background-color: #6a768f;
      color: #CCCCCC;
      cursor: not-allowed;
  }


  .ec-time-grid {
      .ec-event-time{
         font-size: .85em;
      }
      .ec-event-title{
          font-size: 1em;
      }
  }

  .ec-list {
    .ec-day-head {
        font-size: 1em;
    }
    .ec-event-body {
        flex-direction: row;
        gap: 10px;
        align-items: center; /* vertically center all children */
    }
    .ec-event-tag{
      display: none;
    }
   .ec-event-tag-middle {
       border-radius: 5px;
       width: 10px;
       height: 10px;
   }
   .ec-event-title{
      flex: 1 1 0;

   }
   .ec-event{
       font-size: 1em;
   }
   .ec-event-time {
        width: 8rem;           /* fixed-ish width for timestamp */
        flex-shrink: 0;
   }
  }

  .ec-day.ec-highlight {
    background-color: #f8f9fa !important;
  }
  @media (max-width: 576px) {
    /* Force vertical button group at smaller sizes */
    .ec-button-group {
      flex-direction: column;
      align-items: flex-start;
      justify-content: center;
      position: relative;
      display: inline-flex !important;
      vertical-align: middle;
    }

    .ec-button-group>.ec-button:not(:first-child):not(:last-child) {
    border-radius: 0;
    }
    .ec-button-group>.ec-button:last-child {
      border-top-right-radius: 0;
      border-bottom-left-radius: .25rem !important;
    }
    .ec-button-group>.ec-button:first-child {
      border-bottom-left-radius: 0 !important;
      border-top-right-radius: .25rem !important;
      margin-top: 0px;
    }
    .ec-button-group>.ec-button {
    width: 100%;
    position: relative;
    flex: 1 1 auto;
    margin-left: 0 !important;
    margin-top: -1px;
    }
  }

  .button_row {
    margin-bottom: 20px;
  }

  .button_row div a.setup_button, .button_row div a.teardown_button {
    background-color: #239875;
    background-image: -webkit-linear-gradient(top, #239875 0%, #209572 100%);
    background-image: -o-linear-gradient(top, #239875 0%, #209572 100%);
    background-image: -webkit-gradient(linear, left top, left bottom, from(#239875), to(#209572));
    background-image: linear-gradient(to bottom, #239875 0%, #209572 100%);
  }
</style>
{% endblock %}

{% block content %}

{% include "shifts_admin/main_menu.html" %}
{% if department_id == '' %}
Please select a department above to view its shifts.
{% else %}
<div clas="row">
{% if checklist.relevant %}
    {% if checklist.completed %}
        You've already indicated that what's here and/or whatever shifts STOPS creates are fine.  If that's not the case, please email {{ c.STAFF_EMAIL|email_only|email_to_link }}.
    {% else %}
        {% if department.is_shiftless %}
            This department is on record as not needing any shifts.  Please click the following link to confirm this so we know we don't need to make any shifts.  If this is in error and you'd like shifts for your people, please email {{ c.STAFF_EMAIL|email_only|email_to_link }}.
        {% else %}
            <p>We are able to import shifts from last year. If you want us to import last year's shifts, please email {{ c.STAFF_EMAIL|email_only|email_to_link }}.
                You will still be able to edit those shifts, add slots for additional volunteers, and create new shifts. If you choose to import last year’s shifts, please take the time to look them over and make any needed changes. After the import, you will need to return to this page and approve that they are correct by clicking "I Don’t Need To Do Anything Else Here."</p>

            <p>If you want any shifts to be restricted to certain staffers, <strong>including setup or teardown shifts</strong>, please use the "roles" function when creating shifts. Shifts with specific roles will only be visible to staff that you have assigned to ALL of those roles.</p>

            <p>Otherwise, you can create shifts, and when you are done, click "I Don’t Need To Do Anything Else Here."</p>
        {% endif %}
        <p><a href="#" onClick="$('#checkoff').show(); return false;">I Don't Need To Do Anything Else Here</a></p>
        <form id="checkoff" style="display:none" method="post" action="../dept_checklist/mark_item_complete">
        {{ csrf_token() }}
        <input type="hidden" name="department_id" value="{{ department.id }}" />
        <input type="hidden" name="slug" value="{{ checklist.conf.slug }}" />
        <input type="submit" value="I Confirm I Don't Need To Do Anything Else Here" />
        </form>
    {% endif %}
{% endif %}
</div>

<form method="post" action="shift_schedule_csv" class="d-flex gap-3 mb-3 justify-content-end">
    <div>
        {{ csrf_token() }}
        <input type="hidden" name="department_id" value="{{ department.id }}" />
        <div class="form-text">
        <label for="day">Day</label>
        </div>
        <select class="form-select" id="day" name="day">
        <option selected="true" value="all">All Days</option>
        {% for (day,) in dept_shifts_days %}
        <option value="{{ day.strftime('%Y-%m-%d') }}">{{ day.strftime('%A %-m/%-d') }}</option>
        {% endfor %}
        </select>
    </div>
    <div>
        <div class="form-text">&nbsp;</div>
        <button type="submit" formaction="shift_schedule_csv" class="btn btn-primary">Download Shift Schedule</button>
    </div>
</form>

<div class="row text-center button_row">
    <div class="col-md-4">
        <h3>Setup Shifts ({{ setup|length }})</h3>
        <a class="btn btn-primary setup_button" href="form?id=None&department_id={{ department.id }}&type={{ c.SETUP }}">Add Setup Shift</a>
    </div>
    <div class="col-md-4">
        <h3>Regular Shifts ({{normal|length}})</h3>
        <a class="btn btn-primary" href="form?id=None&department_id={{ department.id }}&type={{ c.REGULAR }}">Add Shift</a>
    </div>
    <div class="col-md-4">
        <h3>Teardown Shifts ({{teardown|length}})</h3>
        <a class="btn btn-primary teardown_button" href="form?id=None&department_id={{ department.id }}&type={{ c.TEARDOWN }}">Add Teardown Shift</a>
    </div>
</div>

<!-- Starting with calendar implementation -->
<div class="row">
    <div class="col-md-12">
        <div id="shift_cal"></div>
    </div>
</div>
<div class="row" style="margin-bottom:50px;"></div>


{% endif %}
{% endblock %}
{% block page_scripts %}
{% if department_id != '' %}
{{ "event-calendar-3.10.0/event-calendar.min.js"|serve_static_content }}

<script type="text/javascript">
   const getDateArray = function(startDate, endDate) {
      const dateArray = [];
      let currentDate = new Date(startDate);
      let end = new Date(endDate);

      while (currentDate <= end) {
        dateArray.push(new Date(currentDate));
        // Use UTC date to prevent problems with time zones and DST
        // in case an event ever spans a time change.
        currentDate.setUTCDate(currentDate.getUTCDate() + 1);
      }
      return dateArray;
    }

    const goToEventForm = function(info){
        let url;
        if(info.event && info.event.id){
            url = "form?id=" + info.event.id;
        } else {
            let startDate = info.date;
            url = "form?id=None&department_id={{ department.id }}&start_time=" +
            startDate.getFullYear() + '-' +
            (startDate.getMonth() + 1).toLocaleString('en-US', {minimumIntegerDigits: 2, useGrouping:false}) + '-' +
            (startDate.getDate()).toLocaleString('en-US', {minimumIntegerDigits: 2, useGrouping:false}) + ' ' +
            (startDate.getHours()).toLocaleString('en-US', {minimumIntegerDigits: 2, useGrouping:false}) + ':' +
            (startDate.getMinutes()).toLocaleString('en-US', {minimumIntegerDigits: 2, useGrouping:false}) + ':' +
            (startDate.getSeconds()).toLocaleString('en-US', {minimumIntegerDigits: 2, useGrouping:false});
        }
        window.location.href = url;
    }

    const setup_duration = {{ (c.EPOCH - c.SETUP_JOB_START).days }};
    const setup_date = '{{ c.SETUP_JOB_START.date() }}';
    const teardown_duration = {{ (c.TEARDOWN_JOB_END - c.ESCHATON).days }};
    const event_duration = {{ (c.ESCHATON - c.EPOCH).days }};
    const total_duration = {{ (c.TEARDOWN_JOB_END - c.SETUP_JOB_START).days }};
    const event_start_date = '{{ c.EPOCH.date() }}';
    const event_end_date = '{{ c.ESCHATON.date() }}';
    const event_dates = getDateArray(event_start_date, event_end_date);

$(document).ready(function() {
    let eventList = new Array();
    {% for job in jobs %}
        eventList.push({
            id: "{{ job.id }}",
            title: "{{ job.name }} ({{ job.shifts | length }}/{{ job.slots }}) x{{ job.weight }}{{ " +15" if job.extra15 else "" }}",
            start: "{{ job.start_time_local|datetime("%Y-%m-%dT%H:%M:%S") }}",
            end: "{{ job.end_time_local|datetime("%Y-%m-%dT%H:%M:%S") }}",
            {% if job.type == c.SETUP or job.type == c.TEARDOWN %}
                {% if job.shifts|length == job.slots %}
                    color: '#186850'
                {% else %}
                    color: '#219170'
                {% endif %}
            {% else %}
                {% if job.shifts|length == job.slots %}
                    color: '#1e3a7b'
                {% else %}
                    color: '#305fc9'
                {% endif %}
            {% endif %}
        });
    {% endfor %}

  let renderEvent = function (info) {
    let eventInfo = info.event;
    if (info.view.type !== 'listWeek') {
        //Don't alter the grid layout. just the list view.
        return;
    }
    let html = `<div class="ec-event-time">${info.timeText}</div>
                <div class="ec-event-tag-middle"style="background-color:${eventInfo.backgroundColor};"></div>
                <div class="ec-event-title">${eventInfo.title}</div>`;
    return {
      html: html,
    }
  }

    const ec = new EventCalendar(document.getElementById('shift_cal'), {
        view: window.matchMedia('(max-width: 576px)').matches ? 'listWeek' : 'timeGridWeek',
        date: event_start_date,
        allDaySlot: false,
        highlightedDates: event_dates,
        headerToolbar: {
            start: 'prev,next timeGridDay',
            center: 'title',
            end: 'setupView,eventView,teardownView,allView listView'
        },
        buttonText: {close: 'Close', listWeek: 'List', timeGridDay: 'Day'},
        noEventsContent: '<em>No shifts exist for the given department and days chosen.</em>',
        customButtons: {
          setupView: {
            text: 'Setup',
            click: function() { showCalView(setup_date, setup_duration, 'setupView'); },
            active: false,
          },
          eventView: {
            text: 'Event',
            click: function() { showCalView(event_start_date, event_duration, 'eventView'); },
            active: true,
          },
          teardownView: {
            text: 'Teardown',
            click: function() { showCalView(event_end_date, teardown_duration + 1, 'teardownView'); },
            active: false,
          },
          allView: {
            text: 'All',
            click: function() { showCalView(setup_date, total_duration + 1, 'allView'); },
            active: false,
          },
          listView: {
            text: 'List',
            click: function() { showCalView(setup_date, undefined, 'listView'); },
            active: false,
          },
        },
        scrollTime: '09:00:00',
        views: {
            timeGridWeek: {
              pointer: true,
              duration: {days: event_duration},
            },
            listWeek: {
              duration: {days: total_duration + 1},
            }
        },
        events: eventList, //if filters become dynamic. event source needed not list.
        dateClick: goToEventForm,
        eventContent: renderEvent,
        eventClick: goToEventForm,
        dayMaxEvents: true,
        nowIndicator: true,
        selectable: false,
        eventStartEditable: false,
        eventDurationEditable: false,
        validRange: {
          start: setup_date,
          end: '{{ c.TEARDOWN_JOB_END.date() }}',
        }
    });


    let showCalView = function (startDay, newDuration, whichButton) {
        let currentViews = ec.getOption('views');
        if(whichButton !== 'listView'){
           currentViews['timeGridWeek']['duration']['days'] = newDuration;
        }
        ec.setOption('views', currentViews);

        setActiveButton(whichButton);
        ec.setOption('date', startDay);
        ec.setOption('view', '');
        let view = whichButton === 'listView' ? 'listWeek' : 'timeGridWeek';
        ec.setOption('view', view);
   }

    let setActiveButton = function(whichButton) {
        let customButtons = ec.getOption('customButtons');
        for (const [key, value] of Object.entries(customButtons)) {
          if (key == whichButton) {
            value['active'] = true;
          } else {
            value['active'] = false;
          }
        }
        ec.setOption('customButtons', customButtons);
   }

});

</script>
{% endif %}
{% endblock %}

