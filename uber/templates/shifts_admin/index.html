{% extends "base.html" %}{% set admin_area=True %}
{% block title %}Shifts{% endblock %}
{% block page_styles %}
<!--inside page_style -->
{{ "event-calendar-3.10.0/event-calendar.min.css"|serve_static_content }}

<style>
  .button_row {
    margin-bottom: 20px;
  }

  .button_row div a.setup_button, .button_row div a.teardown_button {
    background-color: #239875;
    background-image: -webkit-linear-gradient(top, #239875 0%, #209572 100%);
    background-image: -o-linear-gradient(top, #239875 0%, #209572 100%);
    background-image: -webkit-gradient(linear, left top, left bottom, from(#239875), to(#209572));
    background-image: linear-gradient(to bottom, #239875 0%, #209572 100%);
  }
</style>
{% endblock %}

{% block content %}

{% include "shifts_admin/main_menu.html" %}
{% if department_id == '' %}
Please select a department above to view its shifts.
{% else %}
<div clas="row">
{% if checklist.relevant %}
    {% if checklist.completed %}
        You've already indicated that what's here and/or whatever shifts STOPS creates are fine.  If that's not the case, please email {{ c.STAFF_EMAIL|email_only|email_to_link }}.
    {% else %}
        {% if department.is_shiftless %}
            This department is on record as not needing any shifts.  Please click the following link to confirm this so we know we don't need to make any shifts.  If this is in error and you'd like shifts for your people, please email {{ c.STAFF_EMAIL|email_only|email_to_link }}.
        {% else %}
            <p>We are able to import shifts from last year. If you want us to import last year's shifts, please email {{ c.STAFF_EMAIL|email_only|email_to_link }}.
                You will still be able to edit those shifts, add slots for additional volunteers, and create new shifts. If you choose to import last year’s shifts, please take the time to look them over and make any needed changes. After the import, you will need to return to this page and approve that they are correct by clicking "I Don’t Need To Do Anything Else Here."</p>

            <p>If you want any shifts to be restricted to certain staffers, <strong>including setup or teardown shifts</strong>, please use the "roles" function when creating shifts. Shifts with specific roles will only be visible to staff that you have assigned to ALL of those roles.</p>

            <p>Otherwise, you can create shifts, and when you are done, click "I Don’t Need To Do Anything Else Here."</p>
        {% endif %}
        <p><a href="#" onClick="$('#checkoff').show(); return false;">I Don't Need To Do Anything Else Here</a></p>
        <form id="checkoff" style="display:none" method="post" action="../dept_checklist/mark_item_complete">
        {{ csrf_token() }}
        <input type="hidden" name="department_id" value="{{ department.id }}" />
        <input type="hidden" name="slug" value="{{ checklist.conf.slug }}" />
        <input type="submit" value="I Confirm I Don't Need To Do Anything Else Here" />
        </form>
    {% endif %}
{% endif %}
</div>

<form method="post" action="shift_schedule_csv" class="d-flex gap-3 mb-3 justify-content-end">
    <div>
        {{ csrf_token() }}
        <input type="hidden" name="department_id" value="{{ department.id }}" />
        <div class="form-text">
        <label for="day">Day</label>
        </div>
        <select class="form-select" id="day" name="day">
        <option selected="true" value="all">All Days</option>
        {% for (day,) in dept_shifts_days %}
        <option value="{{ day.strftime('%Y-%m-%d') }}">{{ day.strftime('%A %-m/%-d') }}</option>
        {% endfor %}
        </select>
    </div>
    <div>
        <div class="form-text">&nbsp;</div>
        <button type="submit" formaction="shift_schedule_csv" class="btn btn-primary">Download Shift Schedule</button>
    </div>
</form>

<div class="row text-center button_row">
    <div class="col-md-4">
        <h3>Setup Shifts ({{ setup|length }})</h3>
        <a class="btn btn-primary setup_button" href="form?id=None&department_id={{ department.id }}&type={{ c.SETUP }}">Add Setup Shift</a>
    </div>
    <div class="col-md-4">
        <h3>Regular Shifts ({{normal|length}})</h3>
        <a class="btn btn-primary" href="form?id=None&department_id={{ department.id }}&type={{ c.REGULAR }}">Add Shift</a>
    </div>
    <div class="col-md-4">
        <h3>Teardown Shifts ({{teardown|length}})</h3>
        <a class="btn btn-primary teardown_button" href="form?id=None&department_id={{ department.id }}&type={{ c.TEARDOWN }}">Add Teardown Shift</a>
    </div>
</div>

<!-- Starting with calendar implementation -->
<div class="row">
    <div class="col-md-12">
        <div id="shift_cal"></div>
    </div>
</div>
<div class="row" style="margin-bottom:50px;"></div>


{% endif %}
{% endblock %}
{% block page_scripts %}
{% if department_id != '' %}
{{ "event-calendar-3.10.0/event-calendar.min.js"|serve_static_content }}

<script type="text/javascript">
   const getDateArray = function(startDate, endDate) {
      const dateArray = [];
      let currentDate = new Date(startDate);
      let end = new Date(endDate);

      while (currentDate <= end) {
        dateArray.push(new Date(currentDate));
        // Use UTC date to prevent problems with time zones and DST
        // in case an event ever spans a time change.
        currentDate.setUTCDate(currentDate.getUTCDate() + 1);
      }
      return dateArray;
    }

    const goToEventForm = function(info){
        let url;
        if(info.event && info.event.id){
            url = "form?id=" + info.event.id;
        } else {
            let startDate = info.date;
            url = "form?id=None&department_id={{ department.id }}&start_time=" +
            startDate.getFullYear() + '-' +
            (startDate.getMonth() + 1).toLocaleString('en-US', {minimumIntegerDigits: 2, useGrouping:false}) + '-' +
            (startDate.getDate()).toLocaleString('en-US', {minimumIntegerDigits: 2, useGrouping:false}) + ' ' +
            (startDate.getHours()).toLocaleString('en-US', {minimumIntegerDigits: 2, useGrouping:false}) + ':' +
            (startDate.getMinutes()).toLocaleString('en-US', {minimumIntegerDigits: 2, useGrouping:false}) + ':' +
            (startDate.getSeconds()).toLocaleString('en-US', {minimumIntegerDigits: 2, useGrouping:false});
        }
        window.location.href = url;
    }

    const setup_duration = {{ (c.EPOCH - c.SETUP_JOB_START).days }};
    const teardown_duration = {{ (c.TEARDOWN_JOB_END - c.ESCHATON).days }};
    const event_duration = {{ (c.ESCHATON - c.EPOCH).days }};
    const total_duration = {{ (c.TEARDOWN_JOB_END - c.SETUP_JOB_START).days }};
    const event_start_date = '{{ c.EPOCH.date() }}';
    const event_end_date = '{{ c.ESCHATON.date() }}';
    const event_dates = getDateArray(event_start_date, event_end_date);

$(document).ready(function() {
    let eventList = new Array();
    {% for job in jobs %}
        eventList.push({
            id: "{{ job.id }}",
            title: "{{ job.name }} ({{ job.shifts | length }}/{{ job.slots }}) x{{ job.weight }}{{ " +15" if job.extra15 else "" }}",
            start: "{{ job.start_time_local|datetime("%Y-%m-%dT%H:%M:%S") }}",
            end: "{{ job.end_time_local|datetime("%Y-%m-%dT%H:%M:%S") }}",
            {% if job.type == c.SETUP or job.type == c.TEARDOWN %}
                {% if job.shifts|length == job.slots %}
                    color: '#186850'
                {% else %}
                    color: '#219170'
                {% endif %}
            {% else %}
                {% if job.shifts|length == job.slots %}
                    color: '#1e3a7b'
                {% else %}
                    color: '#305fc9'
                {% endif %}
            {% endif %}
        });
    {% endfor %}

  let renderEvent = function (info) {
    let eventInfo = info.event;
    if (eventInfo.display == 'pointer') {
      return;
    }
    let extraClasses = {}
    if (info.view.type == 'listWeek') {
      extraClasses['titleSize'] = 'h5';
    } else {
      extraClasses['deptClass'] = ' class="ms-auto"';
      extraClasses['titleSize'] = 'h6';
      extraClasses['fullHeight'] = ' h-100';
    }

    let button = ''
    let dropDeadlinePassed = {{ c.AFTER_DROP_SHIFTS_DEADLINE|yesno('true,false') }};
    if (eventInfo.extendedProps.assigned == false) {
      button = `<button type="button" class="btn btn-success"
                onClick="signUp('${eventInfo.id}', \`${eventInfo.title}\`, \`${eventInfo.extendedProps.department_name}\`,
                '${moment(eventInfo.start).format("h:mma [on] dddd, MMM Do")}')">Sign Up</button>`
    } else if (dropDeadlinePassed) {
      button = `<span class="tooltip-wrapper" tabindex="0" data-bs-toggle="tooltip" data-placement="top"
      title="You cannot drop your shifts now that the deadline has passed. Please contact us at {{ c.STAFF_EMAIL|email_only }}.">
      <button type="button" class="btn btn-warning" disabled>Drop</button></span>`
    } else {
      button = `<button type="button" class="btn btn-warning"
                onClick="dropShift('${eventInfo.id}', \`${eventInfo.title}\`, \`${eventInfo.extendedProps.department_name}\`,
                '${moment(eventInfo.start).format("h:mma [on] dddd, MMM Do")}')">Drop</button>`;
    }

    let html = `<div class="overflow-hidden d-flex flex-column h-100"><div class="p-1 d-flex flex-wrap">
      <div><time class="ec-event-time text-wrap" datetime="${eventInfo.start}">
      ${info.timeText}&nbsp;</time></div><div${(extraClasses['deptClass'] ?? '')}>
      <em>@ ${eventInfo.extendedProps.department_name}</em></div></div>`;

    html = html + `<div class="d-flex flex-column${(extraClasses['fullHeight'] ?? '')}
      p-1"><h2 class="${extraClasses['titleSize']} mb-0 text-truncate">${eventInfo.title}`;
    if (info.view.type == 'listWeek') {
      html = html + `</h2><p class="mt-1 mb-1 fs-6"><em>${eventInfo.extendedProps.slots} slots filled</em> &nbsp;|&nbsp;
        <em>x${eventInfo.extendedProps.weight} weighting</em></p>
        <p class="fs-5 pt-1 mb-1">${eventInfo.extendedProps.desc}</p>
        <p class="mb-0 mt-2">${button}</p>`;
    } else {
      html = html + ` (${eventInfo.extendedProps.slots}) x${eventInfo.extendedProps.weight}</h2>
        <p class="flex-grow-1 mt-1 text-truncate mb-0">${eventInfo.extendedProps.desc_text}</p>
        <p class="fst-italic mb-1 text-truncate">Click for details & options</p>`;''
    }
    html = html + '</div></div>';
    return {
      html: html,
    }
  }

    const ec = new EventCalendar(document.getElementById('shift_cal'), {
        view: 'timeGridWeek',
        date: event_start_date,
        allDaySlot: false,
        highlightedDates: event_dates,
        headerToolbar: {
            start: 'prev,next timeGridDay',
            center: 'title',
            end: 'setupView,eventView,teardownView,allView listWeek'
        },
        buttonText: {close: 'Close', listWeek: 'List', timeGridDay: 'Day'},
        noEventsContent: '<em>No shifts exist for the given department and days chosen.</em>',
        customButtons: {
          setupView: {
            text: 'Setup',
            click: function() { showWeekCal('{{ c.SETUP_JOB_START.date() }}', setup_duration, 'setupView'); },
            active: false,
          },
          eventView: {
            text: 'Event',
            click: function() { showWeekCal(event_start_date, event_duration, 'eventView'); },
            active: true,
          },
          teardownView: {
            text: 'Teardown',
            click: function() { showWeekCal(event_end_date, teardown_duration + 1, 'teardownView'); },
            active: false,
          },
          allView: {
            text: 'All',
            click: function() { showWeekCal('{{ c.SETUP_JOB_START.date() }}', total_duration + 1, 'allView'); },
            active: false,
          },
        },
        scrollTime: '09:00:00',
        views: {
            timeGridWeek: {
              pointer: true,
              duration: {days: event_duration},
            },
            listWeek: {
              duration: {days: total_duration},
            }
        },
        events: eventList, //if filters become dynamic. event source needed not list.
       // eventContent: renderEvent,
        dateClick: goToEventForm,
        eventClick: goToEventForm,
        dayMaxEvents: true,
        nowIndicator: true,
        selectable: false,
        eventStartEditable: false,
        eventDurationEditable: false,
    });

    let showWeekCal = function (startDay, newDuration, whichButton) {
        let currentViews = ec.getOption('views');
        currentViews['timeGridWeek']['duration']['days'] = newDuration;
        ec.setOption('views', currentViews);

        setActiveButton(whichButton);

        ec.setOption('date', startDay);
        ec.setOption('view', '');
        ec.setOption('view', 'timeGridWeek');
   }

    let setActiveButton = function(whichButton) {
        let customButtons = ec.getOption('customButtons');
        for (const [key, value] of Object.entries(customButtons)) {
          if (key == whichButton) {
            value['active'] = true;
          } else {
            value['active'] = false;
          }
        }
        ec.setOption('customButtons', customButtons);
   }

});

</script>
{% endif %}
{% endblock %}

