{% extends "base.html" %}{% set admin_area=True %}
{% block title %}Hotel Lottery Admin{% endblock %}
{% block content %}

<h2>Hotel Lottery Applications</h2>

<div class="row g-3 mb-3">
  <div class="col-sm">
    <form role="form" method="get" action="index">
    <input type="hidden" name="order" value="{{ order }}" />
    <div class="input-group">
        <input class="focus form-control" id="search_bar" placeholder="Search applications..." type="text" name="search_text" value="{{ search_text }}" />
        <button class="btn btn-outline-secondary" type="submit">
            <i class="fa fa-search"></i>
        </button>
    </div>
    </form>
  </div>
  <div class="col-sm">
    <form role="form" method="get" action="feed" id="feed_search">
      <div class="input-group">
        <input class="form-control" id="feed_search_bar" placeholder="Search application history..." type="text" name="what" value="" />
        <button class="btn btn-outline-secondary" type="submit">
            <i class="fa fa-search"></i>
        </button>
      </div>
    </form>
  </div>
</div>

<div class="d-flex gap-3 mb-3 justify-content-between">
  <div>
    {{ total_count }} total application{{ total_count|pluralize }}
    | {{ complete_count }} completed valid application{{ complete_count|pluralize }}
    <br/>{{ room_count }} requested room{{ room_count|pluralize }}
    | {{ suite_count }} requested suite{{ suite_count|pluralize }}
  </div>
  {% if c.HOTEL_LOTTERY_ROOM_INVENTORY %}
  <div class="text-end">
  <a href="hotel_inventory">View Room/Suite Inventory</a>
  &nbsp;
  <a href="hotel_inventory_zip"><i class="fa fa-download"></i> Assigned Rooms by Date</a>
  &nbsp;
  <a href="assigned_entries"><i class="fa fa-download"></i> Passkey Export</a>
  </div>
  {% else %}
  <div>
    Download <a href="interchange_export"><i class="fa fa-download"></i> Interchange CSV</a>
    OR <a href="interchange_export?staff_lottery=True"><i class="fa fa-download"></i> Staff Lottery CSV</a>
  </div>
  {% endif %}
</div>
{% if c.HOTEL_LOTTERY_ROOM_INVENTORY %}
<form method="post" action="run_lottery" class="d-flex gap-3 mb-3 justify-content-between">
  <div>
    <div class="form-text">&nbsp;</div>
    <button type="submit" formaction="show_awards" class="btn btn-success">Show Awards</button>
    <button type="submit" formaction="publish_booking_links" class="btn btn-primary">Publish Booking URLs</button>
    <button type="submit" formaction="close_waitlist" class="btn btn-danger">Close First Round</button>
  </div>
  <div class="d-flex gap-3 justify-content-end">
    <div>
      <div class="form-text">
        <label for="lottery_group">Lottery Cutoff</label>
        <input type="datetime-local" class="form-control" name="cutoff" id="cutoff" placeholder="N/A" />
      </div>
    </div>
    <div>
      {{ csrf_token() }}
      <div class="form-text">
        <label for="lottery_group">Lottery Group</label>
      </div>
      <select class="form-select" id="lottery_group" name="lottery_group">
        <option selected="true" value="attendee">Attendee</option>
        <option value="staff">Staff</option>
        <option value="both">Both</option>
      </select>
    </div>
    <div>
      <div class="form-text">
        <label for="lottery_type">Lottery Type</label>
      </div>
      <select class="form-select" id="lottery_type" name="lottery_type">
        <option selected="true" value="room">Room</option>
        <option value="suite">Suite</option>
      </select>
    </div>
    <div>
      <div class="form-text">&nbsp;</div>
      <button type="submit" formaction="run_lottery" class="btn btn-primary">Run Lottery</button>
      <button type="submit" formaction="reset_lottery" class="btn btn-danger">Reset Lottery</button>
      <button type="submit" formaction="award_lottery" class="btn btn-warning">Award Winners</button>
    </div>
  </div>
</form>
{% else %}
<form method="post" action="mark_staff_processed">
  {{ csrf_token() }}
  <button type="submit" class="btn btn-primary">Unlock Staff Entries</button>
</form>
{% endif %}

{% if search_results %}
  <div class="card mt-3 mb-3">
    <div class="card-body">
      <a href="index?order={{ order }}&page=1">Click here</a> to view full application list instead of only search results.
    </div>
  </div>
{% endif %}

{% block table %}
{% set page_count = pages[-1] %}
{% if page_count <= 50 %}
    {% set skip_pages = 1 %}
{% else %}
    {% set skip_pages = 5 if page_count <= 500 else 10 %}
{% endif %}

<div class="card card-body">
<ul class="pagination flex-wrap {% if pages == 1 %} pagination-lg{% elif pages|length > 100 %} pagination-sm{% endif %}">
  <li class="page-item{% if page == 1 %} disabled{% endif %}">
    <a class="page-link" href="{% if page == 1 %}#{% else %}index?order={{ order }}&page={{ page - 1 }}&search_text={{ search_text|urlencode }}{% endif %}">Previous</a>
  </li>
{% for pagenum in pages %}
    {% if pagenum == page %}
    <li class="page-item active">
        <a class="page-link" href="#">{{ pagenum }}</a>
    </li>
    {% elif (-10 < (pagenum - page) < 10) or pagenum % skip_pages == 0 or pagenum < 10 %}
    <li class="page-item">
        <a class="page-link" href="index?order={{ order }}&page={{ pagenum }}&search_text={{ search_text|urlencode }}">{{ pagenum }}</a>
    </li>
    {% endif %}
{% endfor %}
  <li class="page-item{% if page == pages|length %} disabled{% endif %}">
    <a class="page-link" href="{% if page == pages|length %}#{% else %}index?order={{ order }}&page={{ pages|length }}&search_text={{ search_text|urlencode }}{% endif %}">Next</a>
  </li>
</ul>
    {% if page %}
      <table class="table table-hover" data-page-size="9999999">
        <thead>
          <tr>
            {% block tableheadings %}
            <th><a href="index?order={{ order.status }}&page={{ page }}&search_text={{ search_text|urlencode }}">Entry Status</a></th>
            <th><a href="index?order={{ order.entry_type }}&page={{ page }}&search_text={{ search_text|urlencode }}">Entry Type</a></th>
            <th><a href="index?order={{ order.confirmation_num }}&page={{ page }}&search_text={{ search_text|urlencode }}">Confirmation #</a></th>
            <th><a href="index?order={{ order.room_group_name }}&page={{ page }}&search_text={{ search_text|urlencode }}">{{ c.HOTEL_LOTTERY_GROUP_TERM }} Name</a></th>
            <th>Attendee</th>
            <th># Group Members</th>
            <th>Admin Notes</th>
            <th><a href="index?order={{ order.is_staff_entry }}&page={{ page }}&search_text={{ search_text|urlencode }}">Staff Entry</a></th>
            {% if c.HOTEL_LOTTERY_ROOM_INVENTORY %}
            <th><a href="index?order={{ order.assigned_hotel }}&page={{ page }}&search_text={{ search_text|urlencode }}">Hotel</a></th>
            <th><a href="index?order={{ order.assigned_room_type }}&page={{ page }}&search_text={{ search_text|urlencode }}">Room Type</a></th>
            <th><a href="index?order={{ order.assigned_suite_type }}&page={{ page }}&search_text={{ search_text|urlencode }}">Suite Type</a></th>
            {% endif %}
            {% endblock tableheadings %}
          </tr>
        </thead>
        <tbody>
          {% for app in applications %}
            <tr{% if app.status not in c.HOTEL_LOTTERY_AWARD_STATUSES and (app.status != c.COMPLETE or not app.attendee or not app.attendee.hotel_lottery_eligible) %} class="bg-light"{% endif %}>
                {% block tablerows scoped %}
                <td>
                  {% if app.status in [c.WITHDRAWN, c.DISQUALIFIED, c.REJECTED] or not app.attendee or not app.attendee.hotel_lottery_eligible %}
                  <span class="text-danger">
                    {% if not app.attendee or not app.attendee.hotel_lottery_eligible %}
                    Invalid Attendee
                    {% else %}
                    {{ app.status_label }}
                    {% endif %}
                  </span>
                  {% else %}{{ app.status_label }}{% endif %}
                </td>
                <td>{{ app.entry_type_label }}</td>
                <td><a href="form?id={{ app.id }}">{{ app.confirmation_num }}</a></td>
                <td>{{ app.room_group_name }}</td>
                <td>{{ app.attendee|form_link if app.attendee else 'Dissociated/No Attendee' }}</td>
                <td>{{ app.valid_group_members|length if app.room_group_name else "" }}</td>
                <td>{{ app.admin_notes }}</td>
                <td>{{ app.is_staff_entry|yesno("Yes,No") }}</td>
                {% if c.HOTEL_LOTTERY_ROOM_INVENTORY %}
                <td>{{ app.assigned_hotel_label['name'] }}</td>
                <td>{{ app.assigned_room_type_label['name'] }}</td>
                <td>{{ app.assigned_suite_type_label['name'] }}</td>
                {% endif %}
              {% endblock tablerows %}
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <div class="lead text-center">
        <em>Use the search box above to filter applications or select a page to browse all applications.</em>
        <br/><br/>You can search by confirmation number, check-in name, or admin notes.
      </div>
    {% endif %}
{% if applications %}
{% set start_app_num = (page * 100) - 100 + 1 %}
<div>Showing {{ start_app_num }} to {{ start_app_num + applications|length - 1 }} out of {{ search_count }} applications</div>
{% endif %}
{% if applications|length > 15 %}
<ul class="pagination flex-wrap {% if pages == 1 %} pagination-lg{% elif pages|length > 100 %} pagination-sm{% endif %}">
  <li class="page-item{% if page == 1 %} disabled{% endif %}">
    <a class="page-link" href="{% if page == 1 %}#{% else %}index?order={{ order }}&page={{ page - 1 }}&search_text={{ search_text|urlencode }}{% endif %}">Previous</a>
  </li>
{% for pagenum in pages %}
    {% if pagenum == page %}
    <li class="page-item active">
        <a class="page-link" href="#">{{ pagenum }}</a>
    </li>
    {% elif (-10 < (pagenum - page) < 10) or pagenum % skip_pages == 0 or pagenum < 10 %}
    <li class="page-item">
        <a class="page-link" href="index?order={{ order }}&page={{ pagenum }}&search_text={{ search_text|urlencode }}">{{ pagenum }}</a>
    </li>
    {% endif %}
{% endfor %}
  <li class="page-item{% if page == pages|length %} disabled{% endif %}">
    <a class="page-link" href="{% if page == pages|length %}#{% else %}index?order={{ order }}&page={{ pages|length }}&search_text={{ search_text|urlencode }}{% endif %}">Next</a>
  </li>
</ul>
{% endif %}
</div>

{% endblock table %}
{% endblock content %}
