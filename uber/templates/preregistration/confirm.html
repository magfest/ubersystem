{% extends "preregistration/preregbase.html" %}
{% set name_ro = not attendee.placeholder %}
{% set assigned_depts_ro = True %}
{% set amount_extra_ro = True if attendee.badge_status == c.DEFERRED_STATUS else False %}
{% set money_fields_ro = True if receipt and receipt.closed_receipt_items else False %}
{% set page_ro = not attendee.is_valid %}
{% import "fields/attendee.html" as attendee_fields with context %}
{% block title %}Confirm Your Details{% endblock %}
{% block backlink %}
{{ super() }}
{% endblock %}
{% block content %}

<script type="text/javascript">
  $(function(){
      {% if attendee.has_personalized_badge %}
          $('.badge-row').show();
      {% endif %}
      {% if attendee.amount_extra and not attendee.amount_unpaid %}
          setTimeout(function () {  // make sure this happens after jQuery.select2
              $.field('amount_extra').find('option').each(function(){
                  if ($(this).val() < {{ attendee.amount_extra }}) {
                      $(this).remove();
                  }
              });
          }, 1);
      {% endif %}
  });
</script>
{{ attendee_fields.amount_extra_js }}

{% include 'prereg_masthead.html' %}
{% if account %}
  {% include 'preregistration/update_account.html' %}
{% endif %}
<div class="panel panel-default">
  <div class="panel-heading">
    Registration Information
  </div>
  <div class="panel-body">
    {% if (c.ATTRACTIONS_ENABLED and attractions) or attendee.promo_code_groups or attendee.art_show_applications or attendee.marketplace_applications or attendee.is_group_leader %}
      {% include 'confirm_tabs.html' with context %}
    {% endif %}
    {% block panel_top %}{% endblock %}

    {% if c.ART_SHOW_ENABLED and not attendee.is_new %}
      {% include 'art_show_common/art_show_agent.html' %}
    {% endif %}

      {% if not attendee.is_valid %}
      <div class="alert alert-danger">
        Your registration is currently marked as <strong>{{ attendee.badge_status_label }}</strong>
        and is not considered a valid registration. Please contact us at {{ c.REGDESK_EMAIL|email_only|email_to_link }} if you have any questions.
      </div>
      {% else %}
        {% if not attendee.placeholder and receipt.current_amount_owed %}
            {% if receipt.pending_total %}
            <div class="alert alert-warning">
              You currently have an outstanding balance of <strong>{{ (receipt.current_amount_owed / 100)|format_currency }}</strong>
              with pending payments of {{ (receipt.pending_total / 100)|format_currency }}.
              Please contact us at {{ c.REGDESK_EMAIL|email_only|email_to_link }} if this issue persists or if you have any questions.
            </div>
            {% else %}
            <div class="alert alert-danger">
              You currently have an outstanding balance of <strong>{{ (receipt.current_amount_owed / 100)|format_currency }}</strong>.
              Please <a href="" data-toggle="modal" data-target="#receiptModal">check your receipt here</a> to pay for your extra items.
            </div>
            {% endif %}
        {% elif attendee.badge_status == c.PENDING_STATUS %}
            <div class="alert alert-warning">
              Your registration has not finished processing, likely because we don't have a verified completed payment. 
              Please contact us at {{ c.REGDESK_EMAIL|email_only|email_to_link }} if this issue persists or if you have any questions.
            </div>
        {% endif %}
        {% if attendee.badge_status == c.DEFERRED_STATUS %}
          <div class="alert alert-warning">
            Your registration has been deferred to {{ c.EVENT_NAME }} {{ c.EVENT_YEAR|int + 1 }}.
            You can {% if attendee.shipping_fee_cost %}update your mailing address
            for your badge and kick-in merch below{% else %}update your information below for next year{% endif %}.
            Please contact us at {{ c.REGDESK_EMAIL|email_only|email_to_link }} if you have any questions.
          </div>
        {% endif %}

        {% if attendee.is_dealer and attendee.is_group_leader %}
          {% if attendee.group.status == c.DECLINED %}
            {% set bg_class = 'danger' %}
          {% elif attendee.group.status == c.APPROVED %}
            {% set bg_class = 'success' %}
          {% elif attendee.group.status == c.WAITLISTED %}
            {% set bg_class = 'warning' %}
          {% else %}
            {% set bg_class = 'info' %}
          {% endif %}
          <div class="alert alert-{{ bg_class }}">
            Your group "<a href="group_members?id={{ attendee.group.id }}" target="_blank">{{ attendee.group.name }}</a>"
            is currently {{ attendee.group.status_label }}.
            {% if c.AFTER_MARKETPLACE_REG_START and c.BEFORE_MARKETPLACE_DEADLINE and attendee.group.status not in [c.APPROVED, c.CANCELLED] %}
            <br/><br/>If you would like, you may instead
            <a href="../marketplace/index?attendee_id={{ attendee.id }}" target="_blank">apply for a table in the Marketplace.</a>{% endif %}
            {% if False and attendee.group.status != c.APPROVED and attendee.paid == c.PAID_BY_GROUP and attendee.calculate_badge_cost() == attendee.new_badge_cost and not money_fields_ro %}
              <br/><br/>You may also pay {{ (attendee.total_cost - attendee_group_discount)|format_currency }} for your individual registration using the button below.
              {% if attendee_group_discount %}<br/>This does not include your current group discount of {{ attendee_group_discount|format_currency(true) }}.{% endif %}
              <br/>{{ stripe_form('buy_own_group_badge', attendee) }}
            {% elif attendee.group.status != c.APPROVED and not attendee.is_not_ready_to_checkin %}
              <p><br/>
              {% if attendee.amount_unpaid %}Once you have paid your outstanding balance of {{ (attendee.amount_unpaid / 100)|format_currency }}, y{% else %}Y{% endif %}ou 
              will be able to check in regardless of whether or not your group is approved.</p>
            {% endif %}
          </div> 
        {% endif %}
      {% endif %}

      {% if money_fields_ro %}
        {% include 'preregistration/upgrade_modal.html' %}
      {% endif %}
      {{ attendee_fields.receipt_modal }}

      <form method="post" action="confirm" id="confirm" class="form-horizontal">
        {{ csrf_token() }}
        <input type="hidden" name="id" value="{{ attendee.id }}" />
        <input type="hidden" name="return_to" value="{{ return_to }}" />
        <input type="hidden" name="undoing_extra" value="{{ undoing_extra }}" />
  
        {% block form_top %}{% endblock %}

      {% if not money_fields_ro %}{{ attendee_fields.badge_buttons }}{% endif %}
      {{ attendee_fields.prereg_intro }}
      {{ attendee_fields.name }}
      {{ attendee_fields.badge_type }}
      {{ attendee_fields.amount_extra(form="confirm") }}
      {{ attendee_fields.badge_printed_name }}
      {{ attendee_fields.shirt_size }}
      {{ attendee_fields.extra_donation() }}
      {{ attendee_fields.staffing }}
      {{ attendee_fields.job_interests }}
      {{ attendee_fields.assigned_depts }}
      {{ attendee_fields.agreed_to_volunteer_agreement }}
      {{ attendee_fields.reviewed_emergency_procedures }}
      {{ attendee_fields.age }}
      {{ attendee_fields.email }}
      {{ attendee_fields.address }}
      {{ attendee_fields.emergency_contact }}
      {{ attendee_fields.cellphone }}
      {{ attendee_fields.promo_code }}
      {{ attendee_fields.interests }}
      {{ attendee_fields.found_how }}
      {{ attendee_fields.comments }}
      {{ attendee_fields.can_spam }}
      {{ attendee_fields.requested_accessibility_services }}
      {{ attendee_fields.requested_hotel_info }}
      {{ attendee_fields.attractions_opt_out }}
      {% if attendee.placeholder %}{{ attendee_fields.pii_consent_checkbox }}{% endif %}

      {# Deprecated form included for backwards compatibility with old plugins #}
      {% include "regform.html" %}

      <div class="form-group">
        <div class="col-sm-9 col-sm-offset-3">
          {% if not page_ro %}
          <button type="submit" class="btn btn-primary" id="updateButton">
            {% if attendee.placeholder %}Register{% else %}Update My Info{% endif %}
          </button>
          {% if attendee.is_transferable %}
            <a href="transfer_badge?id={{ attendee.id }}" class="btn btn-primary">Transfer my Badge</a>
          {% endif %}
          {% include '/preregistration/badge_refund.html' %}
          {% if attendee.can_defer_badge %}
          <a href="defer_badge?id={{ attendee.id }}" class="btn btn-warning">Defer my Badge</a>
          {% endif %}
          {% endif %}
          {% if receipt %}
            <a class="btn btn-info" data-toggle="modal" data-target="#receiptModal">
              <span class="glyphicon glyphicon-list-alt"></span> Receipt
            </a>
          {% endif %}
        </div>
      </div>

      {% if not page_ro and not attendee.is_not_ready_to_checkin and c.USE_CHECKIN_BARCODE %}
        <div class="form-group">
        <label class="col-sm-3 control-label">Check-in Barcode</label>
          <div class="col-sm-6">
            <img src="../registration/qrcode_generator?data={{ attendee.public_id }}" />
          </div>
          <p class="help-block col-sm-9 col-sm-offset-3">
            This can be shown at badge pick-up to help check in. <br/>
            <strong>This barcode <em>does not</em> replace your Photo ID.</strong> <br/>
            You will receive an email with this code before the event.
          </p>
        </div>
      {% endif %}
    </form>

    {% if not page_ro and attendee.can_abandon_badge or attendee.can_self_service_refund_badge %}
      <form method="post" action="abandon_badge" id="abandon_badge">
        <input type="hidden" name="id" value="{{ attendee.id }}"/>
      </form>
    {% endif %}
  </div>
</div>

{% endblock %}
