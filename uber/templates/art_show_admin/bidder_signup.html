{% extends "base.html" %}{% set admin_area=True %}
{% import 'macros.html' as macros with context %}
{% import 'forms/macros.html' as form_macros with context %}
{% block title %}Bidder Management{% endblock %}
{% block content %}

{%- macro bidder_signup_modal(attendee) -%}
<div class="modal fade" id="bidder-modal-{{ attendee.id }}" role="dialog" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title" id="bidder-title-{{ attendee.id }}">Bidder Sign-Up</h4>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form novalidate method="post" action="../art_show_admin/sign_up_bidder" class="bidder-signup-form" id="bidder-signup-{{ attendee.id }}" role="form">
        <div class="modal-body">
          {{ form_macros.form_validation('bidder-signup-' ~ attendee.id, 'validate_bidder_signup') }}
          <input type="hidden" name="attendee_id" value="{{ attendee.id }}" />
          {{ csrf_token() }}

          {% set bidder_signup = forms[attendee.id]['bidder_signup'] %}
          {% set bidder_attendee_info = forms[attendee.id]['bidder_attendee_info'] %}

          {% include 'forms/art_show/admin_bidder_signup.html' with context %}
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary" name="print" value="1">
            Save & Print Form
          </button>

          {% if attendee.art_show_bidder.signed_up %}
          <button type="submit" class="btn btn-success">Save</button>
          {% else %}
          <button type="submit" class="btn btn-success save-bidder-signup" name="complete" value="1">Complete Signup</button>
          {% endif %}
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>
{%- endmacro -%}

{% block adminheader %}
<script>
    $(function() {
        $('#search_bar').select();
    });
</script>
{% endblock adminheader %}
{% block admin_controls %}
<h3>Bidder Management</h3>
<p>
  {% if c.INDEPENDENT_ART_SHOW %}
    Search by badge number or name to finish the bidder signup process. If an artist needs a bidder number, search for them by their name.
  {% else %}
    Search by badge number or badge name below to add a new bidder.
  {% endif %}
</p>
<div class="row justify-content-start align-items-center mb-3">
  <div class="col-sm-6 col-md-4">
    <form role="form" method="get" action="bidder_signup">
      <div class="input-group">
        <input class="focus form-control" id="search_bar" type="text" name="search_text" value="{{ search_text }}" />
        <button class="btn btn-outline-secondary" type="submit">
            <i class="fa fa-search"></i>
        </button>
      </div>
    </form>
  </div>
  {% if c.INDEPENDENT_ART_SHOW %}
  <div class="col col-sm-auto">
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#bidder-modal-new">Add New Bidder</button>
  </div>
  {% endif %}
</div>
<p>
  {% if search_text %}Or, <a href="bidder_signup">view all attendees with bidder numbers</a> to search only existing bidders.{% else %}
  Or, use the search bar in the table below to search existing bidders only.{% endif %}
</p>
{% endblock admin_controls %}
{% block table %}
{% if not search_text %}
<div class="card card-body">
  <table class="table table-hover datatable">
    <thead>
    <tr>
      <th>Bidder Number</th>
      <th>Full Name</th>
      <th>Name on ID</th>
      {% if c.PREASSIGNED_BADGE_TYPES %}<th>Badge Name</th>{% endif %}
      {% if c.NUMBERED_BADGES %}<th>Badge #</th> {% endif %}
      <th>Art Show {{ c.ART_SHOW_APP_TERM|title }}</th>
      <th></th>
    </tr>
    </thead>
    <tbody>
    {% for attendee in attendees %}
    <tr class="attendee-row" data-attendee_id="{{ attendee.id }}"{% if attendee.badge_status == c.INVALID_STATUS %} bgcolor="#FFE4E1"{% endif %}>
      <td id="group_{{ attendee.id }}">
        {% if attendee.art_show_bidder %}
        {{ attendee.art_show_bidder.bidder_num }}
        {% endif %}
      </td>
      <td>
        {{ attendee.full_name }}
      </td>
      <td>
        {{ attendee.legal_name }}
      </td>
      {% if c.PREASSIGNED_BADGE_TYPES %}<td>{{ attendee.badge_printed_name }}</td>{% endif %}
      {% if c.NUMBERED_BADGES %}<td>{{ attendee.badge_num }}</td>{% endif %}
      <td{% if attendee.art_show_application %} data-order="{{ attendee.art_show_application.display_name }}" data-search="{{ attendee.art_show_application.display_name }}"{% endif %}>
        {% if attendee.art_show_application %}
        <a href="form?id={{ app.id }}">{{ attendee.art_show_application.display_name }}</a>
        {% else %}
        N/A
        {% endif %}
      </td>
      <td>
        {% set show_edit_btn = attendee.art_show_bidder and attendee.art_show_bidder.signed_up %}
        <span id="bidder-signup-btn-{{ attendee.id }}"{% if show_edit_btn %} style="display:none;"{% endif %}>
          <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#bidder-modal-{{ attendee.id }}">{% if attendee.art_show_bidder %}Complete {% endif %}Sign Up</button>
        </span>
        <span id="edit-btn-{{ attendee.id }}"{% if not show_edit_btn %} style="display:none;"{% endif %}>
            <span id="bidder-signup-text-{{ attendee.id }}">
              <em>Signed up {{ attendee.art_show_bidder.signed_up_local|datetime("%-I:%M%p")|lower }} {{ attendee.art_show_bidder.signed_up_local|datetime("%a") }}
            </span>
            (<a href="#bidder-modal-{{ attendee.id }}" data-bs-toggle="modal">View/Edit Bidder Info</a>)</em>
          </span>
      </td>
    </tr>
    {% endfor %}
    </tbody>
  </table>
</div>
{% else %}
<ul class="pagination{% if not page %} pagination-lg{% elif pages|length > 100 %} pagination-sm{% endif %}">
  {% for pagenum in pages %}
  {% if pagenum == page %}
  <li class="page-item active">
    <a class="page-link" href="#">{{ pagenum }}</a>
  </li>
  {% else %}
  <li class="page-item">
    <a class="page-link" href="bidder_signup?order={{ order }}&page={{ pagenum }}&search_text={{ search_text|urlencode or '' }}">{{ pagenum }}</a>
    {% endif %}
  </li>
  {% endfor %}
</ul>
<div class="card">
  {% if page %}
  <table class="table table-hover" data-page-size="9999999">
    <thead>
    <tr>
      {% block tableheadings %}
      <th> <a href="bidder_signup?order={{ order.bidder_num }}&page={{ page }}&search_text={{ search_text|urlencode or '' }}">Bidder Number</a> </th>
      <th> <a href="bidder_signup?order={{ order.full_name }}&page={{ page }}&search_text={{ search_text|urlencode or '' }}">Full Name</a> </th>
      <th> <a href="bidder_signup?order={{ order.legal_name }}&page={{ page }}&search_text={{ search_text|urlencode or '' }}">Name on ID</a> </th>
      {% if c.PREASSIGNED_BADGE_TYPES %}<th> <a href="bidder_signup?order={{ order.badge_printed_name }}&page={{ page }}&search_text={{ search_text|urlencode or '' }}">Badge Name</a> </th>{% endif %}
      {% if c.NUMBERED_BADGES %}<th> <a href="bidder_signup?order={{ order.badge_num }}&page={{ page }}&search_text={{ search_text|urlencode or '' }}">Badge #</a> </th> {% endif %}
      <th> <a href="bidder_signup?order={{ order.art_show_attendee_id }}&page={{ page }}&search_text={{ search_text|urlencode or '' }}">Art Show {{ c.ART_SHOW_APP_TERM|title }}</a> </th>
      <th></th>
      {% endblock tableheadings %}
    </tr>
    </thead>
    <tbody>
    {% for attendee in attendees %}
    <tr class="attendee-row" data-attendee_id="{{ attendee.id }}"{% if attendee.badge_status == c.INVALID_STATUS %} bgcolor="#FFE4E1"{% endif %}>
      {% block tablerows scoped %}
      <td id="group_{{ attendee.id }}">
        {% if attendee.art_show_bidder %}
        {{ attendee.art_show_bidder.bidder_num }}
        {% endif %}
      </td>
      <td>
        {{ attendee.full_name }}
      </td>
      <td>
        {{ attendee.legal_name }}
      </td>
      {% if c.PREASSIGNED_BADGE_TYPES %}<td>{{ attendee.badge_printed_name }}</td>{% endif %}
      {% if c.NUMBERED_BADGES %}<td>{{ attendee.badge_num }}</td>{% endif %}
      <td>
        {% if attendee.art_show_application %}
        <a href="form?id={{ app.id }}">{{ attendee.art_show_application.display_name }}</a>
        {% else %}
        N/A
        {% endif %}
      </td>
      <td>
        {% set show_edit_btn = attendee.art_show_bidder and attendee.art_show_bidder.signed_up %}
        <span id="bidder-signup-btn-{{ attendee.id }}"{% if show_edit_btn %} style="display:none;"{% endif %}>
          <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#bidder-modal-{{ attendee.id }}">{% if attendee.art_show_bidder %}Complete {% endif %}Sign Up</button>
        </span>
        <span id="edit-btn-{{ attendee.id }}"{% if not show_edit_btn %} style="display:none;"{% endif %}>
            <span id="bidder-signup-text-{{ attendee.id }}">
              <em>Signed up {{ attendee.art_show_bidder.signed_up_local|datetime("%-I:%M%p")|lower }} {{ attendee.art_show_bidder.signed_up_local|datetime("%a") }}
            </span>
            (<a href="#bidder-modal-{{ attendee.id }}" data-bs-toggle="modal">View/Edit Bidder Info</a>)</em>
          </span>
      </td>
      {% endblock tablerows %}
    </tr>
    {% endfor %}
    </tbody>
  </table>
  {% else %}
  <div class="lead text-center">
    <em>Use the search box above to search for attendees by badge number or badge name.</em>
  </div>
  {% endif %}
</div>
{% if attendees|length > 15 %}
<ul class="pagination{% if not page %} pagination-lg{% elif pages|length > 100 %} pagination-sm{% endif %}">
  {% for pagenum in pages %}
  {% if pagenum == page %}
  <li class="page-item active">
    <a class="page-link" href="#">{{ pagenum }}</a>
  </li>
  {% else %}
  <li class="page-item">
    <a class="page-link" href="bidder_signup?order={{ order }}&page={{ pagenum }}&search_text={{ search_text|urlencode or '' }}">{{ pagenum }}</a>
    {% endif %}
  </li>
  {% endfor %}
</ul>
{% endif %}
{% endif %}
{% endblock table %}
<div id="bidder_modals">
  {% if c.INDEPENDENT_ART_SHOW %}
    {{ bidder_signup_modal(Attendee()) }}
  {% endif %}
  {% for attendee in attendees -%}
    {{ bidder_signup_modal(attendee) }}
  {%- endfor %}
</div>
<script type="text/javascript">
    $(document).ready(function() {
      $('.bidder-signup-form').on('submit', function(event) {
        event.preventDefault();

        if(!serverValidationPassed) {
          return false;
        }
        
        let form = $(this)
        let data = form.serialize();
        let attendee_id = form.find('[name=attendee_id]').val();
        form.find('button[type=submit]').prop('disabled', true);

        if (event.originalEvent !== undefined && event.originalEvent.submitter.name) {
          data = data + "&" + event.originalEvent.submitter.name + "=" + event.originalEvent.submitter.value;
        }

        $.ajax({
            method: 'POST',
            url: form.attr("action"),
            dataType: 'json',
            data: data,
            success: function (json) {
                hideMessageBox('form-validations-bidder-signup-' + attendee_id);
                hideMessageBox();
                if (json.success) {
                  $("#message-alert").addClass("alert-success").show().children('span').html(json.success);
                  $("#bidder-modal-" + attendee_id + " .btn-close").trigger('click');
                  if (json.signed_up_str) {
                    $('#bidder-signup-btn-' + attendee_id).hide();
                    $('#edit-btn-' + attendee_id).show();
                    console.log(json.signed_up_str)
                    $('#bidder-signup-text-' + attendee_id).html('<em>' + json.signed_up_str + '</em>')
                    form.find('.save-bidder-signup').hide();
                  }

                  if (json.print) {
                    window.open('../art_show_admin/print_bidder_form?attendee_id=' + attendee_id,
                                '_blank', 'width=400,height=400,resizeable,scrollbars');
                  }
                } else {
                showErrorMessage(json.error, 'form-validations-bidder-signup-' + attendee_id);
                }
            },
            error: function () {
                showErrorMessage('Unable to connect to server, please try again.', 'form-validations-bidder-signup-' + attendee_id);
                $('#bidder-modal-' + attendee_id).scrollTop(0);
            },
            complete: function () {
              form.find('button[type=submit]').prop('disabled', false);
              serverValidationPassed = false;
            }
        });
      })
    });
</script>
{% endblock content %}
