{% if admin_area %}
  {% set read_access_level = attendee.admin_read_access() or 0 %}
  {% set write_access_level = attendee.admin_write_access() or 0 %}
  {% set page_ro = c.HAS_READ_ACCESS and not c.HAS_ACCESS or write_access_level < 3 or read_access_level and not write_access_level %}

  {% set limited_read = read_access_level == 1 %}
  {% set full_read = read_access_level > 2 %}
  {% set limited_write = write_access_level == 1 %}
  {% set contact_write = write_access_level == 2 %}
{% else %}
{% set full_read = true %}
{% endif %}
{% import 'macros.html' as macros with context %}

{#- Setting some variables to keep the size of conditional clauses smaller. -#}
{%- set is_prereg_confirm_email_enabled = attendee.is_new and c.PREREG_CONFIRM_EMAIL_ENABLED -%}
{%- set group_id = group_id or attendee.group_id -%}

{% set receipt_modal %}
{% if receipt and not admin_area %}
<div class="modal fade" id="receiptModal" tabindex="-1" role="dialog" aria-labelledby="receiptTitle">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="btn-close visually-hidden" data-bs-dismiss="modal" aria-label="Close"></button>
        <h4 class="modal-title" id="receiptTitle">Receipt</h4>
      </div>
      <div class="modal-body">
          {% include 'preregistration/receipt_table.html' %}
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
        {% if receipt.current_amount_owed and not receipt.pending_total %}{{ stripe_form('process_attendee_payment', attendee, receipt_id=receipt.id, stripe_button_id="receipt-stripe-btn") }}{% endif %}
      </div>
    </div>
  </div>
</div>
<script type="text/javascript">
$().ready(function() {
  $('#receipt-stripe-btn').click(function() {
    var modal = bootstrap.Modal.getOrCreateInstance($('#receiptModal'));
    modal.toggle();
  })
});
</script>
{% endif %}
{% endset %}

{% set prereg_intro %}
{{ macros.prereg_wizard(c.PAGE_PATH, is_prereg_dealer) }}
{% if is_prereg_attendee %}
  <div class="form-horizontal">
    {% if c.DEV_BOX %}
      <div class="form-group row">
        <p class="col-sm-9 col-sm-offset-3">
          <strong> You are on a development box.
            {% if not c.ATTENDEE_BADGE_AVAILABLE %}
              Otherwise, you would be automatically redirected to <a href="../static_views/prereg_soldout.html">the "badges sold out" page</a>.
            {% elif c.BEFORE_PREREG_OPEN %}
              Otherwise, you would be automatically redirected to <a href="../static_views/prereg_not_yet_open.html">the "prereg not yet open" page</a>.
            {% elif c.AFTER_PREREG_TAKEDOWN and not c.AT_THE_CON %}
              Otherwise, you would be automatically redirected to <a href="../static_views/prereg_closed.html">the "prereg closed" page</a>.
            {% endif %}
          </strong>
        </p>
      </div>
    {% endif %}

    {% if not is_prereg_dealer and c.DEALER_REG_START and c.DEALER_REG_PUBLIC and c.DEALER_REG_OPEN %}
      <div class="form-group row">
        <p class="col-sm-9 col-sm-offset-3">
          <strong>{{ c.DEALER_TERM|capitalize }}s:</strong>
          {% if c.BEFORE_DEALER_REG_START %}
            {{ c.DEALER_REG_TERM|capitalize }} begins {{ c.DEALER_REG_START|datetime_local }}.
          {% else %}
            Please register <a href="dealer_registration">here</a>.
          {% endif %}
        </p>
      </div>
    {% endif %}
  </div>
{% endif %}
{% endset %}


{% set badge_buttons %}
<script type="text/javascript">
    {#
      Make the PREREG_BADGE_TYPES array available in javascript. Also
      converts the integer values to strings, because that is what we'll
      be comparing them to.
    #}
    var PREREG_BADGE_TYPES = [
        {% for i in c.PREREG_BADGE_TYPES %}'{{ i }}'{% if not loop.last %}, {% endif %}{% endfor %}
    ];
    var PREREG_CHECK_INTERVAL = 15 * 60 * 1000;
    var checkCap = function () {
        $.getJSON('../preregistration/check_prereg', function (check) {
            if (check.force_refresh) {
                location.reload();  // Reload the page to prevent registering after reg is closed
            } else {
                setTimeout(checkCap, PREREG_CHECK_INTERVAL);
            }
        });
    };
    setTimeout(checkCap, PREREG_CHECK_INTERVAL);
    var updateBadgeTypeHiddenInput = function(newBadgeType) {
        if ($.inArray($('input[name="badge_type"]').val(), PREREG_BADGE_TYPES) > -1) {
            $('input[name="badge_type"]').val(newBadgeType);
        }
    };
    var REG_TYPES = {
        row: '#reg-types',
        selector: '.reg-type-selector',
        options: [{
            title: 'Single Attendee',
            description: 'A single registration; you can register more before paying.',
            onClick: function () {
                $('.group_fields').addClass('hide');
                $('.non_group_fields').removeClass('hide');
                updateBadgeTypeHiddenInput('{{ c.ATTENDEE_BADGE }}');
                if ($.field('first_name')) {
                    $('#bold-field-message').insertBefore($.field('first_name').parents('.form-group'));
                }
                showOrHideBadgeTypes();
                togglePrices();
            }
        }]
    };
    {% if c.GROUPS_ENABLED and attendee and attendee.is_new and not group_id %}
        REG_TYPES.options.push({
            title: 'Group Leader',
            {% if c.BEFORE_GROUP_PREREG_TAKEDOWN %}
                description: '<p class="list-group-item-text">Register a group of {{ c.MIN_GROUP_SIZE }} people or more. (Please purchase badges for children 12 and under separate from your group.)</p>',
            {% else %}
                description: '<p class="list-group-item-text">The deadline for Group registration has passed, but you can still register as a regular attendee.</p>',
            {% endif %}
            onClick: function () {
                {% if c.BEFORE_GROUP_PREREG_TAKEDOWN %}
                    $('.group_fields').removeClass('hide');
                    $('.non_group_fields').addClass('hide');
                    updateBadgeTypeHiddenInput('{{ c.PSEUDO_GROUP_BADGE }}');
                    $('#bold-field-message').insertBefore($.field('name').parents('.form-group'));
                    showOrHideBadgeTypes();
                    togglePrices();
                {% else %}
                    setBadge(REG_TYPES, 0);
                    hideMessageBox();
                    showErrorMessage('Group registration has closed.');
                {% endif %}
            }
        });
    {% endif %}
    {% if attendee.is_new and not group_id and c.CHILD_BADGE in c.PREREG_BADGE_TYPES %}
        if (window.REG_TYPES) {
            REG_TYPES.options.push({
                title: '12 and Under: $' + Math.floor({{ c.BADGE_PRICE }} / 2),
                description: '<p class="list-group-item-text">Attendees 12 and younger must be accompanied by an adult with a valid Attendee badge.</p>' +
            '<span class="prereg-price-notice">Price is always half that of the Single Attendee badge price.</span>',
                onClick: function () {
                    $('.group_fields').addClass('hide');
                    $('.non_group_fields').removeClass('hide');
                    if ($.field('first_name')) {
                        $('#bold-field-message').insertBefore($.field('first_name').parents('.form-group'));
                    }
                    $('input[name="badge_type"]').val('{{ c.CHILD_BADGE }}').trigger('change');
                    togglePrices();
                }
            });
        }
    {% endif %}
    var BADGE_TYPES = {
        row: '#badge-types',
        selector: '.badge-type-selector',
        options: [],
    };
    {% if not attendee or attendee.is_new or attendee.badge_type not in c.BADGE_TYPE_PRICES %}
        BADGE_TYPES.options.push({
            title: '{% if is_prereg_attendee or is_prereg_dealer %}Attending{% elif attendee %}{{ attendee.ribbon_and_or_badge }}{% endif %}',
            description: 'Allows access to the convention for its duration.',
            extra: 0,
            badge_type: '{{ c.ATTENDEE_BADGE }}',

            price: {{ badge_cost if badge_cost is defined else c.BADGE_PRICE }},
            {% if c.BADGE_TYPE_PRICES and (attendee.is_new or attendee.badge_type == c.ATTENDEE_BADGE) %}
            onClick: function () {
                {% if money_fields_ro %}
                updateReceiptPreview('badge_type', '{{ c.ATTENDEE_BADGE }}');
                $('#upgrade_badge_type').val('{{ badge_type }}');
                {% else %}
                $('input[name="badge_type"]').val('{{ c.ATTENDEE_BADGE }}').trigger('change');
                {% endif %}
            }
            {% endif %}
        });
    {% endif %}
    {% if c.SHIRT_LEVEL in c.PREREG_DONATION_TIERS and c.SHIRT_AVAILABLE and c.BEFORE_SHIRT_DEADLINE %}
        BADGE_TYPES.options.push({
            title: 'Add a tshirt',
            description: 'Add a {{ c.EVENT_NAME }} themed t-shirt to your registration.',
            extra: {{ c.SHIRT_LEVEL }},
            price: {{ c.BADGE_PRICE }}
        });
    {% endif %}
    {% if c.SUPPORTER_LEVEL in c.PREREG_DONATION_TIERS and c.SUPPORTER_AVAILABLE and c.BEFORE_SUPPORTER_DEADLINE %}
        BADGE_TYPES.options.push({
            title: 'Supporter',
            description: 'Donate extra and get more swag with your registration.',
            extra: {{ c.SUPPORTER_LEVEL }},
            price: {{ c.BADGE_PRICE }}
        });
    {% endif %}
    {% if c.SEASON_LEVEL in c.PREREG_DONATION_TIERS and c.SEASON_AVAILABLE and c.BEFORE_SUPPORTER_DEADLINE %}
        BADGE_TYPES.options.push({
            title: 'Super Supporter',
            description: 'Donate even more and get exclusive swag!',
            extra: {{ c.SEASON_LEVEL }},
            price: {{ c.BADGE_PRICE }}
        });
    {% endif %}

    {% for badge_type in c.BADGE_TYPE_PRICES %}
        {% if badge_type != c.ATTENDEE_BADGE %}
            {% if (not attendee.is_new and attendee.badge_type == badge_type) or ((badge_type != c.SPONSOR_BADGE or c.SPONSOR_BADGE_AVAILABLE) and (badge_type != c.SHINY_BADGE or c.SHINY_BADGE_AVAILABLE)) %}
                BADGE_TYPES.options.push({
                    title: '{{ c.BADGES[badge_type] }}',
                    description: 'Donate extra to get an upgraded badge with perks.',
                    extra: 0,
                    price: {{ c.BADGE_TYPE_PRICES[badge_type] }},
                    badge_type: '{{ badge_type }}',
                    onClick: function () {
                        {% if money_fields_ro %}
                        updateReceiptPreview('badge_type', '{{ badge_type }}');
                        $('#upgrade_badge_type').val('{{ badge_type }}');
                        {% else %}
                        $('input[name="badge_type"]').val('{{ badge_type }}');
                        {% endif %}
                    }
                });
            {% endif %}
        {% endif %}
    {% endfor %}

    BADGE_TYPES.options.sort(function(a, b){
        return (a.price > b.price) ? 1 : (a.price < b.price) ? -1 : 0;
    });

    var togglePrices = function () {
        var showTotalPrices = {% if is_prereg_attendee and not c.PREREG_DONATION_DESCRIPTIONS %}($.val('badge_type') != {{ c.PSEUDO_DEALER_BADGE }}){% else %}false{% endif %};
        $.each(BADGE_TYPES.options, function (i, type) {
            var $price = $(BADGE_TYPES.selector).slice(i, i + 1).find('.price').empty();
            var $price_notice = $(BADGE_TYPES.selector).slice(i, i + 1).find('.price_notice').empty();
            if (showTotalPrices) {
                $price.append(': $').append(type.extra + type.price);
                {% for amount_extra, val in c.PREREG_DONATION_OPTS %}
                    if (type.extra == {{ amount_extra }} && type.extra >= {{ c.SEASON_LEVEL }}) {
                        $price_notice.append('{{ price_notice("Super Supporter registration", c.SUPPORTER_DEADLINE, c.SEASON_LEVEL) }}')
                    } else if (type.extra == {{ amount_extra }} && type.extra >= {{ c.SUPPORTER_LEVEL }}) {
                        $price_notice.append('{{ price_notice("Supporter registration", c.SUPPORTER_DEADLINE, c.SUPPORTER_LEVEL) }}')
                    } else if (type.extra == {{ amount_extra }} && type.extra >= {{ c.SHIRT_LEVEL }}) {
                        $price_notice.append('{{ price_notice("T-Shirt registration", c.SHIRT_DEADLINE, c.SHIRT_LEVEL) }}')
                    } else if (type.extra == {{ amount_extra }} && !type.badge_type ) {
                        $price_notice.append('{{ price_notice("Preregistration", c.PREREG_TAKEDOWN, amount_extra) }}')
                    }
                {% endfor %}
            } else if (type.extra) {
                $price.append(': +$').append(type.extra);
            } else if (type.price) {
                $price.append(': $').append(type.price);
            }
        });
        $.each(REG_TYPES.options, function (i, type) {
            var $price = $(REG_TYPES.selector).slice(i, i + 1).find('.price').empty();
            var $price_notice = $(REG_TYPES.selector).slice(i, i + 1).find('.price_notice').empty();
            if (!showTotalPrices) {
                if (type.title == 'Single Attendee') {
                    $price.append(': $').append({{ c.BADGE_PRICE }});
                    $price_notice.append('{{ price_notice("Preregistration", c.PREREG_TAKEDOWN) }}')
                } else if (type.title == 'Group Leader') {
                    $price.append(': $').append({{ c.GROUP_PRICE }}).append(' per badge');
                    $price_notice.append('{{ price_notice("Group registration", c.GROUP_PREREG_TAKEDOWN, 0, c.GROUP_DISCOUNT) }}')
                }
            }
        });
    };
    var showOrHideBadgeTypes = function () {
        // We use 'pseudo' badge types to create dealers and groups, which is antithetical to using attending-facing
        // badge types for upgrades. We thus want to hide any badge buttons with a unique badge type if the attendee
        // is a dealer or group leader.
        if ($(BADGE_TYPES.row).size()) {
            // Actually, don't show any buttons at all for dealers
            if ($.field('badge_type').val() == '{{ c.PSEUDO_DEALER_BADGE }}') {
              $("#badge-types").hide();
            }
            $.each(BADGE_TYPES.options, function (i, badgeType) {
                if (badgeType.badge_type && badgeType.badge_type != {{ c.ATTENDEE_BADGE }}) {
                    var current_button = $(BADGE_TYPES.selector).slice(i, 1+i);
                    current_button.toggle($.field('badge_type').val() != '{{ c.PSEUDO_GROUP_BADGE }}' && $.field('badge_type').val() != '{{ c.PSEUDO_DEALER_BADGE }}');
                    // If an 'invalid' badge type is currently selected when the reg type is changed, reset to the
                    // first in the list
                    if (!current_button.is(":visible") && current_button.hasClass('active')) {
                        setBadge(BADGE_TYPES, 0);
                    }
                }
            });
        }
    };
    var setBadge = function (types, index) {
        var type = types.options[index];
        $(types.selector)
            .removeClass('active')
            .slice(index, 1 + index)
            .addClass('active');
        (type.onClick || $.noop)();
    };
    var setKickinFromBadge = function (types, index) {
        var type = types.options[index];
        if (type.extra !== undefined && type.extra !== null && $.field('amount_extra')) {
            {% if c.PREREG_DONATION_DESCRIPTIONS %}
                $('input:radio[name=amount_extra][value='+ type.extra +']').prop('checked', true).trigger('change');
            {% else %}
                $.field('amount_extra').val(type.extra).trigger('change');
            {% endif %}
        }
    };
    var makeBadgeMatchExtra = function () {
        if (_(BADGE_TYPES.options).size()) {
            var target = 0;
            $.each(BADGE_TYPES.options, function (i, badgeType) {
                if (badgeType.extra && $.field('amount_extra') && badgeType.extra == $.val('amount_extra')) {
                    target = i;
                } else if (badgeType.badge_type && badgeType.badge_type == $.val('badge_type')) {
                    target = i;
                }
            });
            if (!$(BADGE_TYPES.selector).slice(target, 1 + target).is('.active')) {
              setBadge(BADGE_TYPES, target);
            }
        }
    };
    $(window).on("runJavaScript", function () {
        showOrHideBadgeTypes();
        if ($(BADGE_TYPES.row).size()) {
            $.each([REG_TYPES, BADGE_TYPES], function (i, types) {
                var $row = $('<div class="row"></div>');
                $(types.row).append($('<div class="col-sm-9"></div>').append($row));
                $.each(types.options, function (index, type) {
                    $row.append(
                        $('<div class="col-btn col-sm-4"></div>').append(
                            $('<a class="list-group-item"></a>').addClass(types.selector.substring(1)).click(function () {
                                setBadge(types, index);
                                setKickinFromBadge(types, index);
                            }).append(
                                $('<h4 class="list-group-item-heading"></h4>')
                                    .append(type.title)
                                    .append('<span class="price"></span>')
                            ).append(
                                $('<p class="list-group-item-text"></p>').html(type.description).append('<span class="price_notice"></span>'))));
                });
                $row.append('<div class="clearfix"></div>');
            });
            {% if attendee and attendee.badge_type in [c.ATTENDEE_BADGE, c.PSEUDO_GROUP_BADGE, c.PSEUDO_DEALER_BADGE] %}
                if (window.REG_TYPES && $(REG_TYPES.row).size() ) {
                    setBadge(REG_TYPES, $.field('name') && $.val('name') ? 1 : 0);  // default to attendee or group
                }
            {% endif %}
            {% if not is_prereg_dealer %}makeBadgeMatchExtra(){% endif %};
            if ($.field('amount_extra')) {
                {% if not c.PREREG_DONATION_DESCRIPTIONS or is_prereg_dealer %}
                    $.field('amount_extra').parents('.form-group').hide();
                {% else %}
                    $.field('amount_extra').on('change', makeBadgeMatchExtra);
                {% endif %}
            }
            {% if is_prereg_dealer %}
            if ($.field('extra_donation')) {
              $.field('extra_donation').parents('.form-group').hide();
            }
            {% endif %}
        }
        togglePrices();
    });
</script>
<div class="form-group" id="badge-types">
  <label class="col-sm-3 control-label">Badge Level</label>
</div>
{% endset %}


{% set badge_type %}
{% set read_only = badge_type_ro or page_ro %}
{% if admin_area %}
  <script type="text/javascript">
  isPreassignedBadgeType = function (badge_type) {
        return $.inArray(parseInt(badge_type), {{ c.PREASSIGNED_BADGE_TYPES }}) >= 0;
    };
  toggleBadgeNumField = function () {
    $("input[name='badge_num']").prop("disabled", ($("input[name='no_badge_num']").prop('checked')));
  }
  toggleStaffingField = function () {
    if ($.field('staffing') && $.field('staffing').length) {
      var staffing_badges = ['{{ c.STAFF_BADGE }}', '{{ c.CONTRACTOR_BADGE }}'];
      var changeToStaffing = (staffing_badges.includes($.val("badge_type")) && $.field('staffing').prop('checked', false));
      var changeFromStaffing = (staffing_badges.includes($.val("badge_type")) && $.field('staffing').prop('checked', true));
      if (changeToStaffing || changeFromStaffing) {
        $.field('staffing').click();
      }
    }
  }
  var setBadgeNum = function () {
    var badgeNumOptField = $("input[name='no_badge_num']");
    var currentBadgeNum = {{ attendee.badge_num if attendee.badge_num else 0 }};
    var sameBadgeTypeAndNum = $.val("badge_type") == {{ attendee.badge_type }} && currentBadgeNum;
    var preassignedBadgeType = ($.field("badge_type") && isPreassignedBadgeType($.val("badge_type")));

    if (sameBadgeTypeAndNum) {
      badgeNumOptField.prop('checked', false);
      $("input[name='badge_num']").val("{{ attendee.badge_num }}");
    } else {
      badgeNumOptField.prop('checked', true);
      $("input[name='badge_num']").val("");
    }
    if (preassignedBadgeType) { 
      $("#no_badge_num_text").text("Use next available badge #");
    } else {
      $("#no_badge_num_text").text("Omit badge #");
    }
    toggleBadgeNumField();
  };
  var autoCheckBlank = function () {
    $("input[name='no_badge_num']").prop('checked', $.val('badge_num') == '');
    toggleBadgeNumField();
  }
  $(window).on("runJavaScript", function(){
      setBadgeNum();
  });
</script>
  <div class="form-group">
    <label class="col-sm-3 control-label">Badge Type</label>
    {% call macros.read_only_if(read_only, attendee.badge_type_label) %}
    <div class="col-sm-3">
        <select name="badge_type" class="form-control" onChange="boldOrRegular(); setBadgeNum(); toggleStaffingField();">
          {{ options(c.BADGE_OPTS, attendee.badge_type) }}
        </select>
    </div>
    {% endcall %}
  </div>
  {% if c.NUMBERED_BADGES %}
  <div class="form-group">
    <label class="col-sm-3 control-label">Badge #</label>
    {% call macros.read_only_if(read_only, attendee.badge_num) %}
    <div class="col-sm-3">
    <input type="text" class="form-control" name="badge_num" placeholder="0000" onBlur="autoCheckBlank();" />
    <div class="checkbox"><label class="checkbox"><input type="checkbox" name="no_badge_num" onChange="toggleBadgeNumField();"><span id="no_badge_num_text"></span></label></div>
    </div>
    {% endcall %}
  </div>
  {% endif %}
{% elif c.AT_THE_CON and attendee.is_new %}
  <script>
      window.setTimeout($("#message-alert").hide().removeClass().addClass("alert").children("span").html(""), 10000);
      var maybeWarn = function () {
          var types = {{ c.PRESOLD_ONEDAY_BADGE_TYPES|jsonize }};
          var badgeType = $.val('badge_type');
          if (badgeType in types && types[badgeType] !== moment().format('dddd')) {
              $('#day-warning').text('This badge can ONLY be picked up on ' + types[badgeType] + '.  You cannot pick it up today or any other day than ' + types[badgeType] + '.');
          } else {
              $('#day-warning').empty();
          }
      };
      $(window).on("runJavaScript", function () {
          {% if c.AT_THE_DOOR_BADGE_OPTS %}
              $('#bold-field-message').detach().prependTo('.card-body > .form-horizontal');
              $.field('badge_type').on('change', maybeWarn);
              maybeWarn();
          {% else %}
              $('.card').empty().append('<h1>All badges are sold out!</h1>');
          {% endif %}
      });
  </script>
  <div class="form-group">
    <label class="col-sm-3 control-label">Badge Type</label>
    <div class="col-sm-6">
      <select name="badge_type" class="form-control">
        {{ options(c.AT_THE_DOOR_BADGE_OPTS,attendee.badge_type) }}
      </select>
      <p id="day-warning" class="help-block"></p>
    </div>
  </div>
{% else %}
  <script type="text/javascript">
      {% if not attendee.is_new and not attendee.amount_unpaid %}
          // This removes any badge levels lower than the attendee has purchased already
          if (window.BADGE_TYPES) {
              while (_(BADGE_TYPES.options).size() && BADGE_TYPES.options[0].extra < {{ attendee.amount_extra }}) {
                  BADGE_TYPES.options.splice(0, 1);
              }
              while (_(BADGE_TYPES.options).size() && BADGE_TYPES.options[0].price && BADGE_TYPES.options[0].price < {{ attendee.badge_cost|default(c.BADGE_TYPE_PRICES[attendee.badge_type]|default(c.BADGE_PRICE, boolean=True)) }}) {
                  BADGE_TYPES.options.splice(0, 1);
              }
          }

          // This is the same idea, except it disables the kick-in buttons and then hides them
          $(window).on("runJavaScript", function () {
              if($('input:radio[name=amount_extra]').size()) {
                  $('input:radio[name=amount_extra]').each( function() {
                      if (!isNaN($(this).val()) && Number($(this).val()) < {{ attendee.amount_extra }}) {
                          $(this).prop('disabled', true);
                          $(this).parent().hide();
                      }
                  });
              }
          });
      {% endif %}
      // This auto-selects the Child badge when the user is, e.g., editing their registration before paying
      {% if attendee.badge_type == c.CHILD_BADGE %}
      $(window).on("runJavaScript", function () {
          if (window.REG_TYPES && $(REG_TYPES.row).size()) {
              {% set child_badge_index = 2 if c.GROUPS_ENABLED else 1 %}
              setBadge(REG_TYPES, {{ child_badge_index }});  // default to child badge when appropriate
          }
        });
      {% endif %}
  </script>
  {% if not attendee.is_new %}
    <div class="form-group">
      <label for="badge_type" class="col-sm-3 control-label">Badge Type</label>
      <div class="col-sm-6 form-control-static">
        {{ attendee.badge_type_label }}
        {% if c.MAX_BADGE_TYPE_UPGRADE and attendee.badge_type != c.MAX_BADGE_TYPE_UPGRADE %}{{ macros.upgrade_button('badge-type') }}{% endif %}
      </div>
    </div>
  {% endif %}
  {% if '/registration/' not in c.PAGE_PATH or not attendee.is_new %}
    <input type="hidden" name="badge_type" value="{{ attendee.badge_type }}" />
  {% endif %}
{% endif %}
{% endset %}


{% set name %}
{% set read_only = name_ro or (page_ro and not (limited_write or contact_write)) %}
<script type="text/javascript">
    var sameLegalNameChecked = function () {
        if ($("#same_legal_name").prop('checked')) {
            $.field('legal_name').prop('readonly', true).val('').prop('required', false).valid();
            $("label[for='legal_name']").addClass('optional-field');
        } else if ($("#same_legal_name").length) {
            $.field('legal_name').prop('readonly', false).prop('required', true);
            $("label[for='legal_name']").removeClass('optional-field');
        }
    };
    $(window).on("runJavaScript", function () {
        if ($('#same_legal_name').length) {
            sameLegalNameChecked();
            $('#same_legal_name').change(sameLegalNameChecked);
        }
    })
</script>
<div class="form-group">
  <label for="first_name" class="col-sm-3 control-label">Name</label>
  {% call macros.read_only_if(read_only, attendee.masked_name if limited_read else attendee.full_name) %}
    <div class="col-sm-3">
      <input type="text" name="first_name" id="first_name" value="{{ attendee.first_name }}" class="form-control" placeholder="First Name" autocomplete="fname">
    </div>
    {% if limited_read or limited_write %}
    <div class="col-sm-3 form-control-static">{{ attendee.last_name[0] ~ '.' if limited_read else attendee.last_name }}</div>
    {% else %}
    <div class="col-sm-3">
      <input type="text" name="last_name" id="last_name" value="{{ attendee.last_name }}" class="form-control" placeholder="Last Name" autocomplete="lname">
    </div>
    {% endif %}
  {% endcall %}
</div>

{% if not read_only %}
  <div class="form-group">
    <div class="col-sm-9 col-sm-offset-3">
      <label for="same_legal_name" class="checkbox-label">
        <input type="checkbox" name="same_legal_name" id="same_legal_name" value="1" {% if same_legal_name or attendee.first_name != '' and attendee.legal_name == '' %}checked="checked"{% endif %} />
        The above name is exactly what appears on {{ "my" if not admin_area else "their" }} Legal Photo ID
      </label>
    </div>
  </div>
{% endif %}

{% if full_read or c.SECURITY_ADMIN_ACCESS %}
<div class="form-group">
  <label for="legal_name" class="col-sm-3 control-label">Name as appears on <span class="text-nowrap">Legal Photo ID</span></label>
  {% call macros.read_only_if(read_only, attendee.legal_name) %}
    <div class="col-sm-6">
      <input type="text" name="legal_name" value="{{ attendee.legal_name }}" class="form-control" placeholder="Name exactly as it appears on Photo ID" autocomplete="name" />
      {% if not admin_area %}
        <p class="help-block">
          <span class="popup">{{ macros.popup_link("../static_views/legal_name.html", 'What does "Legal Photo ID" mean?') }}</span>
        </p>
      {% endif %}
    </div>
  {% endcall %}
</div>
{% endif %}
{% endset %}

{% set amount_extra_js %}
<script type="text/javascript">
  var donationChanged = function (formId) {
    if(formId === undefined) {
      formId = '';
    }
    if(formId != '') {
      formId = '#' + formId + ' ';
      {% if money_fields_ro %}
        updateReceiptPreview('amount_extra', $.val('amount_extra'));
      {% endif %}
    }
    {% if (attendee.num_event_shirts_owed or attendee.gets_staff_shirt) and c.STAFF_SHIRT_OPTS == c.SHIRT_OPTS %}
        setVisible(formId + '.shirt-row', true);
    {% else %}
        setVisible(formId + '.shirt-row', $.val('amount_extra') >= {{ c.SHIRT_LEVEL }});
    {% endif %}
    {% if attendee.badge_type in c.PREASSIGNED_BADGE_TYPES %}
        setVisible(formId + '.badge-row', true);
    {% else %}
        setVisible(formId + '.badge-row', $.val('amount_extra') >= {{ c.SUPPORTER_LEVEL }});
    {% endif %}
        setVisible(formId + '.season-row', $.val('amount_extra') >= {{ c.SEASON_LEVEL }});
    $.each($(formId + "input:radio[name='amount_extra']"), function() {
        $(this).parents('.btn').removeClass('active btn-primary');
        $(this).parents('.btn').addClass('btn-outline-secondary');
        if ($(this).val() == $.val('amount_extra')) {
            $(this).parents('.btn').removeClass('btn-outline-secondary');
            $(this).parents('.btn').addClass('active btn-primary');
        }
    });
  };
  $(window).on("runJavaScript", function(){
      if ($.field('amount_extra')) {
          donationChanged();
          if ($.field('amount_extra').is('select')) {
              $.field('amount_extra').select2({
                  formatResult: function (opt) { return opt.text; },
                  formatSelection: function (opt) { return opt.text; },
                  minimumResultsForSearch: 99,
                  escapeMarkup: function (m) { return m; },
                  width: '100%',
              }).select2('val', {{ attendee.amount_extra }});
          }
      }
  });
</script>
{% endset %}

{% macro amount_extra(form="", read_only=(amount_extra_ro or money_fields_ro or page_ro)) %}
{% if c.DONATIONS_ENABLED and not admin_area and not read_only %}
  {% if c.PREREG_DONATION_OPTS and c.PREREG_DONATION_OPTS|length > 1 or attendee.amount_extra or attendee.gets_any_kind_of_shirt %}
    <div class="extra-row form-group">
      <label for="amount_extra" class="col-sm-3 control-label">Pre-order Merch
      </label>
      <div class="col-sm-9">
        {% if c.PREREG_DONATION_DESCRIPTIONS or c.FORMATTED_DONATION_DESCRIPTIONS and not attendee.is_new and attendee.amount_extra %}
          <div data-bs-toggle="buttons" class="btn-group-inline">
            {% for tier in c.FORMATTED_DONATION_DESCRIPTIONS %}
              {% if tier in c.PREREG_DONATION_DESCRIPTIONS or attendee.amount_extra == tier.price %}
                <label class="btn btn-outline-secondary btn-inline">
                  <input type="radio"
                        name="amount_extra"
                        autocomplete="off"
                        value="{{ tier.price }}"
                        onchange="donationChanged('{{ form }}');"
                        {% if attendee.amount_extra == tier.price %}checked{% endif %} />
                  <div class="title">
                    <h4>{{ tier.name }}</h4>
                    {% if tier.price %}
                      <span>
                                      <img
                                              class="tier-icon tier-icon-{{ tier.icon|basename|replace('_', '-')|replace('.png', '') }}"
                                              src="{{ tier.icon }}"
                                              width="50px"
                                              alt="">
                                      + {{ tier.price|format_currency }}
                                    </span>
                    {% endif %}
                  </div>
                  <ul>
                    {% for desc, link in tier.all_descriptions %}
                      {% if link %}
                        <li>
                          <a onClick="window.open('{{ link }}', 'info', 'toolbar=no,height=500,width=375,scrollbars=yes').focus(); return false;" href="{{ link }}">{{ desc }}</a>
                        </li>
                      {% endif %}
                    {% endfor %}
                  </ul>
                </label>
              {% endif %}
            {% endfor %}
          </div>
          {% else %}
            <select name="amount_extra" class="form-control" onchange="donationChanged('{{ form }}');">
              {{ options(c.PREREG_DONATION_OPTS, attendee.amount_extra) }}
            </select>
          {% endif %}
      </div>

      <p class="help-block col-sm-offset-3 col-sm-9">
        Each level includes all lower levels. <br/>
        {% if c.SUPPORTER_DEADLINE and c.SUPPORTER_DEADLINE != c.SHIRT_DEADLINE %}Supporter level and higher {% if c.BEFORE_SUPPORTER_DEADLINE %}are{% else %}were{% endif %} only available until {{ c.SUPPORTER_DEADLINE|datetime_local }}.<br/>{% endif %}
        {% if c.SHIRT_DEADLINE %} {% if c.SUPPORTER_DEADLINE and c.SUPPORTER_DEADLINE != c.SHIRT_DEADLINE %}Shirt level up to Supporter level{% else %}Shirt level and higher{% endif %} {% if c.BEFORE_SHIRT_DEADLINE %}are{% else %}were{% endif %} only available until {{ c.SHIRT_DEADLINE|datetime_local("%b %-d %-I:%M%p %Z") }}{% if c.SHIRT_STOCK %} or while supplies last{% endif %}.<br/>{% endif %}
        {% if not c.SHIRT_DEADLINE and c.SHIRT_STOCK %}Shirt level and higher are only available while supplies last.{% endif %}
      </p>
    </div>
  {% endif %}
  {% if c.DONATION_TIER_OPTS|length > 1 and (not c.PREREG_DONATION_OPTS or c.PREREG_DONATION_OPTS|length <= 1) and c.PAGE_PATH in ['/preregistration/form', '/preregistration/post_form', '/preregistration/register_group_member'] %}
    <div class="extra-row form-group">
      <span class="col-sm-offset-3 col-sm-6"><strong>Pre-ordered merch packages are no longer available</strong>. Please visit our merchandise booth on-site for t-shirts and other swag!</span>
    </div>
  {% endif %}
{% endif %}
{% if c.DONATIONS_ENABLED and (admin_area or read_only) %}
{% set can_upgrade_amount_extra = c.PREREG_DONATION_OPTS and c.PREREG_DONATION_OPTS|length > 1 and attendee.amount_extra < c.PREREG_DONATION_OPTS[-1][0] %}
  <div class="form-group">
    <label class="col-sm-3 control-label">
      Pre-ordered Merch
    </label>
    {% call macros.read_only_if(read_only, attendee.amount_extra_label or "None", post_text='' if not can_upgrade_amount_extra else macros.upgrade_button('amount-extra', text="Upgrade" if attendee.amount_extra else "Add")) %}
    <div class="col-sm-3">
      <select name="amount_extra" class="form-control">
        {{ options(c.DONATION_TIER_OPTS,attendee.amount_extra) }}
      </select>
    </div>
    {% endcall %}
  </div>
{% endif %}
{% endmacro %}


{% set badge_printed_name %}
{% set read_only = badge_printed_name_ro or page_ro %}
{% if c.PRINTED_BADGE_DEADLINE %}
{% if not admin_area %}
  {%- set readonly_badge_name = c.AFTER_PRINTED_BADGE_DEADLINE -%}
  <div class="badge-row extra-row form-group" style="display:none">
    <label for="badge_printed_name" class="col-sm-3 control-label optional-field">Name Printed on Badge</label>
    <div class="col-sm-6">
      <input type="text" class="form-control" name="badge_printed_name" maxlength="20" value="{{ attendee.badge_printed_name }}" {% if readonly_badge_name %}readonly{% endif %} />
    </div>
    <p class="help-block col-sm-offset-3 col-sm-9">Custom names have a maximum of 20 characters.</p>
  </div>

  {% if readonly_badge_name %}
    <div class="badge-row extra-row form-group" style="display:none">
      <p class="help-block col-sm-6 col-sm-offset-3">(custom badges have already been ordered, so you can no longer set this)</p>
    </div>
  {% endif %}
{% else %}
    <div class="form-group badge-row"{% if attendee.badge_type not in c.PREASSIGNED_BADGE_TYPES and attendee.amount_extra < c.SUPPORTER_LEVEL %} style="display:none"{% endif %}>
      <label for="badge_printed_name" class="col-sm-3 control-label">Name Printed on Badge</label>
      {% call macros.read_only_if(read_only, attendee.badge_printed_name) %}
        <div class="col-sm-6">
          <input type="text" class="form-control" name="badge_printed_name" maxlength="20" value="{{ attendee.badge_printed_name }}" />
        </div>
      {% endcall %}
    </div>
  {% endif %}
{% endif %}
{% endset %}


{% set shirt_size %}
{% set read_only = shirt_size_ro or page_ro %}
{% if not admin_area or c.BADGE_TYPE_PRICES or attendee.num_event_shirts_owed or attendee.gets_staff_shirt and c.STAFF_SHIRT_OPTS == c.SHIRT_OPTS %}
  {% set shirt_opts = c.PREREG_SHIRT_OPTS if not admin_area else c.SHIRT_OPTS %}
  {% set warn_on_change = c.PREREG_SHIRTS and not admin_area and attendee.shirt not in c.PREREG_SHIRTS.keys() %}
  {% if not admin_area %}
    <div class="shirt-row extra-row form-group" style="display:none">
  {% else %}
    <div class="form-group">
  {% endif %}
<label for="shirt" class="col-sm-3 control-label">
  {% if attendee.gets_staff_shirt and c.STAFF_SHIRT_OPTS != c.SHIRT_OPTS %}Event {% endif %}Shirt Size
  </label>
  {% call macros.read_only_if(read_only, attendee.shirt_label) %}
<div class="col-sm-{{ "3" if admin_area else "6" }}">
  <select name="shirt" class="form-control">
    {% if warn_on_change %}<option value="{{ attendee.shirt }}">{{ attendee.shirt_label }}</option>{% endif %}
    {% if not admin_area %}<option value="{{ c.NO_SHIRT }}">Select a shirt size</option>{% endif %}
    {{ options(shirt_opts,attendee.shirt) }}
  </select>
</div>
{% if warn_on_change %}
<p class="help-block col-sm-9 col-sm-offset-3">
  <strong>Your shirt size has been reserved for you and is no longer available for pre-order.</strong>
  <br/>If you change your selection now you will not be able to change it back.
</p>
{% endif %}
  {% endcall %}
</div>
{% endif %}
{% if attendee.gets_staff_shirt and c.STAFF_SHIRT_OPTS != c.SHIRT_OPTS %}
<div class="form-group">
<label for="staff_shirt" class="col-sm-3 control-label">Staff Shirt Size</label>
  {% call macros.read_only_if(read_only, attendee.staff_shirt_label) %}
<div class="col-sm-{{ "3" if admin_area else "6" }}">
  <select name="staff_shirt" class="form-control">
    {% if warn_on_change %}<option value="{{ attendee.staff_shirt }}">{{ attendee.staff_shirt_label }}</option>{% endif %}
    {% if not admin_area %}<option value="{{ c.NO_SHIRT }}">Select a shirt size</option>{% endif %}
    {{ options(c.STAFF_SHIRT_OPTS,attendee.staff_shirt) }}
  </select>
</div>
{% if warn_on_change %}
<p class="help-block col-sm-9 col-sm-offset-3">
  <strong>Your shirt size has been reserved for you and is no longer available for pre-order.</strong>
  <br/>If you change your selection now you will not be able to change it back.
</p>
{% endif %}
  {% endcall %}
</div>
{% endif %}
{% endset %}


{% macro extra_donation(read_only=extra_donation_ro or money_fields_ro or page_ro) %}
{% if c.COLLECT_EXTRA_DONATION or c.EXTRA_DONATION_URL %}
{% if money_fields_ro %}
<script type="text/javascript">
  if ($.field('extra_donation')) {
    $.field('extra_donation').blur(function() {
      updateReceiptPreview('extra_donation', $.val('extra_donation'));
    })
  }
</script>
{% endif %}
<div id="extra_donation">
  <div class="form-group">
      <label class="col-sm-3 control-label"><span>Extra Donation</span>
        <br>
        {{ macros.popup_link("../static_views/givingExtra.html", "Learn more") }}
        </label>
  {% if c.COLLECT_EXTRA_DONATION %}
    {% call macros.read_only_if(read_only, attendee.extra_donation, pre_text='$' if attendee.extra_donation else '', post_text=macros.upgrade_button('extra-donation', text="Change" if attendee.extra_donation else "Donate")) %}
      <div class="col-sm-6">
        <div class="input-group">
          <span class="input-group-addon">$</span>
          <input type="text" class="form-control" name="extra_donation" value="{% if attendee.extra_donation %}{{ attendee.extra_donation }}{% endif %}" placeholder="0">
          <span class="input-group-addon">.00</span>
        </div>
      </div>
    {% endcall %}
      {% if not admin_area %}
        <p class="help-block col-sm-9 col-sm-offset-3">
          <strong>This donation <em>is not a kick-in</em> and does not come with merchandise.</strong><br/>
          {{ c.ORGANIZATION_NAME }} is a 501(c)(3) charitable organization, and additional donations may be tax deductible.
          Your employer may also have a charitable donation matching program. Email contact@magfest.org for details.
        </p>
      {% endif %}
{% endif %}
{% if c.EXTRA_DONATION_URL %}
<div class="help-block col-sm-9{% if c.COLLECT_EXTRA_DONATION %} col-sm-offset-3{% endif %}">
If you're interested in kicking in an extra donation, you can{% if c.COLLECT_EXTRA_DONATION %} also{% endif %} do so at any time of year at <a href="{{ c.EXTRA_DONATION_URL }}" target="_blank">{{ c.EXTRA_DONATION_URL }}</a>!
</div>
{% endif %}
</div>
</div>
{% endif %}
{% endmacro %}


{% set staffing %}
{% set read_only = staffing_ro or page_ro %}
<script type="text/javascript">
    var staffingClicked = function () {
        var $staffingCheckbox = $('label[for="staffing"] input[type="checkbox"]');
        var checked = $staffingCheckbox && $staffingCheckbox.is(':visible:checked');
        setVisible('#departments', checked);
        if ($.field('no_cellphone')) {
            setVisible($.field('no_cellphone').parents('.checkbox'), checked);
        }
        {% if not attendee.is_dealer %}
            if ($.field('cellphone')) {
                $.field('cellphone').parents('.form-group').find('label:first').css('font-weight', checked ? 'bold' : 'normal');
            }
        {% endif %}
    };
    {% if admin_area %}
        var toggleStaffingAdminRows = function () {
            setVisible('.staffing-checked', $.field('staffing').prop('checked'));
        };
    {% endif %}
    $(window).on("runJavaScript", function () {
        if ($.field('staffing')) {
            $.field('staffing').on('click', staffingClicked);
        }
        {% if admin_area %}
            if($.field('staffing')) {
                toggleStaffingAdminRows();
                $.field('staffing').on('click', toggleStaffingAdminRows);
            }
        {% endif %}
        staffingClicked();
    });
</script>
<div class="form-group staffing">
  <label for="staffing" class="col-sm-3 optional-field control-label">Want to Volunteer?</label>
  {% call macros.read_only_if(read_only, attendee.staffing|yesno) %}
  <div class="checkbox col-sm-6">
    {% set staffing_readonly = False %}
    {% if not admin_area %}
      {% if attendee.badge_type in [c.CONTRACTOR_BADGE, c.STAFF_BADGE] %}
      {% set staffing_readonly = True %}
      {% set staffing_message = "This checkbox is required for Contractors, Volunteers, and Staff. Please contact Staffing Operations if you wish to change your status." %}
      {% elif attendee.shifts %}
      {% set staffing_readonly = True %}
      {% set staffing_message = "Please " ~ 'see Staffing Operations to change your volunteer status.' if c.AT_THE_CON else 'unassign yourself from shifts before changing your volunteer status.' %}
      {% endif %}
    {% endif %}
    {% set staffing_readonly = not admin_area and (attendee.badge_type in [c.CONTRACTOR_BADGE, c.STAFF_BADGE] or attendee.shifts) %}
    <label for="staffing" {% if staffing_readonly %}title="{{ staffing_message }}"{% endif %}>
      {{ macros.checkbox(attendee, 'staffing', is_readonly=staffing_readonly, clientside_bool=clientside_bool) }}
      {% if admin_area %}
        This attendee is
        {% if attendee.is_new or not attendee.staffing %}
          {{ (c.VOLUNTEER_RIBBON|string in attendee.ribbon_ints|string)|yesno("volunteering,staffing") }}
          </label>
        {% else %}
          </label>
          <a href='../shifts_admin/goto_volunteer_checklist?id={{ attendee.id }}' target="_blank">{{ (c.VOLUNTEER_RIBBON|string in attendee.ribbon_ints|string)|yesno("volunteering,staffing") }}</a>
        {% endif %}
        {% if c.AT_THE_CON and attendee.staffing %}
          ({{ attendee.worked_hours }} out of {{ attendee.weighted_hours }} hours worked)
        {% endif %}
      {% else %}
        {% if attendee.badge_type == c.STAFF_BADGE %} Yes, I want to staff {{ c.EVENT_NAME }}. {% else %} Sign me up! {% endif %}
        </label>
        <span class="popup">{{ macros.popup_link(c.VOLUNTEER_PERKS_URL, "What do I get for volunteering?") }}</span>
      {% endif %}
  </div>
{% endcall %}
</div>
{% endset %}


{% set job_interests %}
{% set read_only = job_interests_ro or page_ro %}
{% if c.PUBLIC_DEPARTMENT_OPTS_WITH_DESC|length > 1 %}
  <div class="form-group staffing" id="departments">
    <label for="requested_depts_ids" class="col-sm-3 control-label">Where do you want to help?</label>
    {% call macros.read_only_if(read_only, attendee.requested_depts_labels) %}
    <div class="col-sm-9">
      <div class="form-control-static">
        {{ macros.checkgroup_opts(
            'requested_depts_ids',
            c.PUBLIC_DEPARTMENT_OPTS_WITH_DESC,
            defaults=attendee.requested_depts_ids,
            include_empty_hidden=True) }}
      </div>
    </div>
  {% endcall %}
  </div>
{% endif %}
{% endset %}


{% set assigned_depts %}
{% set read_only = assigned_depts_ro or page_ro %}
<div class="form-group staffing staffing-checked">
  <label class="col-sm-3 control-label">Assigned Depts</label>
  {% call macros.read_only_if(read_only, attendee.assigned_depts_labels) %}
  <div class="col-sm-9">
    <div class="form-control-static">
      {{ macros.checkgroup_opts(
            'assigned_depts_ids',
            c.ADMIN_DEPARTMENT_OPTS,
            defaults=attendee.assigned_depts_ids,
            include_empty_hidden=True) }}
      {% for id in attendee.assigned_depts_ids %}
        {% if id not in c.ADMIN_DEPARTMENTS %}
        <input type="hidden" name="assigned_depts_ids" value="{{ id }}" />
          + {{ c.DEPARTMENTS[id] }}
        {% endif %}
      {% endfor %}
    </div>
  </div>
{% endcall %}
</div>
{% endset %}


{% set setup_teardown %}
{% set read_only = setup_teardown_ro or page_ro %}
{% endset %}


{% if not c.COLLECT_EXACT_BIRTHDATE or full_read or c.SECURITY_ADMIN_ACCESS %}
{% set age %}
{% set read_only = age_ro or page_ro %}
<script type="text/javascript">
    var AGE_GROUPS = {{ c.AGE_GROUP_CONFIGS|jsonize }};
    var ageGroupSelected = function () {
        {% if not c.COLLECT_EXACT_BIRTHDATE %}
            setVisible('#age_disclaimer', AGE_GROUPS[$.val('age_group')].consent_form);
            if (!$.field('badge_type') || $.val('badge_type') !== {{ c.PSEUDO_DEALER_BADGE }}) {
                setVisible('.staffing', AGE_GROUPS[$.val('age_group')].can_volunteer);
                staffingClicked();
            }
        {% endif %}
    };
    $(ageGroupSelected);
</script>
<div class="form-group">
  {% if c.COLLECT_EXACT_BIRTHDATE %}
  {% set post_text %}
  {% if admin_area and attendee.birthdate %}
    ({{ attendee.age_group_conf.desc }})
  {% endif %}
  {% endset %}

  <label for="birthdate" class="col-sm-3 control-label">Date of Birth</label>
  {% call macros.read_only_if(read_only, attendee.birthdate, post_text=post_text) %}
    <div class="col-sm-6">
      <input type='text' class="form-control date" name="birthdate" value="{{ attendee.birthdate|datetime("%Y-%m-%d") }}"/>
    {% if post_text %}<span class="form-control-static">{{ post_text }}</span>{% endif %}
    </div>
  {% endcall %}

  {% else %}
  <label for="age_group" class="col-sm-3 control-label">Age as of {{ c.EVENT_NAME }}</label>
  {% call macros.read_only_if(read_only, attendee.age_group_label) %}
  <div class="col-sm-6">
    <select name="age_group" class="form-control" onChange="ageGroupSelected()">
      <option value="{{ c.AGE_UNKNOWN }}">Please indicate your age</option>
      {{ options(c.PREREG_AGE_GROUP_OPTS, attendee.age_group) }}
    </select>
  </div>
  {% endcall %}
  {% endif %}
  {% if c.CONSENT_FORM_URL and not admin_area %}
    <p id="age_disclaimer" class="help-block col-sm-9 col-sm-offset-3">
      <em>
        Attendees under 18 <b>MUST</b> bring a signed (and notarized if not accompanied by parent or guardian during badge pickup) parental
        <nobr><a target="_blank" href="{{ c.CONSENT_FORM_URL }}">consent form</a></nobr>.
      </em>
    </p>
  {% endif %}
</div>
{% endset %}
{% endif %}


{% set email %}
{% set read_only = email_ro or (page_ro and not contact_write) %}
<div class="form-group attendee-email">
  <label for="email" class="col-sm-3 control-label">Email Address</label>
  {% if limited_read %}
    <div class="col-sm-6 form-control-static">{{ attendee.masked_email }}</div>
  {% else %}
  {% call macros.read_only_if(read_only, attendee.email) %}
  <div class="col-sm-6">
    <input type="email" name="email" id="email" value="{{ attendee.email }}" class="form-control" placeholder="Email Address">
    {% if is_prereg_dealer %}
    {{ macros.toggle_checkbox(
                selector='input[name=email]',
                label='Use my business email for my personal email.',
                suffix="copy_email",
                mode='.attendee-email .form-control',
                name='copy_email',
                checked=copy_email) }}
    {% endif %}
  </div>
  {% endcall %}
  {% endif %}
</div>

{% if is_prereg_confirm_email_enabled and not admin_area and not read_only %}
  <script type="text/javascript">
      $(window).on("runJavaScript", function () {
          $('form').validate({
              rules: {
                  confirm_email: { equalTo: '#email' }
              },
              messages: {
                  confirm_email: {
                      equalTo: 'Please make sure the email addresses match.'
                  }
              },
              onkeyup: false,
              submitHandler: function(form, event) {
                  // The form is already validated at this point
                  $('form :submit').attr('disabled', true);
                  event.target.submit();
              }
          });
      });
  </script>
  <div class="form-group attendee-email">
    <label for="confirm_email" class="col-sm-3 control-label">Confirm Email</label>
    <div class="col-sm-6">
      <input type="email" name="confirm_email" id="confirm_email" required value="{{ attendee.email }}" class="form-control" placeholder="Confirm your email address">
    </div>
  </div>
{% endif %}
{% endset %}


{% set address %}
{% set read_only = address_ro or page_ro %}
{% if c.COLLECT_FULL_ADDRESS or attendee.shipping_fee_cost %}
{% include "region_opts.html" %}
  <script type="text/javascript">
      var setInternational = function () {
          countryName = $.field('country').val();
          if(countryName == 'United States') {
              $.field('international').prop('checked', false);
          } else if (countryName != '') {
              $.field('international').prop('checked', true);
          }
      };
      $(window).on("runJavaScript", function () {
          $.field('international').parents('.checkbox').hide();
      });
  </script>
  {% if is_prereg_dealer %}
    <div class="form-group">
      <div class="col-sm-9 col-sm-offset-3">
        {%- set attendee_address_suffix = attendee.id|replace("-", "") -%}
        {{ macros.toggle_checkbox(
                    selector='.address_details' + attendee_address_suffix,
                    label='Use my business address for my personal address.',
                    suffix=attendee_address_suffix,
                    required_selector='.address_details' + attendee_address_suffix + ' .form-control',
                    name='copy_address',
                    checked=copy_address) }}
      </div>
    </div>
  {% endif %}
  <div class="row"><label class="col-sm-6 col-sm-offset-3 address_details{{ attendee_address_suffix }}">Mailing Address</label></div>
  {{ macros.address_form(attendee, update_international=True, is_required=(not admin_area)) }}

  <div class="checkbox col-sm-6 col-sm-offset-3">
    {{ macros.checkbox(attendee, 'international', label="I'm coming from outside the US.", is_readonly=read_only, clientside_bool=clientside_bool) }}
  </div>
{% else %}
  <script type="text/javascript">
      var internationalChecked = function () {
          if ($("#international").prop('checked')) {
              $("label[for='zip_code']").addClass('optional-field');
          } else if ($("#international").length) {
              $("label[for='zip_code']").removeClass('optional-field');
          }
      };
      $(window).on("runJavaScript", function () {
          if ($('#international').length) {
              internationalChecked();
              $('#international').change(internationalChecked);
          }
      });
  </script>
  <div class="form-group">
    <label for="zip_code" class="col-sm-3 control-label {% if c.AT_OR_POST_CON %}optional-field{% endif %}">ZIP/Postal Code</label>
  {% call macros.read_only_if(read_only, attendee.zip_code) %}
    <div class="col-sm-6">
      <input type="text" name="zip_code" class="form-control" value="{{ attendee.zip_code }}"{% if not c.AT_OR_POST_CON %} {% endif %}/>
    </div>
  {% endcall %}
    <div class="checkbox col-sm-6 col-sm-offset-3">
      {{ macros.checkbox(attendee, 'international', label="I'm coming from outside the US.", is_readonly=read_only, clientside_bool=clientside_bool) }}
    </div>
  </div>
{% endif %}
{% endset %}


{% set emergency_contact %}
{% if full_read or c.SECURITY_ADMIN_ACCESS or not attendee.ec_name or not attendee.ec_phone %}
{% if attendee.is_new or not admin_area or c.HAS_REG_ADMIN_ACCESS %}
{% set read_only = emergency_contact_ro or page_ro %}
<div class="form-group">
  <label for="ec_name" class="col-sm-3 control-label">Emergency Contact</label>
  {% call macros.read_only_if(read_only, attendee.ec_name) %}
  <div class="col-sm-6">
    <input type="text" name="ec_name" value="{{ attendee.ec_name }}" class="form-control" placeholder="Who we should contact if something happens to you">
  </div>
{% endcall %}
</div>
<div class="form-group">
  <label for="ec_phone" class="col-sm-3 control-label">Emergency Phone</label>
  {% call macros.read_only_if(read_only, attendee.ec_phone) %}
  <div class="col-sm-6">
    <input type="text" name="ec_phone" value="{{ attendee.ec_phone }}" class="form-control" placeholder="A valid phone number for your emergency contact">
  </div>
{% endcall %}
</div>
{% endif %}
{% endif %}
{% endset %}


{% set onsite_contact %}
{% if full_read or c.SECURITY_ADMIN_ACCESS or not attendee.onsite_contact %}
{% if attendee.is_new or not admin_area or c.HAS_REG_ADMIN_ACCESS %}
{% set read_only = onsite_contact_ro or page_ro %}
<div class="form-group">
  <label for="onsite_contact" class="col-sm-3 control-label">On-site Contact</label>
  {% call macros.read_only_if(read_only, attendee.onsite_contact) %}
  <div class="col-sm-6">
    <textarea name="onsite_contact" class="form-control" placeholder="Contact info for a trusted friend or friends who will be at or near the venue during the event." maxlength="500">{{ attendee.onsite_contact }}</textarea>
  </div>
{% endcall %}
    <div class="checkbox col-sm-6 col-sm-offset-3">
      {{ macros.checkbox(attendee, 'no_onsite_contact', label="My emergency contact is also on site with me at the event.", label_class='onsite-ec', is_readonly=read_only, clientside_bool=clientside_bool) }}
    </div>
</div>
<script type="text/javascript">
var noOnsiteClicked = function () {
  if ($.field('no_onsite_contact') && $.field('cellphone')) {
    $.field('onsite_contact').prop('disabled', $.field('no_onsite_contact').prop('checked'));
    if($.field('no_onsite_contact').prop('checked')) {
      $.field('onsite_contact').val('');
    }
  }
};
$(window).on("runJavaScript", function () {
  noOnsiteClicked();
  if ($.field('no_onsite_contact')) {
    $.field('no_onsite_contact').on('click', noOnsiteClicked);
  }
});
  </script>
{% endif %}
{% endif %}
{% endset %}


{% set cellphone %}
{% if not limited_read %}
<script type="text/javascript">
var noCellphoneClicked = function () {
  if ($.field('no_cellphone') && $.field('cellphone')) {
    $.field('cellphone').prop('disabled', $.field('no_cellphone').prop('checked'));
    if($.field('no_cellphone').prop('checked')) {
      $.field('cellphone').val('');
    }
  }
};
$(window).on("runJavaScript", function () {
  noCellphoneClicked();
  if ($.field('no_cellphone')) {
    $.field('no_cellphone').on('click', noCellphoneClicked);
  }
});
  </script>
{% set read_only = cellphone_ro or (page_ro and not contact_write) %}
<div class="form-group">
  <label for="cellphone" class="col-sm-3 control-label">Your Phone Number</label>
{% call macros.read_only_if(read_only, attendee.cellphone) %}
  <div class="col-sm-6">
    <input type="text" name="cellphone" id="cellphone" value="{{ attendee.cellphone }}" class="form-control" {% if attendee.is_dealer %}required{% endif %} placeholder="A phone number we can use to contact you during the event">
    {% if is_prereg_dealer %}
    {{ macros.toggle_checkbox(
                selector='input[name=cellphone]',
                label='Use my business phone number for my cellphone number.',
                required_selector='input[name=cellphone]',
                suffix="copy_phone",
                mode='input[name=cellphone]',
                name='copy_phone',
                checked=copy_phone) }}
    {% endif %}
  </div>
{% endcall %}
  {% if not attendee.is_dealer or admin_area %}
    <div class="checkbox col-sm-6 col-sm-offset-3">
      {{ macros.checkbox(attendee, 'no_cellphone', label="I won't have a phone with me during the event.", label_class='cellphone-excuse', is_readonly=read_only, clientside_bool=clientside_bool) }}
    </div>
  {% endif %}
</div>
{% endif %}
{% endset %}


{% set interests %}
{% set read_only = interests_ro or page_ro %}
{% if c.INTEREST_OPTS %}
  <div class="form-group">
    <label class="col-sm-3 control-label optional-field">What interests you?</label>
    {% call macros.read_only_if(read_only, attendee.interests) %}
    <div class="col-sm-9">
      {{ macros.checkgroup(attendee, 'interests') }}
    </div>
  {% endcall %}
  </div>
{% endif %}
{% endset %}


{% set found_how %}
{% set read_only = found_how_ro or page_ro %}
<div class="form-group">
  <label for="found_how" class="col-sm-3 control-label optional-field">How did you find {{ c.EVENT_NAME }}?</label>
  {% call macros.read_only_if(read_only, attendee.found_how) %}
  <div class="col-sm-6">
    <input type="text" name="found_how" id="found_how" value="{{ attendee.found_how }}" class="form-control" placeholder="How did you find {{ c.EVENT_NAME }}?">
  </div>
{% endcall %}
</div>
{% endset %}


{% set comments %}
{% set read_only = comments_ro or page_ro %}
<div class="form-group">
  <label for="comments" class="col-sm-3 control-label optional-field">Comments</label>
  {% call macros.read_only_if(read_only, attendee.comments) %}
  <div class="col-sm-6">
    <input type="textarea" name="comments" id="comments" value="{{ attendee.comments }}" class="form-control" placeholder="Comments">
  </div>
{% endcall %}
</div>
{% endset %}


{% set promo_code %}
{% set read_only = promo_code_ro or page_ro %}
{% if not read_only and c.HAS_REG_ADMIN_ACCESS %}
  <script type="text/javascript">
      var removePromoCode = function(event) {
          event.preventDefault();
          bootbox.confirm({
              backdrop: true,
              title: 'Remove "{{ attendee.promo_code_code }}" from "{{ attendee.full_name }}"?',
              message: 'This will remove the promo code\'s discount from the attendee and ' +
              'set them to unpaid. They will be asked to pay the difference to complete their registration.',
              buttons: {
                  confirm: { label: 'Remove Promo Code', className: 'btn-danger' },
                  cancel: { label: 'Nevermind', className: 'btn-outline-secondary' }
              },
              callback: function(result) {
                  if (result) {
                      window.location.href = '../reg_admin/remove_promo_code?id={{ attendee.id }}'
                  }
              }
          });
      };
  </script>
{% endif %}

{% if c.BADGE_PROMO_CODES_ENABLED and not group_id and (attendee.is_unpaid or attendee.promo_code_code or admin_area) %}
  <div class="non_group_fields form-group">
    <label for="promo_code" class="col-sm-3 control-label optional-field">Promo {% if c.GROUPS_ENABLED %}or Group {% endif %}Code</label>
    <div class="col-sm-6">
      {% if not attendee.active_receipt and not read_only %}
        <input type="textarea" name="promo_code" value="{{ attendee.promo_code_code or promo_code_code }}" class="form-control" placeholder="Promo Code">
      {% else %}
        <input type="hidden" name="promo_code" value="{{ attendee.promo_code_code }}">
        <p class="form-control-static">
          {{ attendee.promo_code_code|default("N/A") }}
          {% if not read_only and c.HAS_REG_ADMIN_ACCESS and attendee.promo_code_code %}
            [<a href="" id="remove_promo_code" onClick="removePromoCode(event)">Remove</a>]
          {% endif %}
        </p>
      {% endif %}
    </div>
  </div>
{% endif %}
{% endset %}


{% set requested_accessibility_services %}
{% set read_only = requested_accessibility_services_ro or page_ro %}
{% if c.ACCESSIBILITY_SERVICES_ENABLED %}
  <div class="form-group">
    <label for="requested_accessibility_services_option" class="col-sm-3 control-label optional-field">Accessibility Services</label>
    {% if c.HAS_OTHER_REPORTS_ACCESS or not admin_area %}
      <div class="checkbox col-sm-9">
        {{ macros.checkbox(attendee, 'requested_accessibility_services', label='I would like to be contacted by the ' ~ c.EVENT_NAME ~ ' Accessibility Services department prior to the event and I understand my contact information will be shared with Accessibility Services for this purpose.', is_readonly=read_only, clientside_bool=clientside_bool) }}
      </div>
    {% else %}
      <div class="form-control-static">
        <input type="hidden" name="requested_accessibility_services" value="{{ attendee.requested_accessibility_services|yesno("1,0") }}" />
      </div>
    {% endif %}
  </div>
{% endif %}
{% endset %}


{% set can_spam %}
{% set read_only = can_spam_ro or page_ro %}
<div class="form-group">
  <label for="email_option" class="col-sm-3 control-label optional-field">Keep Me Updated</label>
  <div class="checkbox col-sm-9">
    {{ macros.checkbox(attendee, 'can_spam', label='Please send me emails relating to ' ~ organization_with_event_name() ~ ' in future years.', is_readonly=read_only, clientside_bool=clientside_bool) }}<br/>
    {% if not admin_area %}<span class="popup">{{ macros.popup_link("../static_views/privacy.html", "View Our Spam Policy") }}</span>{% endif %}
  </div>
</div>
{% endset %}


{% set pii_consent_checkbox %}
{% set read_only = pii_consent_ro or page_ro %}
<div class="form-group">
  <label class="col-sm-3 control-label">Privacy Policy</label>
{% call macros.read_only_if(read_only, attendee.pii_consent|yesno) %}
  <div class="checkbox col-sm-9">
    <label for="pii_consent" class="checkbox-label">
      <input type="checkbox" name="pii_consent" id="pii_consent" value="1" required {% if pii_consent %}checked{% endif %} />
      <strong>Yes</strong>, I understand and agree that {{ c.ORGANIZATION_NAME }} will store the personal information I provided above for the limited purposes of contacting me about my 
      registration{% if c.HOTELS_ENABLED %}, hotel accommodations{% endif %}{% if c.DONATIONS_ENABLED %}, kick-in packages{% endif %}{% if c.ACCESSIBILITY_SERVICES_ENABLED %}, accessibility needs{% endif %}{% if c.HOTELS_ENABLED or c.DONATIONS_ENABLED or c.ACCESSIBILITY_SERVICES_ENABLED %},{% endif %} or volunteer opportunities selected at sign-up.
    </label>
    {% if not admin_area and c.PRIVACY_POLICY_URL %}
        <p class="help-block">
          For more information please check out our <a href="{{ c.PRIVACY_POLICY_URL }}" target="_blank">Privacy Policy</a>.
        </p>
      {% endif %}
  </div>
{% endcall %}
</div>
{% endset %}


{% set created %}
{# Always read-only #}
{% if attendee.created and attendee.created.when|full_datetime_local != attendee.registered|full_datetime_local and attendee.created.who == "non-admin" %}
  <div class="form-group">
    <label class="col-sm-3 control-label">Created</label>
    <div class="col-sm-6 form-control-static">
      {{ attendee.created.when|full_datetime_local }} by {{ attendee.created.who }}
    </div>
  </div>
{% endif %}
{% endset %}


{% set signed_up %}
{# Always read-only #}
<div class="form-group">
  <label class="col-sm-3 control-label">Signed Up</label>
  <div class="col-sm-6 form-control-static">
    {{ attendee.registered_local|full_datetime_local }}
  </div>
</div>
{% endset %}


{% set last_updated %}
{# Always read-only #}
{% if attendee.last_updated %}
  <div class="form-group">
    <label class="col-sm-3 control-label">Last Updated</label>
    <div class="col-sm-9 form-control-static">
      {{ attendee.last_updated.when|full_datetime_local }} by {{ attendee.last_updated.who }}
    </div>
  </div>
{% endif %}
{% endset %}


{% set checked_in %}
{# Always read-only #}
{% if c.AT_THE_CON %}
  <div class="form-group">
    <label class="col-sm-3 control-label">Checked In</label>
    <div class="col-sm-6 form-control-static">
      {% if attendee.checked_in %}
        Checked in at {{ attendee.checked_in_local|datetime("%B %-d, %Y, %-I:%M %p") }}
      {% else %}
        Has not checked in yet
      {% endif %}
    </div>
  </div>
{% endif %}
{% endset %}


{% set attendee_account %}
{% if c.ATTENDEE_ACCOUNTS_ENABLED %}
<div class="form-group">
  <label class="col-sm-3 control-label">Account Email{{ attendee.managers|length|pluralize }}</label>
  <div class="col-sm-6 form-control-static">
    {% for manager in attendee.managers %}
      {% if not loop.first %} / {% endif %}{{ manager|form_link(true) }}
      {% if manager.attendees|length > 1 %}
      (&nbsp;{%- for managed_attendee in manager.attendees|selectattr('id','!=',attendee.id) -%}
        {% if not loop.first %} / {% endif %}{{ managed_attendee|form_link }}{% if not managed_attendee.is_valid %} <span class="badge">Invalid</span>{% endif %}
        {%- endfor -%}&nbsp;)
      {% endif %}
    {% else %}
      This attendee has no attendee accounts.
    {% endfor %}
  </div>
</div>
{% endif %}
{% endset %}


{% set is_placeholder %}
{% set read_only = is_placeholder_ro or page_ro %}
<script type="text/javascript">
    var boldOrRegular = function () {
        if( $.field('placeholder').is(':checked') ) {
            $('.maybe_bold').css('font-weight', 'normal');
            $('.full_name').css('font-weight', 'bold');
        } else {
            var form = document.forms[0];
            if( form.group_opt && form.group_opt.selectedIndex > 0 )
                $('.maybe_bold').css('font-weight', 'normal');
            else {
                $('.maybe_bold').css('font-weight', 'bold');
                {% if c.AT_THE_CON %}
                    $('#email,#zip_code').css('font-weight', 'normal');
                {% endif %}
            }
        }
    };
    var setPreassigned = function () {
        if( $.field("placeholder").is(":checked") ) {
            $.field("paid").val("{{ c.NEED_NOT_PAY }}");
        }
    };

var setLegalNameRequired = function() {
    if ($("#same_legal_name").length) {
        $.field('legal_name').attr('required', function() {
            return !($.field('placeholder').is(':checked') || $("#same_legal_name").prop('checked'))
        });
    }
};
$(window).on("runJavaScript", function(){
    $.field("placeholder").click(boldOrRegular).click(setPreassigned).change(setLegalNameRequired);
    boldOrRegular();
    setLegalNameRequired();
});
</script>
<div class="form-group">
  <label for="first_name" class="col-sm-3 control-label">Placeholder</label>
  <div class="checkbox col-sm-9">
    <label for='placeholder' class="checkbox-label">
      {{ macros.checkbox(attendee, 'placeholder', is_readonly=read_only, clientside_bool=clientside_bool) }} This attendee needs to
      {% if attendee.is_new %}
        register themself
        </label>
      {% else %}
        </label>
        <a href="../preregistration/confirm?id={{ attendee.id }}" target="_blank">register themself</a>
      {% endif %}
  </div>
</div>
{% endset %}

{% set can_transfer %}
{% set read_only = can_transfer_ro or page_ro or attendee.cannot_transfer_reason %}
<div class="form-group">
  <label for="can_transfer" class="col-sm-3 control-label">Is Transferable</label>
  <div class="checkbox col-sm-6">
    {% if attendee.is_inherently_transferable %}
    This attendee can currently transfer their badge.
    {% elif attendee.cannot_transfer_reason %}
    This attendee cannot transfer their badge under any circumstances because
    {% for reason in attendee.cannot_transfer_reason %}
    {% if loop.last and attendee.cannot_transfer_reason|length > 1 %} and {% endif %}
    {{ reason }}{% if attendee.cannot_transfer_reason|length > 2 %}, {% endif %}
    {% endfor %}.
    {% else %}
    <label for='can_transfer' class="checkbox-label">
      {{ macros.checkbox(attendee, 'can_transfer', is_readonly=read_only, clientside_bool=clientside_bool) }} Make this attendee's badge always transferable
    </label>
    {% endif %}
  </div>
  {% if not attendee.is_inherently_transferable and not attendee.cannot_transfer_reason %}
  <p class="help-block col-sm-9 col-sm-offset-3">
    This attendee can {% if attendee.can_transfer %}only transfer their badge with this override turned on{% else %}<strong>NOT</strong> currently transfer their badge{% endif %}.
  </p>
  {% endif %}
</div>
{% endset %}


{% set badge_status %}
{% set read_only = badge_status_ro or page_ro %}
{% set admin_can_change_status = not c.AT_THE_CON or c.HAS_REG_ADMIN_ACCESS or c.HAS_SECURITY_ADMIN_ACCESS %}
<div class="form-group">
  <label for="badge_status" class="col-sm-3 control-label">Status</label>
  {% call macros.read_only_if(read_only, attendee.badge_status_label) %}
    <div class="col-sm-3">
      <select name="badge_status" class="form-control"{% if not admin_can_change_status %} disabled="true"{% endif %}>
        {{ options(c.BADGE_STATUS_OPTS,attendee.badge_status) }}
      </select>
      {% if not admin_can_change_status %}
        <input type="hidden" name="badge_status" value="{{ attendee.badge_status }}"/>
        Altering the badge status is disabled during the event. The system will update it automatically.{% endif %}
    </div>
  {% endcall %}
</div>
{% endset %}


{% set admin_access %}
{# Always read-only #}
<div class="form-group">
  <label for="admin_status" class="col-sm-3 control-label">Admin Accesses</label>
  <div class="col-sm-9 form-control-static">
    {% if attendee.admin_account %}
      {{ attendee.admin_account.access_groups_labels|join(', ')|default("This attendee has an admin account but no accesses.", true) }}
    {% else %}
      This attendee does not have an admin account.
    {% endif %}
  </div>
</div>
{% endset %}


{% set ribbons %}
{% set read_only = ribbons_ro or page_ro %}
<div class="form-group">
  <label class="col-sm-3 control-label">Ribbons</label>
  {% call macros.read_only_if(read_only, attendee.ribbon_labels) %}
    <div class="col-sm-9 checkbox">
      {{ macros.checkgroup(attendee, 'ribbon') }}
    </div>
  {% endcall %}
</div>
{% endset %}


{% set group_link %}
{% set read_only = group_link_ro or page_ro %}
<script type="text/javascript">
    var setGroupLink = function () {
        if ($.field('group_opt')) {
            var group = $.val('group_opt');
            if (group === '') {
                $('#group_link').hide();
                {% if c.HAS_GROUP_ADMIN_ACCESS and not attendee.group %}$('#new_group').show();{% endif %}
            } else {
                {% if c.HAS_GROUP_ADMIN_ACCESS and not attendee.group %}$('#new_group').hide();{% endif %}
                $('#group_link').attr("href", '../group_admin/form?id=' + group).show();
            }
        }
    };

    var unassigned = {{ unassigned|jsonize }};
    var groupWarning = function() {
        var groupID = $.val("group_opt");
        if (groupID && {{ attendee.is_new|jsonize }} && unassigned[groupID] > 0) {
            $("#unassigned").show("slow");
        } else {
            $("#unassigned").hide("fast");
        }
    };
    $(window).on("runJavaScript", function(){
        setGroupLink();
    });
</script>
<div class="form-group">
  <label for="group_opt" class="col-sm-3 control-label">Group</label>
  {% call macros.read_only_if(read_only, attendee.group) %}
    <div class="col-sm-3">
      <select name="group_opt" class="form-control" onChange="boldOrRegular() ; setGroupLink() ; groupWarning()">
        <option value="">Choose a group, if applicable</option>
        {{ options(group_opts,attendee.group.id) }}
      </select>
      <a id="group_link" href="" target="_blank">View this Group's Page</a>
      {% if c.HAS_GROUP_ADMIN_ACCESS and not attendee.group and not attendee.is_new %}
      <a id="new_group" href="../group_admin/new_group_from_attendee?id={{ attendee.id }}" target="_blank">Create New Group</a>
      {% endif %}
      <div id="unassigned" style="display:none ; color:red">
        Warning: This group has at least one unassigned badge.  Are you sure you want this to be a new attendee and not just fill in the data for one of this group's badges?
      </div>
    </div>
  {% endcall %}
</div>
{% endset %}


{% set promo_code_group_link %}
{# Always read-only #}
{% if attendee.promo_code_groups or attendee.promo_code and attendee.promo_code.group %}
  <div class="form-group">
    <label class="col-sm-3 control-label">Promo Code Group</label>
    <div class="col-sm-6 form-control-static">
      {% for group in attendee.promo_code_groups %}
        This attendee is the buyer/group leader for <strong><a href="../registration/promo_code_group_form?id={{ group.id }}" target="_blank">{{ group.name }}</a></strong>.
      {% endfor %}
      {% if attendee.promo_code and attendee.promo_code.group %}
        This attendee used promo code <strong>{{ attendee.promo_code.code }}</strong> to claim a {{ attendee.promo_code.cost|format_currency }} badge in promo code group <strong><a href="../registration/promo_code_group_form?id={{ attendee.promo_code.group.id }}" target="_blank">{{ attendee.promo_code_group_name }}</a></strong>.
      {% endif %}
    </div>
  </div>
{% endif %}
{% endset %}


{% set panel_app_link %}
{# Always read-only #}
{% if attendee.panel_applicants -%}
  <div class="form-group">
    <label class="col-sm-3 control-label">Panels</label>
    <div class="col-sm-9">
      <div class="form-control-static">
        Panel applications this attendee is associated with:
        <ul>
          {% for applicant in attendee.panel_applicants -%}
            <li>
              <a href="../panels_admin/app?id={{ applicant.application.id }}">{{ applicant.application.name }}</a>
            </li>
          {%- endfor %}
        </ul>
      </div>
    </div>
  </div>
{%- endif %}
{% endset %}


{% set overridden_price %}
{% set read_only = overridden_price_ro or page_ro %}
{% set post_text %}
<label class="checkbox-label">
      <input type="checkbox" name="no_override" {% if attendee.overridden_price == None %} checked {% endif %}>
      Let the system determine base badge price. (uncheck to override badge price)
    </label>
{% endset %}
<div class="form-group">
  <label class="col-sm-3 control-label">Badge Price</label>
  {% call macros.read_only_if(read_only, attendee.badge_price, pre_text='$' if attendee.badge_price, post_text=post_text if attendee.badge_price) %}
  <div class="checkbox col-sm-9">
    $<input type="text" style="width:4em" name="overridden_price" value="{{ attendee.badge_cost|default(0, true) }}" />
    {{ post_text }}
  </div>
{% endcall %}
</div>
{% endset %}


{% set payment_method %}
{% set read_only = payment_method_ro or page_ro %}
{% if not admin_area and c.AT_THE_CON %}
  <script type="text/javascript">
      var maybeBold = function() {
          var $emailLabel = $('#email').parents('.form-group').find('label');
          var $emailConfirmLabel = $("#confirm_email").parents('.form-group').find('label');
          if (!$.field('payment_method') || _(['', {{ c.STRIPE }}, {{ c.MANUAL }}]).contains($.val('payment_method'))) {
              $emailLabel.removeClass('optional-field');
              $emailConfirmLabel.removeClass('optional-field');
          } else {
              $emailLabel.addClass('optional-field');
              $emailConfirmLabel.addClass('optional-field');
          }
      };
      $(window).on("runJavaScript", function () {
          {% if c.AT_THE_DOOR_BADGE_OPTS %}
              maybeBold();
          {% endif %}
      });
  </script>
  <div class="form-group">
    <label class="col-sm-3 control-label">Payment Method</label>
    <div class="col-sm-6">
      {% if c.AFTER_BADGE_PRICE_WAIVED %}
        <div style="margin-top:10px" class="form-control">All badge types are now free - enjoy {{ c.EVENT_NAME }}!</div>
        </div>
      {% else %}
        <select name="payment_method" class="form-control" onChange="maybeBold()">
          <option value="">Select a payment option</option>
          {{ options(c.DOOR_PAYMENT_METHOD_OPTS, payment_method_val) }}
        </select>
        </div>
        {% if c.CHILD_BADGE in c.PREREG_BADGE_TYPES %}
        <div class="form-group">
            <p class="help-block col-sm-9 col-sm-offset-3">
            {% if c.CHILD_BADGE_AVAILABLE %}
              Badges for attendees under 13 are half-price. <br/>
              Attendees under 6 enter free. <br/>
              All attendees under 13 must be accompanied by an adult with a valid Attendee badge.
            {% else %}
          <span class="text-danger">Unfortunately, we are sold out of badges for attendees under 18.</span>
            {% endif %}
            </p>
          </div>
        {% endif %}
      {% endif %}
    
  </div>
{% endif %}
{% endset %}


{% set paid %}
{% set read_only = paid_ro or page_ro %}
<div class="form-group">
  <label class="col-sm-3 control-label">Paid</label>
  <div class="col-sm-6">
  {% if read_only %}
    <p class="form-control-static">This attendee's paid status is <strong>{{ attendee.paid_label }}</strong>.</p>
    {% else %}
    <div class="form-inline">
      <select name="paid" class="form-control">
        {{ options(c.PAYMENT_OPTS,attendee.paid) }}
      </select>
      {% if attendee.badge_status == c.REFUNDED_STATUS %}
      This attendee has been fully refunded.
      {% else %}
      &nbsp;&nbsp;&nbsp;
      <span id="amount_paid">
            Paid: {{ (attendee.amount_paid / 100)|format_currency }}
        </span>
      &nbsp;&nbsp;&nbsp;
      <span id="amount_refunded">
            Refunded: {{ (attendee.amount_refunded / 100)|format_currency }}
        </span>
        {% endif %}
      {% if not read_only and c.HAS_REG_ADMIN_ACCESS %}
        [<a href="../reg_admin/receipt_items?id={{ attendee.id }}" target="_blank">View Receipt(s)</a>]
      {% endif %}
      {% if c.AT_THE_CON and attendee.staffing %}
        <br/> ({{ attendee.worked_hours }} out of {{ attendee.weighted_hours }} hours worked)
      {% endif %}
    </div>
  {% endif %}
  </div>
</div>
{% endset %}


{% set merch %}
{% set read_only = merch_ro or page_ro %}
<div class="form-group">
  <label class="col-sm-3 control-label">Merch Owed</label>
  <div class="col-sm-6 form-control-static">{{ attendee.merch }}
  </div>
</div>
<div class="form-group">
  <label class="col-sm-3 control-label">Extra Merch</label>
  {% call macros.read_only_if(read_only, attendee.extra_merch) %}
  <div class="col-sm-6">
    <input type="text" class="form-control" name="extra_merch" value="{{ attendee.extra_merch }}" />
  </div>
  {% endcall %}
</div>
{% if attendee.merch %}
<div class="form-group">
  <label class="col-sm-3 control-label">Received Merch</label>
  <div class="checkbox col-sm-6">
    {{ macros.checkbox(attendee, 'got_merch', label='Yes', is_readonly=read_only, clientside_bool=clientside_bool) }}
  </div>
</div>
{% endif %}
{% endset %}


{% set staff_merch %}
{% set read_only = staff_merch_ro or page_ro %}
{% if c.SEPARATE_STAFF_MERCH %}
  <div class="form-group">
    <label class="col-sm-3 control-label">Staff Merch Owed</label>
    <div class="col-sm-6 form-control-static">{{ attendee.staff_merch }}
    </div>
  </div>
  {% if attendee.staff_merch %}
  <div class="form-group">
    <label class="col-sm-3 control-label">Received Staff Merch</label>
    <div class="checkbox col-sm-6">
      {{ macros.checkbox(attendee, 'got_staff_merch', label='Yes', is_readonly=read_only, clientside_bool=clientside_bool) }}
    </div>
  </div>
  {% endif %}
{% endif %}
{% endset %}


{% set regdesk_info %}
{% set read_only = regdesk_info_ro or page_ro %}
<div class="form-group">
  <label class="col-sm-3 control-label">Special Regdesk Instructions</label>
  {% call macros.read_only_if(read_only, attendee.regdesk_info) %}
  <div class="col-sm-6">
    <input type="text" name="regdesk_info" class="form-control" value="{{ attendee.regdesk_info }}" />
  </div>
{% endcall %}
</div>
{% endset %}


{% set for_review %}
{% set read_only = for_review_ro or page_ro %}
<div class="form-group">
  <label class="col-sm-3 control-label">Notes for Later Review</label>
  {% call macros.read_only_if(read_only, attendee.for_review) %}
  <div class="col-sm-6">
    <textarea name="for_review" rows="3" class="form-control">{{ attendee.for_review }}</textarea>
  </div>
{% endcall %}
</div>
{% endset %}


{% set admin_notes %}
{% set read_only = admin_notes_ro or page_ro %}
<div class="form-group">
  <label class="col-sm-3 control-label">Admin Notes</label>
  {% call macros.read_only_if(read_only, attendee.admin_notes) %}
  <div class="col-sm-6">
    <textarea name="admin_notes" rows="3" class="form-control">{{ attendee.admin_notes }}</textarea>
  </div>
{% endcall %}
</div>
{% endset %}


{% set agreed_to_volunteer_agreement %}
{# Always read-only #}
{% if c.VOLUNTEER_AGREEMENT_ENABLED and admin_area %}
<div class="form-group staffing staffing-checked">
  <label class="col-sm-3 control-label">Agreed to Volunteer Agreement</label>
  <div class="col-sm-9">
    <div class="form-control-static">
      {{ attendee.agreed_to_volunteer_agreement|yesno("Yes,No") }}
      <input type="hidden" name="agreed_to_volunteer_agreement" value="{{ attendee.agreed_to_volunteer_agreement|yesno("1,0") }}" />
    </div>
  </div>
</div>
{% endif %}
{% endset %}


{% set reviewed_emergency_procedures %}
{# Always read-only #}
{% if c.EMERGENCY_PROCEDURES_ENABLED and admin_area %}
<div class="form-group staffing staffing-checked">
  <label class="col-sm-3 control-label">Reviewed Emergency Procedures</label>
  <div class="col-sm-9">
    <div class="form-control-static">
      {{ attendee.reviewed_emergency_procedures|yesno("Yes,No") }}
      <input type="hidden" name="reviewed_emergency_procedures" value="{{ attendee.reviewed_emergency_procedures|yesno("1,0") }}" />
    </div>
  </div>
</div>
{% endif %}
{% endset %}


{% set hotel_eligible %}
{# Always read-only #}
<div class="form-group staffing staffing-checked">
  <label class="col-sm-3 control-label">Hotel Eligible</label>
  <div class="col-sm-9">
    <div class="form-control-static">
      {% if c.HAS_HOTEL_ADMIN_ACCESS %}{{ attendee.hotel_eligible|yesno("Yes,No") }}{% endif %}
      <input type="hidden" name="hotel_eligible" value="{{ attendee.hotel_eligible|yesno("1,0") }}" />
    </div>
  </div>
</div>
{% endset %}


{% set attractions_opt_out %}
{# Always read-only #}
<div class="form-group">
  <label class="col-sm-3 control-label">Attraction Sign-Ups</label>
  <div class="col-sm-9">
    <div class="form-control-static">
      {% if c.ATTRACTIONS_ENABLED and admin_area %}{{ attendee.attractions_opt_out|yesno("Disabled,Enabled") }}{% endif %}
      <input type="hidden" name="attractions_opt_out" value="{{ attendee.attractions_opt_out|yesno("1,0") }}" />
    </div>
  </div>
</div>
{% endset %}
