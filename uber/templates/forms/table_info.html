{% import 'macros.html' as macros with context %}
{% import 'forms/macros.html' as form_macros with context %}
{% set table_info = table_info or forms['table_info'] %}

{# BLOCK NAMES in this form:
    admin_fields
    cost
    name_desc
    badges_js
    badges_tables
    website
    categories
    textareas

Use these to add or rearrange fields. Remember to use {{ super() }} to print the original fields as-is.
#}

{% set max_badges = c.MAX_GROUP_SIZE if admin_area else c.MAX_DEALERS %}

{% block admin_fields %}
{% if admin_area %}
{% set status_admin_text %}
{% if not new_dealer and not group.is_new %}
    <a href="#" onClick="$('#setStatus').toggle(); return false;">Waitlist or Decline (with Email)</a>
{% endif %}
{% endset %}

<div class="row g-sm-3">
    <div class="col-12 col-sm-6">{{ form_macros.form_input(table_info.status, admin_text=status_admin_text) }}
        <div id="setStatus" style="display:none">
            Enter an email message to be sent along with the notification: <br/>
            (The email subject will be "Your {{ c.EVENT_NAME }} {{ c.DEALER_REG_TERM|title }} has been [waitlisted | declined]")
            <textarea name="email_text" class="form-control" rows="5" cols="50"></textarea> <br/>
            <button class="btn btn-warning" onClick="unapprove('waitlisted'); return false;">Waitlist</button>
            <button class="btn btn-danger" onClick="unapprove('declined'); return false;">Reject and Convert Badges</button>
            <p class="help-block">(Rejected {{ c.DEALER_TERM }}s are able to register at the price they would have paid when they applied.)</p>
        </div>
    </div>
    <div class="col-12 col-sm-6">{{ form_macros.form_input(table_info.admin_notes) }}</div>
</div>
<script type="text/javascript">
    var unapprove = function(action, convert) {
      if (!$.val("email_text")) {
        $("#setstatus").prepend('<div style="color:red">You must enter an email message.</div>');
      } else {
        $("button").attr("disabled", true);
        $.post("../dealer_admin/unapprove", {
          id: "{{ group.id }}",
          action: action,
          convert: convert,
          csrf_token: csrf_token,
          email_text: $.val("email_text")
        }, function(json) {
          if (json.message) {
            window.location = "index?message="+ json.message + "#dealers";
          } else {
            $("#status").text("Waitlisted");
          }
        }, 'json');
      }
    }
</script>
{% endif %}
{% endblock %}

{% block cost %}
{% if admin_area %}
<div class="row g-sm-3">
    <div class="col-12 col-sm-6">
        {{ form_macros.form_input(table_info.cost, extra_field=form_macros.form_input(table_info.auto_recalc), no_margin=True) }}
    </div>
    {% if group.cost %}
    <div class="col-12 col-sm-3">
        {{ form_macros.form_input(table_info.amount_paid_repr) }}
    </div>
    <div class="col-12 col-sm-3">
        {{ form_macros.form_input(table_info.amount_refunded_repr) }}
    </div>
    {% endif %}
</div>
{% endif %}
{% endblock %}

{% if admin_area %}
<button type="submit" class="btn btn-primary" value="Upload">Save</button>
<hr/>
<div class="form-text">Table Info</div>
{% endif %}

{% block name_desc %}
<div class="row g-sm-3">
    <div class="col-12 col-sm-6">{{ form_macros.form_input(table_info.name) }}</div>
    <div class="col-12 col-sm-6">{{ form_macros.form_input(table_info.description) }}</div>
</div>
{% endblock %}

{% block badges_js %}
{% if is_prereg_dealer %}
{% if not c.MAX_DEALERS %}
  <script type="text/javascript">
  updateBadgeMax = function() {
      var new_badge_max = Math.ceil(parseFloat($("select[name=tables]").val())) + 1;
      var curr_badge_max = parseInt($('select[name=badges] option:last').val()) || 0;
      if (new_badge_max && curr_badge_max > new_badge_max) {
          $("select[name=badges] option").slice(new_badge_max+1, curr_badge_max+1).remove();
      } else {
        if (new_badge_max == 0) { new_badge_max = {{ c.MAX_GROUP_SIZE }}; }
        for (i = curr_badge_max+1; i < new_badge_max+1; i++) {
            $("select[name=badges]").append('<option id="badges-'+i+'" value="'+i+'">'+i+'</option>');
        }
      }
  };
  $(function() {
      $("select[name=tables]").on('change', updateBadgeMax);
      updateBadgeMax();
      let badges = parseInt("{{ badges }}") || 0
      let lastBadge = parseInt($('select[name=badges] option:last').val()) || 0
      var selectedBadge = Math.min(badges, lastBadge);
      $('select[name=badges] option[value="' + selectedBadge + '"]').prop('selected', true);
  });

  </script>
{% endif %}
{% endif %}
{% endblock %}

{% block badges_tables %}
{% if is_prereg_dealer or admin_area %}
    <div class="row g-sm-3">
        <div class="col-12 col-sm-6">{{ form_macros.form_input(table_info.tables, choices=c.ADMIN_TABLE_OPTS if admin_area else c.PREREG_TABLE_OPTS, required=True) }}</div>
        <div class="col-12 col-sm-6">{{ form_macros.form_input(table_info.badges,
                                            choices=int_choices(1, max_badges),
                                            extra_field=form_macros.form_input(table_info.can_add) if admin_area else None,
                                            admin_text="[" ~ group.badges_purchased ~ " badge" ~ group.badges_purchased|pluralize ~ " purchased]" if not group.is_new else "",
                                            required=True) }}
            {% if admin_area %}
                {{ form_macros.form_input(table_info.new_badge_type, admin_text="Only affects newly added badges.") }}
                {{ form_macros.toggle_fields_js(table_info.badges, [table_info.new_badge_type], off_values=range(table_info.badges.data + 1)|list, closest_hide_selector='.form-floating') }}
            {% endif %}
        </div>
    </div>
{% else %}
<div class="row g-sm-3">
    <div class="col-12 col-sm-6">{{ form_macros.form_input(table_info.tables, choices=c.PREREG_TABLE_OPTS, required=True) }}</div>
</div>
{% endif %}
{% endblock %}

{% block website %}
<div class="row g-sm-3">
    <div class="col-12 col-sm-6">{{ form_macros.form_input(table_info.website) }}</div>
</div>
{% endblock %}

{% block categories %}
<div class="row g-sm-3">
    <div class="col-12">
        {{ form_macros.form_input(table_info.categories, extra_field=form_macros.form_input(table_info.categories_text, no_margin=True)) }}
        {{ form_macros.toggle_fields_js(table_info.categories, [table_info.categories_text], on_values=[c.OTHER], toggle_required=True, closest_hide_selector='.col') }}
    </div>
</div>
{% endblock %}

{% block textareas %}
<div class="row g-sm-3">
    <div class="col-12">{{ form_macros.form_input(table_info.wares) }}</div>
</div>
<div class="row g-sm-3">
    <div class="col-12">{{ form_macros.form_input(table_info.special_needs) }}</div>
</div>
{% if admin_area %}
<div class="row g-sm-3">
    <div class="col-12">{{ form_macros.form_input(table_info.admin_notes) }}</div>
</div>
{% endif %}
{% endblock %}