{% extends "base.html" %}{% set admin_area=True %}
{% block title %}Schedule{% endblock %}
{% block content %}
<div class="d-flex mb-3 gap-3 justify-content-between align-items-end">
    <div class="d-flex gap-1 align-items-center">
        <button type="button" class="btn btn-primary" onClick="$('.schedule-edit').toggleClass('d-none'); return false;">Edit Locations</button>
        <a class="btn btn-success" href="location">Add Location</a>
    </div>
    <div class="d-flex gap-3">
        <div>
        <div class="form-text">
            <label for="department">Department</label>
        </div>
        <select class="form-select" id="dept_filter" onChange="setDepartment()">
            <option selected="true" value="all">Filter By Department...</option>
            <option value="None">No Department</option>
            {% for val, label in c.EVENT_DEPTS_OPTS %}
            <option value="{{ val }}">{{ label }}</option>
            {% endfor %}
        </select>
        </div>
        <div id="room_filter">
        <form method="post" action="ical" role="form">
            <div class="d-flex gap-3 align-items-end">
                <div>
                <div class="form-text">
                    <label for="room_filter_text">Location Name</label>
                </div>
                <input type="text" name="filter" class="filter form-control" id="room_filter_text" autofocus="autofocus" placeholder="Room Name">
                <input type="hidden" id="filtered_locations" name="locations" />
                </div>
                <div><button class="btn btn-primary form-inline">Export to iCal</button></div>
            </div>
            </form>
        </div>
    </div>
</div>

<style type="text/css">

.context-menu-item {
  padding: 2px 2px 2px 7px;
}

.schedule-rooms td .content-wrapper {
  overflow: visible;
}

.schedule-rooms tbody {
  cursor: pointer;
}

.schedule-rooms tbody td:hover {
  background: #ff6;
}

label.radio-label {
    font-weight: normal;
    margin-left: 7px;
}

#room_toggle {
    display: inline-block;
}

#room_filter {
    float: right;
}

</style>

{{ "event-calendar-3.10.0/event-calendar.min.css"|serve_static_content }}
{{ "event-calendar-3.10.0/event-calendar.min.js"|serve_static_content }}

<style>
    .ec-timeline .ec-time, .ec-timeline .ec-line {
        width: 150px;
    }
    .ec {
        width: 100%;
    }
    .ec-header, .ec-body {
        width: {{ c.SCHEDULE_LOCATIONS|length * 148 + 90 }}px;
    }

.ec-header .ec-day {
    min-height: auto;
    overflow: visible;
    align-items: center;
    display: flex;
    justify-content: center;
}

.ec-event {
    border-color: white;
    border-width: thin;
    border-style: solid;
}

h2.ec-title {
    display: inline;
}

.offset-scroll {
    scroll-margin-top: 500px;
}
</style>

<div id="event-schedule">
</div>

<script type="text/javascript">

let ec;
let currentDate = '{{ current_date }}';
let allLocations = {{ locations|safe }}.sort((a, b) => a.title.localeCompare(b.title));

filtered_locs = [];
var updateiCalFilter = function(locations) {
    let locationIDs = [];
    locations.forEach(function(el) { locationIDs.push(el.id) });
    $('#filtered_locations').val(JSON.stringify(locationIDs));
};

var setCalWidth = function(roomCount) {
    width = roomCount * 148 + 90;
    $('.ec-header').css('width', `${width}px`);
    $('.ec-body').css('width', `${width}px`);
}

let deptLocations, searchLocations;
let deptSelected = false, searchTextEntered = false;

let setDepartment = function () {
    let choice = $('#dept_filter').val();
    if (choice == "" || choice == "all") {
        deptSelected = false;
    } else {
        deptLocations = allLocations.filter(function(el) { return el.extendedProps.departments.includes(choice); });
        deptSelected = true;
    }
    updateLocations();
  }

let updateLocations = function () {
    let currLocations = allLocations;
    if (deptSelected == true) { currLocations = currLocations.filter(function(el) { return deptLocations.includes(el); }) }
    if (searchTextEntered == true) { currLocations = currLocations.filter(function(el) { return searchLocations.includes(el); }) }
    ec.setOption('resources', currLocations);
    setCalWidth(currLocations.length);
    updateiCalFilter(currLocations);
}

$(function() {
var $scheduleTable = $('.schedule-table'),
    $scheduleRooms = $('.schedule-rooms');


var roomTrie = {{ c.ROOM_TRIE|jsonize }};
$('#room_filter_text').on('keyup', function() {
    var text = $(this).val().toLowerCase(),
        textLength = text.length,
        rooms = roomTrie;

    if (textLength <= 0) {
        searchTextEntered = false;
        updateLocations();
        return;
    }

    searchTextEntered = true;

    for (var i = 0; i < textLength; i++) {
        var s = text.charAt(i);
        rooms = rooms[s];
        if (!rooms) {
            break;
        }
    }

    if (rooms && rooms['__rooms__']) {
        var matchingLocations = [];
        $.each(rooms['__rooms__'], function(location, index) {
            matchingLocations.push(location);
        });
        
        searchLocations = allLocations.filter(function(el) { return matchingLocations.includes(el.id.toString()); });
    } else {
        searchLocations = [];
    }
    updateLocations();
});

var delay = (function(){
    var timer = 0;
    return function(callback, ms){
    clearTimeout (timer);
    timer = setTimeout(callback, ms);
    };
})();

});

let renderLabel = function (info) {
    let resourceInfo = info.resource;

    html = `<a class="d-none schedule-edit" href="location?id=${resourceInfo.id}"><i class="fa fa-pencil"></i></a>
            <span class="align-self-center">${resourceInfo.title}</span>`;
    return {
      html: html,
    }
}

let renderEvent = function (info) {
    let eventInfo = info.event;
    if (eventInfo.display == 'pointer') {
      return;
    }

    let extraClasses = '';
    if ({{ c.PANEL_ROOMS|jsonize }}.includes(eventInfo.id)) {
        extraClasses += ' panel-room';
    }
    if ({{ c.MUSIC_ROOMS|jsonize }}.includes(eventInfo.id)) {
        extraClasses += ' music-room';
    }

    html = `<h2 class="offset-scroll h6 mb-0 p-1${extraClasses}" id="event-${eventInfo.id}">${eventInfo.title}</h2>`;
    return {
      html: html,
    }
}

let dateChange = function (info) {
    if (info.view.type == 'resourceTimeGridDay' && ec && currentDate != info.startStr) {
        currentDate = info.startStr
        if (info.startStr == '{{ c.PANELS_EPOCH.date() }}T00:00:00') {
            ec.setOption('slotMinTime', '{{ c.PANELS_EPOCH.hour }}');
        } else {
            ec.setOption('slotMinTime', '00:00:00');
        }
        if (info.startStr == '{{ c.PANELS_ESCHATON.date() }}T00:00:00') {
            ec.setOption('slotMaxTime', '{{ c.PANELS_ESCHATON.hour }}');
        } else {
            ec.setOption('slotMaxTime', '24:00:00');
        }
    }
}

let updateEvent = function (info) {
    tz_offset = info.event.start.getTimezoneOffset() * 60000;
    if (info.oldEvent.start.toISOString() == info.event.start.toISOString()
        && typeof info.endDelta == 'undefined' && info.oldEvent.resourceIds == info.event.resourceIds) {
        return
    }

    let seconds = 0;
    
    if (typeof info.endDelta != 'undefined') {
        seconds = info.endDelta.seconds
    }
    $.ajax({
        method: 'POST',
        url: 'update_event',
        dataType: 'json',
        data: {
        id: info.event.id,
        start_time: new Date(info.event.start - tz_offset).toISOString().slice(0, -1),
        delta_seconds: seconds,
        location_id: info.event.resourceIds[0],
        csrf_token: csrf_token
        },
        success: function (json) {
        hideMessageBox();
        var message = json.message;
        if (json.success) {
            $("#message-alert").addClass("alert-success").show().children('span').html(message);
        } else {
            showErrorMessage(json.message);
        }
        },
        error: function () {
            showErrorMessage('Unable to connect to server, please try again.');
        }
    });
}

ec = new EventCalendar(document.getElementById('event-schedule'), {
    view: 'resourceTimeGridDay',
    date: '{{ current_date }}',
    slotMinTime: '{{ c.PANELS_EPOCH.hour if c.PANELS_EPOCH.date()|string in current_date else "00:00:00" }}',
    allDaySlot: false,
    scrollTime: '{{ c.PANELS_EPOCH.hour }}',
    headerToolbar: {
        start: 'prev,next title',
        center: '',
        end: '',
    },
    titleFormat: {weekday: 'long', day: 'numeric', month: 'numeric', year: 'numeric'},
    pointer: true,
    nowIndicator: true,
    slotDuration: {minutes: 15},
    validRange: {
        start: '{{ c.PANELS_EPOCH.date() }}',
        end: '{{ c.PANELS_ESCHATON.date() }}',
    },
    views: {
        resourceTimelineDay: {
            slotWidth: 150,
        },
        /* Views to be added later
        resourceTimelineWeek: {
            slotWidth: 150,
            duration: {days: '{{ c.PANEL_SCHEDULE_DAYS }}'},
        },
        listWeek: {duration: {days: '{{ c.PANEL_SCHEDULE_DAYS }}'}}
         */
    },
    events: {{ events|safe }},
    eventContent: renderEvent,
    resources: allLocations,
    resourceLabelContent: renderLabel,
    eventClick: function (info) { window.location = `form?id=${info.event.id}` },
    dateClick: function (info) { window.location = `form?location_id=${info.resource.id}&start_time=${info.dateStr}` },
    datesSet: dateChange,
    eventDrop: updateEvent,
    eventResize: updateEvent,
});

{% if current_event %}
$().ready(function () {
    replaceQueryParamInUrl('view_event');
    location.href = "#event-{{ current_event }}";
});
{% endif %}
</script>
{% endblock %}
