{% extends "base.html" %}{% set admin_area=True %}
{% import 'forms/macros.html' as form_macros with context %}
{% block title %}Schedule{% endblock %}
{% block content %}
<h2>{% if event.is_new %}Add{% else %}Edit{% endif %} Event</h2>
{{ form_macros.form_validation('event-form', 'validate_event') }}
  <form novalidate method="post" action="form" id="event-form">
    <input type="hidden" name="id" value="{{ event.db_id }}" />

    {{ csrf_token() }}

    {% include 'forms/panel/event_info.html' with context %}

<div class="row g-3 mb-3">
    <div class="col-sm">
        <label for="panel_id" class="form-text">Panel Applications</label>
        <select name="panel_id" id="panel_id" class="form-select">
            <option selected="true" value="">Associate a panel application with this event</option>
            {% for panel in approved_panel_apps %}
              <option value="{{ panel.id }}">{{ panel.name }} ({{ panel.length_text if panel.length_text else panel.length_label }})</option>
            {% endfor %}
        </select>
        {% for app in event.applications %}
        <br/> (<a href="../panels_admin/app?id={{ app.id }}">view application for {{ app.name }}</a>)
        {% endfor %}
    </div>
    <div class="col-sm">
        <label for="panel_id" class="form-text">Panelists</label>
        <div><a class="btn btn-primary" id="add" href="#" onClick="addPanelist(); return false">Add a Panelist</a></div>
    </div>
</div>
</form>

<div class="d-flex gap-3 align-items-start mb-3">
    <div><input type="submit" class="btn btn-primary" form="event-form" value="Upload Event Data" /></div>
    {% if not event.is_new %}
    <div>
        <form method="post" action="delete" onSubmit="return confirm('Are you sure you want to delete this event?');">
        {{ csrf_token() }}
        <input type="hidden" name="id" value="{{ event.id }}" />
        <input type="submit" value="Delete This Event" class="btn btn-danger" />
        </form>
        {% if c.HAS_PANELS_ADMIN_ACCESS and not event.is_new %}
    </div><div><a class="btn btn-outline-primary" href="../panels_admin/panel_feedback?event_id={{ event.id }}">Leave panel feedback</a></div>
    {% endif %}</div>
    {% endif %}
</div>

<script type="text/javascript">
    var panelists = {{ panelists|jsonize }};
    
    var $panelists = $("<select/>").attr("name", "panelists").attr("class", "form-select").css("margin-right", "10px");
    $.each(panelists, function(i,p) {
        $panelists.append( $("<option/>").attr("value", p[0]).text(p[1]) );
    });
    
    var removePanelist = function(event) {
        event.preventDefault();
        $(event.target).parent("div").remove();
    };
    var addPanelist = function(id) {
        $("#add").after(
            $("<div/>").css("padding-top", "5px").attr("class", "d-flex gap-3 align-items-center")
                       .append(
                            $panelists.clone()
                                      .val(id || $panelists.val()))
                       .append(
                            $("<a/>").attr("href", "#").attr("class", "btn btn-sm btn-danger")
                                     .text("Remove Panelist")
                                     .click(removePanelist)));
    };
    
    $(function(){
        $.each({{ assigned|jsonize }}, function(i,id) {
            addPanelist(id);
        });
    });
    {% if event.is_new %}
        var showOrHidePanelDetails = function() {
            setVisible(".card-details", !($.val('panel_id')))
        };
        $(function() {
            showOrHidePanelDetails();
            $.field('panel_id').on('change', showOrHidePanelDetails);
        });
    {% endif %}
</script>

{% endblock %}
