{% extends "base.html" %}{% set admin_area=True %}

{% if art_show_app %}
  {% set model_str = "application" %}
  {% set model = art_show_app %}
{% elif group %}
  {% set model_str = "group" %}
  {% set model = group %}
{% else %}
  {% set model_str = "attendee" %}
  {% set model = attendee %}
{% endif %}

{% block title %}Receipt Items - {% if model.attendee %}{{ model.attendee.full_name }}'s {{ model_str|title }}{% else %}{{ model.full_name|default(model.name) }}{% endif %}{% endblock %}
{% block content %}
<script type="text/javascript">
  var hideRow = function (id) {
    $('#' + id).hide('slow');
  };
  var updateRow = function (id, selector, text) {
    $('#' + id + selector).html(text);
  };
  var updateTotal = function (text, disable_button=true) {
    $('#receipt_total').html(text);
    $('#record_payment_refund').prop('disabled', disable_button);
  }
  var showForm = function(receiptId, whichForm) {
    $('#' + receiptId + whichForm).removeClass('hidden')
  };
  var hideForm = function(receiptId, whichForm) {
    $('#' + receiptId + whichForm).addClass('hidden')
  };
  var deleteItem = function (itemId) {
    bootbox.confirm({
      title: "Delete Receipt Item?",
      message: "This will permanently remove this receipt item. " +
      "This cannot be undone, and should only be used for receipt items " +
      "that were recorded incorrectly. Are you sure?",
      buttons: {
          confirm: {
              label: 'Delete Receipt Item',
              className: 'btn-danger'
          },
          cancel: {
              label: 'Nevermind',
              className: 'btn-default'
          }
      },
      callback: function (result) {
        if(result) {
          $.post('remove_receipt_item', {csrf_token: csrf_token, id: itemId}, function (response) {
            toastr.clear();
            if (response.error) {
              toastr.error(response.error);
            } else {
              toastr.info('Item deleted');
              hideRow(response.removed);
              updateTotal(response.new_total, response.disable_button);
            }
          }, 'json');
        }
      }
    });
  };

  var undoItem = function (itemId) {
    bootbox.confirm({
      title: "Undo Receipt Item?",
      message: "This will revert this change to this {{ model_str }}'s registration. Are you sure?",
      buttons: {
          confirm: {
              label: 'Undo',
              className: 'btn-danger'
          },
          cancel: {
              label: 'Nevermind',
              className: 'btn-default'
          }
      },
      callback: function (result) {
        if(result) {
          $.post('undo_receipt_item', {csrf_token: csrf_token, id: itemId}, function (response) {
            toastr.clear();
            if (response.error) {
              toastr.error(response.error);
            } else {
              window.location = 'receipt_items?id={{ model.id }}&message=Receipt item reverted'
            }
          }, 'json');
        }
      }
    });
  };

  var cancelTxn = function (txnId) {
    bootbox.confirm({
      title: "Cancel Transaction?",
      message: "This will permanently mark this transaction as cancelled. " +
        "This cannot be undone, and should only be used for payments that " +
        "were recorded incorrectly or that you are sure did not go through. " +
        "Are you sure?",
      buttons: {
          confirm: {
              label: 'Mark Transaction as Cancelled',
              className: 'btn-danger'
          },
          cancel: {
              label: 'Nevermind',
              className: 'btn-default'
          }
      },
      callback: function (result) {
        if(result) {
          $.post('cancel_receipt_txn', {csrf_token: csrf_token, id: txnId}, function (response) {
            toastr.clear();
            if (response.error) {
              toastr.error(response.error);
            } else {
              toastr.info('Transaction cancelled');
              updateRow(response.cancelled, ' td:last', "<em>Cancelled " + response.time + ".</em>");
              updateTotal(response.new_total, response.disable_button);
            }
          }, 'json');
        }
      }
    });
  };

  var refundTxn = function (txnId, amount) {
    bootbox.confirm({
      title: "Refund Transaction?",
      message: "This will refund the attendee " + amount + " through Stripe. " +
        "This cannot be undone. Are you sure?",
      buttons: {
          confirm: {
              label: 'Refund',
              className: 'btn-danger'
          },
          cancel: {
              label: 'Nevermind',
              className: 'btn-default'
          }
      },
      callback: function (result) {
        if(result) {
          $.post('refund_receipt_txn', {csrf_token: csrf_token, id: txnId}, function (response) {
            toastr.clear();
            if (response.error) {
              toastr.error(response.error);
            } else {
              toastr.info('Transaction refunded');
              updateRow(response.refunded, ' td:last', "<em>Transaction refunded.</em>");
              updateTotal(response.new_total, response.disable_button);
            }
          }, 'json');
        }
      }
    });
  };

  var addPayment = function ($form, $btn) {
    $.post('add_receipt_txn', $form.serialize(), function(result) {
      $btn.prop('disabled', false);
      toastr.clear();
      if (result.error) {
        toastr.error(result.error);
      } else if (result.success) {
        window.location = 'receipt_items?id={{ model.id }}&message=Receipt item added'
      }
    });
  };

  var fullRefund = function (receiptId) {
    bootbox.confirm({
      title: "Refund and Cancel Registration?",
      message: "This will refund ALL existing Stripe transactions that have not already been refunded. " +
               "It will also cancel this {{ model_str }}'s registration. Are you sure?",
      buttons: {
          confirm: {
              label: 'Fully Refund and Cancel',
              className: 'btn-danger'
          },
          cancel: {
              label: 'Nevermind',
              className: 'btn-default'
          }
      },
      callback: function (result) {
        if(result) {
          window.location = 'process_full_refund?id=' + receiptId +
          {% if attendee %}
          '&attendee_id={{ attendee.id }}'
          {% else %}
          '&group_id={{ group.id }}'
          {% endif %}
        }
      }
    });
  };

  $().ready(function () {
    $("form[action='add_receipt_item']").submit(function(event){
      var $form = $(this);
      $btn = $form.find('button[type=submit]');
      event.preventDefault();
      $btn.prop('disabled', true);
      $.post('add_receipt_item', $form.serialize(), function(result) {
        toastr.clear();
        $btn.prop('disabled', false);
        if (result.error) {
          toastr.error(result.error);
        } else if (result.success) {
          window.location = 'receipt_items?id={{ model.id }}&message=Receipt item added'
        }
      });
    });

    $("form[action='add_receipt_txn']").submit(function(event){
      var $form = $(this);
      $btn = $form.find('button[type=submit]');
      event.preventDefault();
      $btn.prop('disabled', true);
      var submitForm = false;
      if (parseInt($("form[action='add_receipt_txn'] input[name='amount']").val()) > 0) {
        bootbox.confirm({
          title: "Add Payment?",
          message: "If you add a payment equal to what the attendee currently owes, " +
            "all open receipt items will be closed and marked as paid. " +
            "This cannot be undone. Are you sure?",
          buttons: {
              confirm: {
                  label: 'Add Payment',
                  className: 'btn-success'
              },
              cancel: {
                  label: 'Nevermind',
                  className: 'btn-default'
              }
          },
          callback: function (result) {
            if(result) {
              addPayment($form, $btn);
            } else {
              $btn.prop('disabled', false);
            }
          }
        });
      } else {
        addPayment($form, $btn);
      }
    });
  });
</script>
{% if art_show_app %}
{{ macros.nav_menu(
  art_show_app, c.PAGE_PATH,
  "../art_show_admin/form?id={id}", "App Form", True,
  "../art_show_admin/pieces?id={id}", "Submitted Pieces", True,
  "receipt_items?id={id}", "Receipt Items", c.HAS_REG_ADMIN_ACCESS,
  "../art_show_admin/history?id={id}", "History", True,
  "../art_show_admin/index", "Return to App List", True
  ) }}

{% else %}
  {% include "registration/menu.html" if attendee else "group_admin/nav_menu.html" %}
{% endif %}

<h2>Receipt{% if other_receipts %}s{% endif %} for {% if model.attendee %}{{ model.attendee.full_name }}'s {{ model_str|title }}{% else %}{{ model.full_name|default(model.name) }}{% endif %}{% if c.AT_THE_CON and model.badge_num %}({{ model.badge }}){% endif %}</h2>
  <div class="panel panel-body">
  <p>Use this form to remove and add custom purchases and credits or non-Stripe payments and refunds for this {{ model_str }}.
    You will not be able to remove purchases or credits that were created before a sucessful payment was made.
    Confirmed Stripe payments or refunds that have a Stripe ID will also be locked.
  </p>

  <p>
    Enter a positive number in the amount field to add a purchase, and a negative number to apply a credit.
    Similarly, payments and refunds can be tracked using positive and negative amounts, respectively.
  </p>
  
  <p>
    If a payment was made and confirmed through Stripe, you can refund part or all of it using the "Refund Transaction" button.
    Note that some Stripe payments may appear on multiple receipts, for example, when somone registers multiple badges in one transaction.
  </p>

  <p>
    Please always itemize purchases and credits. Items with the same price, and <em>only</em> items with the same price,
    may be grouped into one purchase by setting the Amount as the per-item price and the Quantity field to how many items were purchased.
  </p>
  </div>

{% macro receipt_table(receipt, items) %}
  <table class="table table-striped">
    <thead><tr>
      <th>Added</th>
      <th>Admin</th>
      <th>Type</th>
      <th>Description</th>
      <th>Amount</th>
      <th></th>
    </tr></thead>
    {% for item in items %}
      <tr id="{{ item.id }}">
        <td>{{ item.added|datetime_local("%b %-d %-H:%M (%-I:%M%p)") }}</td>
        <td>{{ item.who }}</td>
        <td>
          {% if item.method %}
            {{ "Payment" if item.amount > 0 else "Refund" }} ({{ item.method_label }})
          {% else %}
            {{ "Purchase" if item.amount > 0 else "Credit" }}
          {% endif %}
        </td>
        <td>{{ item.desc }}{{ " (Stripe ID: " ~ item.stripe_id ~ ")" if item.stripe_id else "" }}</td>
        <td>
          {{ (item.amount / 100)|format_currency(true) }}
          {% if item.count and item.count > 1 %}
             x{{ item.count }}: {{ (item.count * item.amount / 100)|format_currency }}
          {% endif %}
          </td>
        <td>
          {% if item.cancelled %}
            <em>Cancelled {{ item.cancelled|datetime_local }}</em>
          {% elif item.closed %}
            {% if item.revert_change and not receipt.closed %}
              <button class="btn btn-sm btn-danger" onClick="undoItem('{{ item.id }}', '{{ receipt.id }}')">Undo Item</button>
            {% else %}
              <em>Payment finalized {{ item.closed|datetime_local }}</em>
            {% endif %}
          {% elif item.is_pending_charge or not item.stripe_id %}
            {% if item.intent_id and not item.refund_id and not receipt.closed %}
              <button class="btn btn-sm btn-danger" onClick="cancelTxn('{{ item.id }}')">Mark as Cancelled</button>
            {% elif item.method and not receipt.open_receipt_items|selectattr("added", "<", item.added)|list|length %}
              <em>Payment locked.</em>
            {% elif not receipt.closed %}
              {% if item.revert_change %}
                <button class="btn btn-sm btn-danger" onClick="undoItem('{{ item.id }}', '{{ receipt.id }}')">Undo Item</button>
              {% endif %}
              <button class="btn btn-sm btn-danger" onClick="deleteItem('{{ item.id }}')">
                Delete {{ "Transaction" if item.method else "Item" }}
              </button>
            {% endif %}
          {% elif item.refund_id and (item.refunded or item.amount > 0) %}
              <em>{% if item.refunded %}{{ item.refunded|format_currency }}{% else %}Transaction{% endif %} refunded.</em>
          {% elif item.charge_id and not item.refund_id and not receipt.closed %}
            <button class="btn btn-sm btn-success" onClick="refundTxn('{{ item.id }}', '{{ (item.amount / 100)|format_currency }}')">Refund Transaction</button>
          {% endif %}
        </td>
      </tr>
    {% endfor %}
    <tr>
      <td colspan="7">
        <span class="pull-right"><strong>Total</strong>: <span id="receipt_total">{{ receipt.total_str }}</span></span>
      </td>
    </tr>
    <tr id="{{ receipt.id }}-item-form" class="hidden">
      <td colspan="7">
        <button type="button" class="close pull-left" aria-label="Close" onClick="hideForm('{{ receipt.id }}', '-item-form')"><span aria-hidden="true">&times;</span></button>
        <form method="post" action="add_receipt_item" class="form-inline pull-right">
          {{ csrf_token() }}
          <input type="hidden" name="id" value="{{ receipt.id }}" />
          <div class="form-group">
            <label for="desc">Description</label>
            <input type="text" name="desc" class="form-control" placeholder="Item Description" required>
          </div>
          <div class="form-group">
            <label for="amount">Amount</label>
            <div class="input-group">
              <span class="input-group-addon">$</span>
              <input type="number" name="amount" class="form-control" placeholder="0" required>
              <span class="input-group-addon">.00</span>
            </div>
          </div>
          <div class="form-group">
            <label for="count">Quantity</label>
              <input type="number" name="count" class="form-control" placeholder="1">
          </div>
          <button type="submit" class="btn btn-primary">Add Purchase/Credit</button>
        </form>
      </td>
    </tr>
    <tr id="{{ receipt.id }}-txn-form" class="hidden">
      <td colspan="7">
        <button type="button" class="close pull-left" aria-label="Close" onClick="hideForm('{{ receipt.id }}', '-txn-form')"><span aria-hidden="true">&times;</span></button>
        <form method="post" action="add_receipt_txn" class="form-inline pull-right">
          {{ csrf_token() }}
          <input type="hidden" name="id" value="{{ receipt.id }}" />
          <div class="form-group">
            <label for="amount">Payment/Refund Method</label>
            <select name="method" class="form-control">
              <option value="">Select a Method</option>
              {{ options(c.PAYMENT_METHOD_OPTS, c.CASH) }}
            </select>
          </div>
          <div class="form-group">
            <label for="count">Amount</label>
            <div class="input-group">
              <span class="input-group-addon">$</span>
              <input type="number" name="amount" class="form-control" placeholder="0" required>
              <span class="input-group-addon">.00</span>
            </div>
          </div>
          <div class="form-group">
            <label for="desc">Description</label>
            <input type="text" name="desc" class="form-control" placeholder="Transaction Description">
          </div>
          <button type="submit" class="btn btn-success">Add Payment/Refund</button>
        </form>
      </td>
    </tr>
    {% if not receipt.closed %}
    <tr id="{{ receipt.id }}">
      <td colspan="7">
        <div class="btn-group pull-right" role="group" aria-label="...">
          <button class="btn btn-primary" onClick="showForm('{{ receipt.id }}', '-item-form')">Add Custom Purchase or Credit</button>
          <button class="btn btn-success" id="record_payment_refund" onClick="showForm('{{ receipt.id }}', '-txn-form')"{% if receipt.current_receipt_amount == 0 %} disabled{% endif %}>Record Payment or Refund</button>
        </div>
      </td>
    </tr>
    {% endif %}
  </table>
{% endmacro %}

<div class="panel panel-default">
  <div class="panel-heading">
    <h3 class="panel-title">Current Receipt</h3>
  </div>
<div class="panel-body">
{% if receipt %}
  {{ receipt_table(receipt, receipt.all_sorted_items_and_txns) }}
  <button class="btn btn-danger" onClick="fullRefund('{{ receipt.id }}')">Refund and Cancel This {{ model_str|title }}</button>
{% else %}
There are no active receipts for this {{ model_str }}.
{% endif %}
</div>
</div>

{% for other_receipt in other_receipts %}
<div class="panel panel-default">
  <div class="panel-heading">
    <h3 class="panel-title">{{ other_receipt.owner_model }} Receipt</h3>
  </div>
<div class="panel-body">
  {{ receipt_table(other_receipt, other_receipt.all_sorted_items_and_txns) }}
</div>
</div>
{% endfor %}

{% for closed_receipt in closed_receipts %}
<div class="panel panel-default">
  <div class="panel-heading">
    <h3 class="panel-title">Closed Receipt ({{ closed_receipt.closed|datetime_local }})</h3>
  </div>
<div class="panel-body">
  {{ receipt_table(closed_receipt, closed_receipt.all_sorted_items_and_txns) }}
</div>
</div>
{% endfor %}

{% endblock %}