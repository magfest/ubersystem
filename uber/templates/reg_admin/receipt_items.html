{% extends "base.html" %}{% set admin_area=True %}

{% if art_show_app %}
  {% set model_str = "application" %}
  {% set model = art_show_app %}
{% elif group %}
  {% set model_str = "group" %}
  {% set model = group %}
{% else %}
  {% set model_str = "attendee" %}
  {% set model = attendee %}
{% endif %}

{% block title %}Receipt Items - {% if model.attendee %}{{ model.attendee.full_name }}'s {{ model_str|title }}{% else %}{{ model.full_name|default(model.name) }}{% endif %}{% endblock %}
{% block content %}
<script type="text/javascript">
  var hideRow = function (id) {
    $('#' + id).hide('slow');
  };
  var updateRow = function (id, selector, text) {
    $('#' + id + selector).html(text);
  };
  var updateTotal = function (text, disable_button=true) {
    $('#receipt_total').html(text);
    $('.record_payment_refund').prop('disabled', disable_button);
  }
  var showForm = function(receiptId, whichForm) {
    $('#' + receiptId + whichForm).removeClass('hidden')
  };
  var hideForm = function(receiptId, whichForm) {
    $('#' + receiptId + whichForm).addClass('hidden')
  };
  var deleteItem = function (itemId) {
    bootbox.confirm({
      title: "Delete Receipt Item?",
      message: "This will permanently remove this receipt item. " +
      "This cannot be undone, and should only be used for receipt items " +
      "that were recorded incorrectly. Are you sure?",
      buttons: {
          confirm: {
              label: 'Delete Receipt Item',
              className: 'btn-danger'
          },
          cancel: {
              label: 'Nevermind',
              className: 'btn-outline-secondary'
          }
      },
      callback: function (result) {
        if(result) {
          $.post('remove_receipt_item', {csrf_token: csrf_token, id: itemId}, function (response) {
            toastr.clear();
            if (response.error) {
              toastr.error(response.error);
            } else {
              toastr.info('Item deleted');
              hideRow(response.removed);
              updateTotal(response.new_total, response.disable_button);
            }
          }, 'json');
        }
      }
    });
  };

  var undoItem = function (itemId) {
    bootbox.confirm({
      title: "Undo Receipt Item?",
      message: "This will revert this change to this {{ model_str }}'s registration. Are you sure?",
      buttons: {
          confirm: {
              label: 'Undo',
              className: 'btn-danger'
          },
          cancel: {
              label: 'Nevermind',
              className: 'btn-outline-secondary'
          }
      },
      callback: function (result) {
        if(result) {
          $.post('undo_receipt_item', {csrf_token: csrf_token, id: itemId}, function (response) {
            toastr.clear();
            if (response.error) {
              toastr.error(response.error);
            } else {
              window.location = 'receipt_items?id={{ model.id }}&message=Receipt item reverted'
            }
          }, 'json');
        }
      }
    });
  };

  var cancelTxn = function (txnId) {
    bootbox.confirm({
      title: "Cancel Transaction?",
      message: "This will permanently mark this transaction as cancelled. " +
        "This cannot be undone, and should only be used for payments that " +
        "were recorded incorrectly or that you are sure did not go through. " +
        "Are you sure?",
      buttons: {
          confirm: {
              label: 'Mark Transaction as Cancelled',
              className: 'btn-danger'
          },
          cancel: {
              label: 'Nevermind',
              className: 'btn-outline-secondary'
          }
      },
      callback: function (result) {
        if(result) {
          $.post('cancel_receipt_txn', {csrf_token: csrf_token, id: txnId}, function (response) {
            toastr.clear();
            if (response.error) {
              toastr.error(response.error);
            } else {
              toastr.info('Transaction cancelled');
              updateRow(response.cancelled, ' td:last', "<em>Cancelled " + response.time + ".</em>");
              updateTotal(response.new_total, response.disable_button);
            }
          }, 'json');
        }
      }
    });
  };

  var refundTxn = function (txnId, amount) {
    var refundPrompt = bootbox.prompt({
      title: "Refund Transaction?",
      message: "This will refund the attendee through Stripe. " +
        "This cannot be undone. Are you sure?",
      placeholder: amount,
      buttons: {
          confirm: {
              label: 'Refund',
              className: 'btn-danger'
          },
          cancel: {
              label: 'Nevermind',
              className: 'btn-outline-secondary'
          }
      },
      callback: function (result) {
        if(result) {
          $.post('refund_receipt_txn', {csrf_token: csrf_token, id: txnId, amount: result}, function (response) {
            toastr.clear();
            if (response.error) {
              toastr.error(response.error);
            } else {
              toastr.info('Transaction refunded');
              updateRow(response.refunded, ' td:last #amt-refunded', " ($" + (response.refund_total / 100).toFixed(2) + " refunded)");
              updateTotal(response.new_total, response.disable_button);
            }
          }, 'json');
        }
      }
    });
    refundPrompt.init(function(){
      $(this).find('.bootbox-form').prepend('<p>This will refund the attendee through Stripe. You can enter an amount below or leave it blank to refund the full amount.</p>')
      $(this).find('.bootbox-input-text')
    });
  };

  var addPayment = function ($form, $btn) {
    $.post('add_receipt_txn', $form.serialize(), function(result) {
      $btn.prop('disabled', false);
      toastr.clear();
      if (result.error) {
        toastr.error(result.error);
      } else if (result.success) {
        window.location = 'receipt_items?id={{ model.id }}&message=Receipt item added'
      }
    });
  };

  var fullRefund = function (receiptId) {
    bootbox.confirm({
      title: "Refund and Cancel Registration?",
      message: "This will refund ALL existing Stripe transactions that have not already been refunded. " +
               "It will also cancel this {{ model_str }}'s registration. Are you sure?",
      buttons: {
          confirm: {
              label: 'Fully Refund and Cancel',
              className: 'btn-danger'
          },
          cancel: {
              label: 'Nevermind',
              className: 'btn-outline-secondary'
          }
      },
      callback: function (result) {
        if(result) {
          window.location = 'process_full_refund?id=' + receiptId +
          {% if attendee %}
          '&attendee_id={{ attendee.id }}'
          {% else %}
          '&group_id={{ group.id }}'
          {% endif %}
        }
      }
    });
  };

  $().ready(function () {
    $("form[action='add_receipt_item']").submit(function(event){
      var $form = $(this);
      $btn = $form.find('button[type=submit]');
      event.preventDefault();
      $btn.prop('disabled', true);
      $.post('add_receipt_item', $form.serialize(), function(result) {
        toastr.clear();
        $btn.prop('disabled', false);
        if (result.error) {
          toastr.error(result.error);
        } else if (result.success) {
          window.location = 'receipt_items?id={{ model.id }}&message=Receipt item added'
        }
      });
    });

    $("form[action='add_receipt_txn']").submit(function(event){
      var $form = $(this);
      $btn = $form.find('button[type=submit]');
      event.preventDefault();
      $btn.prop('disabled', true);
      var submitForm = false;
      if (parseInt($("form[action='add_receipt_txn'] input[name='amount']").val()) > 0) {
        bootbox.confirm({
          title: "Add Payment?",
          message: "If you add a payment equal to what the attendee currently owes, " +
            "all open receipt items will be closed and marked as paid. " +
            "This cannot be undone. Are you sure?",
          buttons: {
              confirm: {
                  label: 'Add Payment',
                  className: 'btn-success'
              },
              cancel: {
                  label: 'Nevermind',
                  className: 'btn-outline-secondary'
              }
          },
          callback: function (result) {
            if(result) {
              addPayment($form, $btn);
            } else {
              $btn.prop('disabled', false);
            }
          }
        });
      } else {
        addPayment($form, $btn);
      }
    });
  });
</script>
{% if art_show_app %}
{{ macros.nav_menu(
  art_show_app, c.PAGE_PATH,
  "../art_show_admin/form?id={id}", "App Form", True,
  "../art_show_admin/pieces?id={id}", "Submitted Pieces", True,
  "receipt_items?id={id}", "Receipt Items", c.HAS_REG_ADMIN_ACCESS,
  "../art_show_admin/history?id={id}", "History", True,
  "../art_show_admin/index", "Return to App List", True
  ) }}

{% else %}
  {% include "registration/menu.html" if attendee else "group_admin/nav_menu.html" %}
{% endif %}

<h2>Receipt{% if other_receipts %}s{% endif %} for {% if model.attendee %}{{ model.attendee.full_name }}'s {{ model_str|title }}{% else %}{{ model.full_name|default(model.name) }}{% endif %}{% if c.AT_THE_CON and model.badge_num %} ({{ model.badge }}){% endif %}</h2>
  <div class="card-body">
  <p>Use this form to remove and add custom purchases and credits or non-Stripe payments and refunds for this {{ model_str }}.
    You will not be able to remove purchases or credits that were created before a successful payment was made.
    Confirmed Stripe payments or refunds that have a Stripe ID will also be locked.
  </p>
  
  <p>
    If a payment was made and confirmed through Stripe, you can refund part or all of it using the "Refund Transaction" button.
    Note that some Stripe payments may appear on multiple receipts, for example, when someone registers multiple badges in one transaction.
  </p>

  <p>
    Please always itemize purchases and credits. Items with the same price, and <em>only</em> items with the same price,
    may be grouped into one purchase by setting the Amount as the per-item price and the Quantity field to how many items were purchased.
  </p>
  </div>

{% macro receipt_item_form(type="purchase") %}
<tr id="{{ receipt.id }}-{{ type }}-form" class="hidden">
  <td colspan="7">
    <button type="button" class="close pull-left" aria-label="Close" onClick="hideForm('{{ receipt.id }}', '-{{ type }}-form')"><span aria-hidden="true">&times;</span></button>
    <form method="post" action="add_receipt_item" class="form-inline pull-right">
      {{ csrf_token() }}
      <input type="hidden" name="id" value="{{ receipt.id }}" />
      <input type="hidden" name="item_type" value="{{ type }}" />
      <div class="form-group">
        <label for="desc">Description</label>
        <input type="text" name="desc" class="form-control" placeholder="{{ type|title }} Description" required>
      </div>
      <div class="form-group">
        <label for="amount">Amount</label>
        <div class="input-group">
          <span class="input-group-addon">$</span>
          <input type="number" name="amount" class="form-control" placeholder="0" required>
          <span class="input-group-addon">.00</span>
        </div>
      </div>
      <div class="form-group">
        <label for="count">Quantity</label>
          <input type="number" name="count" class="form-control" placeholder="1">
      </div>
      <button type="submit" class="btn {{ 'btn-primary' if type == 'purchase' else 'btn-success' }}">Add {{ type|title }}</button>
    </form>
  </td>
</tr>
{% endmacro %}
{% macro receipt_txn_form(type="payment") %}
<tr id="{{ receipt.id }}-{{ type }}-form" class="hidden">
  <td colspan="7">
    <button type="button" class="close pull-left" aria-label="Close" onClick="hideForm('{{ receipt.id }}', '-{{ type }}-form')"><span aria-hidden="true">&times;</span></button>
    <form method="post" action="add_receipt_txn" class="form-inline pull-right">
      {{ csrf_token() }}
      <input type="hidden" name="id" value="{{ receipt.id }}" />
      <input type="hidden" name="txn_type" value="{{ type }}" />
      <div class="form-group">
        <label for="amount">{{ type|title }} Method</label>
        <select name="method" class="form-control">
          <option value="">Select a Method</option>
          {{ options(c.PAYMENT_METHOD_OPTS, c.CASH) }}
        </select>
      </div>
      <div class="form-group">
        <label for="count">Amount</label>
        <div class="input-group">
          <span class="input-group-addon">$</span>
          <input type="number" name="amount" class="form-control" placeholder="0" required>
          <span class="input-group-addon">.00</span>
        </div>
      </div>
      <div class="form-group">
        <label for="desc">Description</label>
        <input type="text" name="desc" class="form-control" placeholder="Transaction Description">
      </div>
      <button type="submit" class="btn {{ 'btn-info' if type == 'payment' else 'btn-warning' }}">Add {{ type|title }}</button>
    </form>
  </td>
</tr>
  {% endmacro %}

{% macro receipt_table(receipt, items) %}
<ul class="nav nav-tabs" role="tablist">
  <li role="presentation" class="active"><a href="#{{ receipt.id }}-home" aria-controls="{{ receipt.id }}-home" role="tab" data-toggle="tab">Receipt</a></li>
  <li role="presentation"><a href="#{{ receipt.id }}-history" aria-controls="{{ receipt.id }}-history" role="tab" data-toggle="tab">History</a></li>
</ul>
<div class="tab-content">
  <div role="tabpanel" class="tab-pane active" id="{{ receipt.id }}-home">
  <table class="table table-striped">
    <thead><tr>
      <th>Added</th>
      <th>Admin</th>
      <th>Type</th>
      <th>Description</th>
      <th>Amount</th>
      <th></th>
    </tr></thead>
    {% for item in items %}
    {% set amount_left = item.amount - item.refunded if item.refunded else item.amount %}
      <tr id="{{ item.id }}">
        <td>{{ item.added|datetime_local("%b %-d %-H:%M (%-I:%M%p)") }}</td>
        <td>{{ item.who }}</td>
        <td>
          {% if item.method %}
            {{ "Payment" if item.amount > 0 else "Refund" }} ({{ item.method_label }})
          {% else %}
            {{ "Purchase" if item.amount > 0 else "Credit" }}
          {% endif %}
        </td>
        <td>{{ item.desc }}{{ " (Stripe ID: " ~ item.stripe_id ~ ")" if item.stripe_id else "" }}</td>
        <td>
          {{ (item.amount / 100)|format_currency(true) }}
          {% if item.count and item.count > 1 %}
             x{{ item.count }}: {{ (item.count * item.amount / 100)|format_currency }}
          {% endif %}
          </td>
        <td>
          {% if item.cancelled %}
            <em>Cancelled {{ item.cancelled|datetime_local }}</em>
          {% elif item.closed %}
            {% if item.revert_change and not receipt.closed %}
              <button class="btn btn-sm btn-danger" onClick="undoItem('{{ item.id }}', '{{ receipt.id }}')">Undo Item</button>
            {% else %}
              <em>Payment finalized {{ item.closed|datetime_local }}</em>
            {% endif %}
          {% elif item.is_pending_charge or not item.stripe_id %}
            {% if item.intent_id and not item.refund_id and not receipt.closed %}
              <button class="btn btn-sm btn-danger" onClick="cancelTxn('{{ item.id }}')">Mark as Cancelled</button>
            {# This should be updated when we associate receipt txns with items directly #}
            {% elif item.method and not receipt.open_receipt_items|selectattr("added", "<", item.added)|list|length and receipt.current_receipt_amount == 0 %}
              <em>Payment locked.</em>
            {% elif not receipt.closed %}
              {% if item.revert_change %}
                <button class="btn btn-sm btn-danger" onClick="undoItem('{{ item.id }}', '{{ receipt.id }}')">Undo Item</button>
              {% endif %}
              <button class="btn btn-sm btn-danger" onClick="deleteItem('{{ item.id }}')">
                Delete {{ "Transaction" if item.method else "Item" }}
              </button>
            {% endif %}
          {% elif item.charge_id and amount_left and not receipt.closed %}
            <button class="btn btn-sm btn-warning" onClick="refundTxn('{{ item.id }}', '{{ (amount_left / 100)|format_currency }}')">Refund Transaction</button>
            <span id="amt-refunded">{% if item.refunded %} ({{ (item.refunded / 100)|format_currency }} refunded){% endif %}</span>
          {% endif %}
        </td>
      </tr>
    {% endfor %}
    <tr>
      <td colspan="7">
        <span class="pull-right"><strong>Total</strong>: <span id="receipt_total">{{ receipt.total_str }}</span></span>
      </td>
    </tr>
    {{ receipt_item_form(type="purchase") }}
    {{ receipt_item_form(type="credit") }}
    {{ receipt_txn_form(type="payment") }}
    {{ receipt_txn_form(type="refund") }}
    {% if not receipt.closed %}
    <tr id="{{ receipt.id }}">
      <td colspan="7">
        <div class="btn-group pull-right" role="group">
          <button class="btn btn-outline-secondary">Add:</button>
          <button class="btn btn-primary" onClick="showForm('{{ receipt.id }}', '-purchase-form')">Purchase</button>
          <button class="btn btn-success" onClick="showForm('{{ receipt.id }}', '-credit-form')">Credit</button>
          <button class="btn btn-info record_payment_refund" onClick="showForm('{{ receipt.id }}', '-payment-form')"{% if receipt.current_receipt_amount == 0 %} disabled{% endif %}>Payment</button>
          <button class="btn btn-warning record_payment_refund" onClick="showForm('{{ receipt.id }}', '-refund-form')"{% if receipt.current_receipt_amount == 0 %} disabled{% endif %}>Refund</button>
        </div>
      </td>
    </tr>
    {% endif %}
  </table>
</div>
<div role="tabpanel" class="tab-pane" id="{{ receipt.id }}-history">
  <table class="table-striped table-bordered table-condensed">
    <thead><tr>
      <th>Which</th>
      <th>What</th>
      <th>When</th>
      <th>Who</th>
      <th>Changes</th>
    </tr></thead>
    {% for tracked in receipt.changes %}
      <tr>
        <td valign="top" style="white-space:nowrap">{{ tracked.model }}</td>
        <td valign="top" style="white-space:nowrap">{{ tracked.action_label }}</td>
        <td valign="top" style="white-space:nowrap">{{ tracked.when|full_datetime_local }}</td>
        <td valign="top" style="white-space:nowrap">{{ tracked.who }}</td>
        <td valign="top">{{ tracked.data }}</td>
      </tr>
    {% endfor %}
  </table>
</div>
</div>
{% endmacro %}

<div class="card">
  <div class="card-header">
    <h3 class="card-title">Current Receipt</h3>
  </div>
<div class="card-body">
{% if receipt %}
  {{ receipt_table(receipt, receipt.all_sorted_items_and_txns) }}
  <button class="btn btn-danger" onClick="fullRefund('{{ receipt.id }}')">Refund and Cancel This {{ model_str|title }}</button>
{% else %}
There are no active receipts for this {{ model_str }}.
<br/><a href="create_receipt?id={{ model.id }}" class="btn btn-success">Create Default Receipt</a> <a href="create_receipt?id={{ model.id }}&blank=true" class="btn btn-info">Create Blank Receipt</a>
{% endif %}
</div>
</div>

{% for other_receipt in other_receipts %}
<div class="card">
  <div class="card-header">
    <h3 class="card-title">{{ other_receipt.owner_model }} Receipt</h3>
  </div>
<div class="card-body">
  {{ receipt_table(other_receipt, other_receipt.all_sorted_items_and_txns) }}
</div>
</div>
{% endfor %}

{% for closed_receipt in closed_receipts %}
<div class="card">
  <div class="card-header">
    <h3 class="card-title">Closed Receipt ({{ closed_receipt.closed|datetime_local }})</h3>
  </div>
<div class="card-body">
  {{ receipt_table(closed_receipt, closed_receipt.all_sorted_items_and_txns) }}
</div>
</div>
{% endfor %}

{% endblock %}